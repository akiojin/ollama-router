# Test: Auto Merge Workflow
# æ©Ÿèƒ½ID: SPEC-47c6f44c
# ç›®çš„: auto-merge.ymlã®å‹•ä½œã‚’ãƒ†ã‚¹ãƒˆï¼ˆTDD - REDï¼‰
# ã“ã®ãƒ†ã‚¹ãƒˆã¯å®Ÿè£…å‰ãªã®ã§å¤±æ•—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

name: Test Auto Merge

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
  push:
    branches: [test/**]

jobs:
  test-workflow-exists:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if auto-merge.yml exists
        run: |
          if [ ! -f .github/workflows/auto-merge.yml ]; then
            echo "âŒ ERROR: auto-merge.yml does not exist"
            echo "Expected: .github/workflows/auto-merge.yml"
            exit 1
          fi
          echo "âœ… auto-merge.yml exists"

  test-workflow-structure:
    runs-on: ubuntu-latest
    needs: test-workflow-exists
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify workflow name
        run: |
          WORKFLOW_NAME=$(grep -A 1 "^name:" .github/workflows/auto-merge.yml | tail -1 | sed 's/name: //' | tr -d '"')
          if [ "$WORKFLOW_NAME" != "Auto Merge" ]; then
            echo "âŒ ERROR: Workflow name is not 'Auto Merge'"
            echo "Expected: 'Auto Merge'"
            echo "Actual: '$WORKFLOW_NAME'"
            exit 1
          fi
          echo "âœ… Workflow name is correct"

      - name: Verify pull_request_target trigger
        run: |
          if ! grep -q "pull_request_target:" .github/workflows/auto-merge.yml; then
            echo "âŒ ERROR: pull_request_target trigger not found"
            exit 1
          fi
          echo "âœ… pull_request_target trigger found"

          REQUIRED_TYPES=(opened reopened ready_for_review synchronize)
          for type in "${REQUIRED_TYPES[@]}"; do
            if ! grep -A 5 "pull_request_target:" .github/workflows/auto-merge.yml | grep -q "- $type"; then
              echo "âŒ ERROR: pull_request_target.types missing '$type'"
              exit 1
            fi
          done
          echo "âœ… Required pull_request_target types found"

      - name: Verify required permissions
        run: |
          if ! grep -q "contents: read" .github/workflows/auto-merge.yml; then
            echo "âŒ ERROR: 'contents: read' permission not found"
            exit 1
          fi
          echo "âœ… 'contents: read' permission found"

          if ! grep -q "pull-requests: write" .github/workflows/auto-merge.yml; then
            echo "âŒ ERROR: 'pull-requests: write' permission not found"
            exit 1
          fi
          echo "âœ… 'pull-requests: write' permission found"

  test-expected-failure:
    runs-on: ubuntu-latest
    steps:
      - name: This test should fail (RED phase)
        run: |
          echo "ğŸ”´ RED Phase: This test is expected to FAIL"
          echo "Reason: auto-merge.yml has not been implemented yet"
          echo ""
          echo "Next step: Implement auto-merge.yml (T007) to make this test PASS (GREEN)"

          # Intentional failure for TDD RED phase
          exit 1
