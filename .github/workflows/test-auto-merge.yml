# Test: Auto Merge Workflow
# æ©Ÿèƒ½ID: SPEC-47c6f44c
# ç›®çš„: auto-merge.ymlã®å‹•ä½œã‚’ãƒ†ã‚¹ãƒˆï¼ˆTDD - REDï¼‰
# ã“ã®ãƒ†ã‚¹ãƒˆã¯å®Ÿè£…å‰ãªã®ã§å¤±æ•—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

name: Test Auto Merge

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
  push:
    branches: [test/**]

jobs:
  test-workflow-exists:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if auto-merge.yml exists
        run: |
          if [ ! -f .github/workflows/auto-merge.yml ]; then
            echo "âŒ ERROR: auto-merge.yml does not exist"
            echo "Expected: .github/workflows/auto-merge.yml"
            exit 1
          fi
          echo "âœ… auto-merge.yml exists"

  test-workflow-structure:
    runs-on: ubuntu-latest
    needs: test-workflow-exists
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify workflow name
        run: |
          WORKFLOW_NAME=$(grep "^name:" .github/workflows/auto-merge.yml | head -1 | cut -d':' -f2- | xargs)
          if [ "$WORKFLOW_NAME" != "Auto Merge PR" ]; then
            echo "âŒ ERROR: Workflow name is not 'Auto Merge PR'"
            echo "Expected: 'Auto Merge PR'"
            echo "Actual: '$WORKFLOW_NAME'"
            exit 1
          fi
          echo "âœ… Workflow name is correct"

      - name: Verify pull_request trigger and branches
        run: |
          if ! grep -q "^  pull_request:" .github/workflows/auto-merge.yml; then
            echo "âŒ ERROR: pull_request trigger not found"
            exit 1
          fi
          echo "âœ… pull_request trigger found"

          if ! grep -q "types: \\[opened, synchronize, reopened, ready_for_review\\]" .github/workflows/auto-merge.yml; then
            echo "âŒ ERROR: pull_request types do not match expected list"
            exit 1
          fi
          echo "âœ… pull_request types are correct"

          for branch in main develop; do
            if ! grep -q "      - $branch" .github/workflows/auto-merge.yml; then
              echo "âŒ ERROR: Branch '$branch' not included in auto-merge trigger"
              exit 1
            fi
            echo "âœ… Branch '$branch' found"
          done

      - name: Verify required permissions and draft handling
        run: |
          if ! grep -q "contents: write" .github/workflows/auto-merge.yml; then
            echo "âŒ ERROR: 'contents: write' permission not found"
            exit 1
          fi
          echo "âœ… 'contents: write' permission found"

          if ! grep -q "pull-requests: write" .github/workflows/auto-merge.yml; then
            echo "âŒ ERROR: 'pull-requests: write' permission not found"
            exit 1
          fi
          echo "âœ… 'pull-requests: write' permission found"

          if grep -q "if: github.event.pull_request.draft == false" .github/workflows/auto-merge.yml; then
            echo "âŒ ERROR: Job-level draft guard should not exist"
            exit 1
          fi
          echo "âœ… Job-level draft guard removed"

          if ! grep -q "github.event.pull_request.draft" .github/workflows/auto-merge.yml; then
            echo "âŒ ERROR: Inline draft handling not found in auto-merge step"
            exit 1
          fi
          echo "âœ… Inline draft handling is present"

      - name: Verify auto-merge command
        run: |
          if ! rg -q "GH_TOKEN:.*secrets\.PAT" .github/workflows/auto-merge.yml; then
            echo "âŒ ERROR: GH_TOKEN assignment is not restricted to secrets.PAT"
            exit 1
          fi
          echo "âœ… GH_TOKEN uses secrets.PAT"

          if ! grep -q "Required secret PAT is not configured" .github/workflows/auto-merge.yml; then
            echo "âŒ ERROR: PAT presence check not found"
            exit 1
          fi
          echo "âœ… PAT presence check is present"

          if ! grep -q "gh pr merge --auto --merge" .github/workflows/auto-merge.yml; then
            echo "âŒ ERROR: gh pr merge command not found"
            exit 1
          fi
          echo "âœ… gh pr merge command is present"

  test-expected-failure:
    runs-on: ubuntu-latest
    steps:
      - name: This test should fail (RED phase)
        run: |
          echo "ğŸ”´ RED Phase: This test is expected to FAIL"
          echo "Reason: Placeholder RED check remains until a passing GREEN suite replaces it"
          echo ""
          echo "Next step: Replace this placeholder with assertions that exercise the deployed workflow"

          # Intentional failure for TDD RED phase
          exit 1
