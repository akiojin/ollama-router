# Publish Workflow
# 由来: release-binaries.yml + claude-worktree/publish.yml統合
# 目的: mainへのpush時にバイナリをビルド・公開し、developへbackmerge
# トリガー: main push (chore(release): コミット) または手動実行

name: Publish

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to publish (override detected tag)"
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  build-binaries:
    name: Build ${{ matrix.artifact }}
    runs-on: ${{ matrix.os }}
    env:
      RELEASE_TAG: ${{ github.event.inputs.release_tag || github.ref_name }}
      RELEASE_VERSION: ${{ (github.event.inputs.release_tag != '' && github.event.inputs.release_tag) || github.ref_name }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: linux-x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: windows-x86_64
          - os: macos-15-intel
            target: x86_64-apple-darwin
            artifact: macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: macos-arm64
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Derive release version (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          ver="${RELEASE_TAG#v}"
          echo "RELEASE_VERSION=$ver" >> $GITHUB_ENV

      - name: Derive release version (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ver = ($env:RELEASE_TAG.TrimStart('v'))
          \"RELEASE_VERSION=$ver\" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Configure macOS toolchain
        if: matrix.target == 'aarch64-apple-darwin'
        shell: bash
        run: |
          echo "CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER=clang" >> $GITHUB_ENV
          echo "CC_aarch64_apple_darwin=clang" >> $GITHUB_ENV
          echo "CXX_aarch64_apple_darwin=clang++" >> $GITHUB_ENV

      - name: Configure macOS toolchain (x86_64)
        if: matrix.target == 'x86_64-apple-darwin'
        shell: bash
        run: |
          echo "CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER=clang" >> $GITHUB_ENV
          echo "CC_x86_64_apple_darwin=clang" >> $GITHUB_ENV
          echo "CXX_x86_64_apple_darwin=clang++" >> $GITHUB_ENV

      - name: Build release binaries
        run: cargo build --release --target ${{ matrix.target }} -p or-router -p or-node

      - name: Install WiX Toolset
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install wixtoolset --version 3.11.2 -y --allow-downgrade --force

      - name: Package binaries (Unix)
        if: runner.os != 'Windows'
        id: package_unix
        shell: bash
        run: |
          set -euo pipefail
          archive="ollama-router-${{ matrix.artifact }}.tar.gz"
          staging="dist/ollama-router-${{ matrix.artifact }}"
          mkdir -p "$staging"
          cp "target/${{ matrix.target }}/release/or-router" "$staging/"
          cp "target/${{ matrix.target }}/release/or-node" "$staging/"
          cp README.md README.ja.md LICENSE "$staging/"
          tar czf "$archive" -C dist "$(basename "$staging")"
          echo "archive=$archive" >> "$GITHUB_OUTPUT"

      - name: Validate archive contents (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -uo pipefail
          archive="${{ steps.package_unix.outputs.archive }}"
          [[ "$archive" == ollama-router-* ]] || { echo "::error::unexpected archive name $archive"; exit 1; }
          [[ "$archive" == *.tar.gz ]] || { echo "::error::expected .tar.gz archive"; exit 1; }
          set +o pipefail
          root_dir=$(tar -tzf "$archive" 2>&1 | head -1 | cut -d/ -f1)
          set -o pipefail
          [[ -n "$root_dir" ]] || { echo "::error::failed to detect root directory"; exit 1; }
          tar -tzf "$archive" > contents.txt 2>&1
          grep -q "^${root_dir}/or-router\$" contents.txt || { echo "::error::or-router not found"; exit 1; }
          grep -q "^${root_dir}/or-node\$" contents.txt || { echo "::error::or-node not found"; exit 1; }
          grep -q "^${root_dir}/README.md\$" contents.txt || { echo "::error::README.md not found"; exit 1; }
          grep -q "^${root_dir}/README.ja.md\$" contents.txt || { echo "::error::README.ja.md not found"; exit 1; }
          grep -q "^${root_dir}/LICENSE\$" contents.txt || { echo "::error::LICENSE not found"; exit 1; }
          rm contents.txt

      - name: Package binaries (Windows)
        if: runner.os == 'Windows'
        id: package_windows
        shell: pwsh
        run: |
          $archive = "ollama-router-${{ matrix.artifact }}.zip"
          $staging = Join-Path "dist" "ollama-router-${{ matrix.artifact }}"
          New-Item -ItemType Directory -Path $staging -Force | Out-Null
          Copy-Item "target/${{ matrix.target }}/release/or-router.exe" $staging
          Copy-Item "target/${{ matrix.target }}/release/or-node.exe" $staging
          Copy-Item README.md,README.ja.md,LICENSE $staging
          Compress-Archive -Path (Join-Path $staging '*') -DestinationPath $archive -Force
          "archive=$archive" >> $env:GITHUB_OUTPUT

      - name: Validate archive contents (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $archive = "${{ steps.package_windows.outputs.archive }}"
          if (-not ($archive -like "ollama-router-*")) {
            Write-Error "unexpected archive name $archive"
            exit 1
          }
          if (-not ($archive.EndsWith(".zip"))) {
            Write-Error "expected .zip archive"
            exit 1
          }
          $extractDir = Join-Path $PWD "validate"
          if (Test-Path $extractDir) {
            Remove-Item $extractDir -Recurse -Force
          }
          Expand-Archive -Path $archive -DestinationPath $extractDir -Force
          $files = Get-ChildItem -Path $extractDir -File -Recurse
          $binaryPrefixes = @("or-router","or-node")
          foreach ($prefix in $binaryPrefixes) {
            if (-not ($files.Name | Where-Object { $_ -like "$prefix*.exe" })) {
              Write-Error "missing executable matching $prefix*.exe in archive"
              exit 1
            }
          }
          $staticFiles = @("README.md","README.ja.md","LICENSE")
          foreach ($name in $staticFiles) {
            if (-not ($files.Name -contains $name)) {
              Write-Error "missing $name in archive"
              exit 1
            }
          }
          Remove-Item $extractDir -Recurse -Force

      - name: Build macOS installers (.pkg)
        if: matrix.target == 'x86_64-apple-darwin' || matrix.target == 'aarch64-apple-darwin'
        id: package_macos_installers
        shell: bash
        run: |
          set -euo pipefail
          version="${RELEASE_VERSION}"
          if [[ -z "$version" ]]; then
            echo "::error::Release version is not available."
            exit 1
          fi
          pkg_root_router="$(pwd)/pkgroot-router"
          install_dir_router="$pkg_root_router/usr/local/bin"
          mkdir -p "$install_dir_router"
          install -m 0755 "target/${{ matrix.target }}/release/or-router" "$install_dir_router/"
          pkg_router="or-router-${{ matrix.artifact }}.pkg"
          pkgbuild \
            --root "$pkg_root_router" \
            --identifier "io.ollama.router" \
            --version "$version" \
            --install-location "/" \
            "$pkg_router"
          rm -rf "$pkg_root_router"
          pkg_root_node="$(pwd)/pkgroot-node"
          install_dir_node="$pkg_root_node/usr/local/bin"
          mkdir -p "$install_dir_node"
          install -m 0755 "target/${{ matrix.target }}/release/or-node" "$install_dir_node/"
          pkg_node="or-node-${{ matrix.artifact }}.pkg"
          pkgbuild \
            --root "$pkg_root_node" \
            --identifier "io.ollama.router.agent" \
            --version "$version" \
            --install-location "/" \
            "$pkg_node"
          rm -rf "$pkg_root_node"
          echo "router_pkg=$pkg_router" >> "$GITHUB_OUTPUT"
          echo "node_pkg=$pkg_node" >> "$GITHUB_OUTPUT"

      - name: Build Windows installers (.msi)
        if: runner.os == 'Windows'
        id: package_windows_installers
        shell: pwsh
        run: |
          $version = "${env:RELEASE_VERSION}"
          if ([string]::IsNullOrEmpty($version)) {
            Write-Error "Release version is not available."
            exit 1
          }
          $binaryDir = Join-Path $PWD "target/${{ matrix.target }}/release"
          $routerWxs = Join-Path $PWD "installers/windows/ollama-router.wxs"
          $nodeWxs = Join-Path $PWD "installers/windows/ollama-router-node.wxs"
          $routerObj = "ollama-router.wixobj"
          $nodeObj = "ollama-router-node.wixobj"
          $routerMsi = "or-router-${{ matrix.artifact }}.msi"
          $nodeMsi = "or-node-${{ matrix.artifact }}.msi"
          $wixPath = "${env:ProgramFiles(x86)}\WiX Toolset v3.11\bin"
          $env:PATH = "$wixPath;$env:PATH"
          candle.exe $routerWxs -out $routerObj -dBinariesDir="$binaryDir" -dProductVersion="$version"
          light.exe $routerObj -out $routerMsi -sice:ICE03
          candle.exe $nodeWxs -out $nodeObj -dBinariesDir="$binaryDir" -dProductVersion="$version"
          light.exe $nodeObj -out $nodeMsi -sice:ICE03
          "router_msi=$routerMsi" >> $env:GITHUB_OUTPUT
          "node_msi=$nodeMsi" >> $env:GITHUB_OUTPUT

      - name: Upload release artifact (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ steps.package_unix.outputs.archive }}
          if-no-files-found: error

      - name: Upload release artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ steps.package_windows.outputs.archive }}
          if-no-files-found: error

      - name: Upload macOS router installer
        if: (matrix.target == 'x86_64-apple-darwin' || matrix.target == 'aarch64-apple-darwin') && steps.package_macos_installers.outputs.router_pkg != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}-router-pkg
          path: ${{ steps.package_macos_installers.outputs.router_pkg }}
          if-no-files-found: error

      - name: Upload macOS agent installer
        if: (matrix.target == 'x86_64-apple-darwin' || matrix.target == 'aarch64-apple-darwin') && steps.package_macos_installers.outputs.node_pkg != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}-node-pkg
          path: ${{ steps.package_macos_installers.outputs.node_pkg }}
          if-no-files-found: error

      - name: Upload Windows router installer
        if: runner.os == 'Windows' && steps.package_windows_installers.outputs.router_msi != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}-router-msi
          path: ${{ steps.package_windows_installers.outputs.router_msi }}
          if-no-files-found: error

      - name: Upload Windows agent installer
        if: runner.os == 'Windows' && steps.package_windows_installers.outputs.node_msi != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}-node-msi
          path: ${{ steps.package_windows_installers.outputs.node_msi }}
          if-no-files-found: error

  publish-binaries:
    name: Attach binaries to GitHub Release
    needs: [build-binaries]
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          merge-multiple: true

      - name: List downloaded assets
        run: ls -R release

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_tag || github.ref_name }}
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  backmerge-develop:
    name: Backmerge main -> develop
    needs: publish-binaries
    runs-on: ubuntu-latest
    if: ${{ github.ref_type == 'tag' }}
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Merge main into develop
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git merge --no-ff origin/main -m "chore(release): sync main into develop"
          git push origin develop
