name: release-binaries

on:
  workflow_call:
    inputs:
      target_branch:
        type: string
        default: main
      release_tag:
        type: string
        default: ""
  workflow_dispatch:
    inputs:
      target_branch:
        description: Branch to build binaries from
        required: true
        default: main

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.artifact }}
    runs-on: ${{ matrix.os }}
    env:
      # workflow_call supplies inputs.target_branch, workflow_dispatch writes to github.event.inputs;
      # default to main when neither is provided.
      TARGET_BRANCH: ${{ inputs.target_branch || github.event.inputs.target_branch || 'main' }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: linux-x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: windows-x86_64
          - os: macos-13
            target: x86_64-apple-darwin
            artifact: macos-x86_64
          - os: macos-14
            target: aarch64-apple-darwin
            artifact: macos-arm64
    steps:
      - name: Ensure main branch release
        shell: bash
        run: |
          if [[ "${TARGET_BRANCH}" != "main" ]]; then
            echo "::error::Binary packaging is restricted to the protected 'main' branch. Received '${TARGET_BRANCH}'. Merge your changes to main or rerun semantic-release on main to build release assets."
            exit 1
          fi

      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/heads/{0}', env.TARGET_BRANCH) || github.sha }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release binaries
        run: cargo build --release --target ${{ matrix.target }} -p ollama-coordinator-coordinator -p ollama-coordinator-agent

      - name: Package binaries (Unix)
        if: runner.os != 'Windows'
        id: package_unix
        shell: bash
        run: |
          set -euo pipefail
          archive="ollama-coordinator-${{ matrix.artifact }}.tar.gz"
          staging="dist/ollama-coordinator-${{ matrix.artifact }}"
          mkdir -p "$staging"
          cp "target/${{ matrix.target }}/release/ollama-coordinator-coordinator" "$staging/"
          cp "target/${{ matrix.target }}/release/ollama-coordinator-agent" "$staging/"
          cp README.md README.ja.md LICENSE "$staging/"
          tar czf "$archive" -C dist "$(basename "$staging")"
          echo "archive=$archive" >> "$GITHUB_OUTPUT"

      - name: Validate archive contents (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -uo pipefail
          archive="${{ steps.package_unix.outputs.archive }}"
          echo "DEBUG: archive=$archive"
          [[ "$archive" == ollama-coordinator-* ]] || { echo "::error::unexpected archive name $archive"; exit 1; }
          [[ "$archive" == *.tar.gz ]] || { echo "::error::expected .tar.gz archive"; exit 1; }
          echo "DEBUG: Extracting root_dir..."
          set +o pipefail
          root_dir=$(tar -tzf "$archive" 2>&1 | head -1 | cut -d/ -f1)
          set -o pipefail
          echo "DEBUG: root_dir='$root_dir' (length: ${#root_dir})"
          [[ -n "$root_dir" ]] || { echo "::error::failed to detect root directory"; exit 1; }
          echo "DEBUG: Creating contents.txt..."
          tar -tzf "$archive" > contents.txt 2>&1
          tar_exit=$?
          echo "DEBUG: tar exit code: $tar_exit"
          if [[ $tar_exit -ne 0 ]]; then
            echo "::error::tar failed with exit code $tar_exit"
            cat contents.txt
            exit 1
          fi
          echo "DEBUG: Archive contents:"
          cat contents.txt
          echo "DEBUG: Checking files..."
          grep -q "^${root_dir}/ollama-coordinator-coordinator\$" contents.txt || { echo "::error::ollama-coordinator-coordinator not found"; exit 1; }
          grep -q "^${root_dir}/ollama-coordinator-agent\$" contents.txt || { echo "::error::ollama-coordinator-agent not found"; exit 1; }
          grep -q "^${root_dir}/README.md\$" contents.txt || { echo "::error::README.md not found"; exit 1; }
          grep -q "^${root_dir}/README.ja.md\$" contents.txt || { echo "::error::README.ja.md not found"; exit 1; }
          grep -q "^${root_dir}/LICENSE\$" contents.txt || { echo "::error::LICENSE not found"; exit 1; }
          rm contents.txt
          echo "DEBUG: Validation passed"

      - name: Package binaries (Windows)
        if: runner.os == 'Windows'
        id: package_windows
        shell: pwsh
        run: |
          $archive = "ollama-coordinator-${{ matrix.artifact }}.zip"
          $staging = Join-Path "dist" "ollama-coordinator-${{ matrix.artifact }}"
          New-Item -ItemType Directory -Path $staging -Force | Out-Null
          Copy-Item "target/${{ matrix.target }}/release/ollama-coordinator-coordinator.exe" $staging
          Copy-Item "target/${{ matrix.target }}/release/ollama-coordinator-agent.exe" $staging
          Copy-Item README.md,README.ja.md,LICENSE $staging
          Compress-Archive -Path (Join-Path $staging '*') -DestinationPath $archive -Force
          "archive=$archive" >> $env:GITHUB_OUTPUT

      - name: Validate archive contents (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $archive = "${{ steps.package_windows.outputs.archive }}"
          if (-not ($archive -like "ollama-coordinator-*")) {
            Write-Error "unexpected archive name $archive"
            exit 1
          }
          if (-not ($archive.EndsWith(".zip"))) {
            Write-Error "expected .zip archive"
            exit 1
          }
          $extractDir = Join-Path $PWD "validate"
          if (Test-Path $extractDir) {
            Remove-Item $extractDir -Recurse -Force
          }
          Expand-Archive -Path $archive -DestinationPath $extractDir -Force
          $files = Get-ChildItem -Path $extractDir -File -Recurse
          $binaryPrefixes = @("ollama-coordinator-coordinator","ollama-coordinator-agent")
          foreach ($prefix in $binaryPrefixes) {
            if (-not ($files.Name | Where-Object { $_ -like "$prefix*.exe" })) {
              Write-Error "missing executable matching $prefix*.exe in archive"
              exit 1
            }
          }
          $staticFiles = @("README.md","README.ja.md","LICENSE")
          foreach ($name in $staticFiles) {
            if (-not ($files.Name -contains $name)) {
              Write-Error "missing $name in archive"
              exit 1
            }
          }
          Remove-Item $extractDir -Recurse -Force
      - name: Upload release artifact (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ steps.package_unix.outputs.archive }}
          if-no-files-found: error

      - name: Upload release artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ steps.package_windows.outputs.archive }}
          if-no-files-found: error

  publish:
    name: Attach binaries to release
    needs: build
    if: inputs.release_tag != ''
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          merge-multiple: true

      - name: List downloaded assets
        run: ls -R release

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
