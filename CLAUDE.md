# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際のガイダンスを提供します。

## 現在の目的

- `specs/` 配下で定義された要件・タスクの未完了項目を洗い出し、順次完了させることを最優先とする
- 作業中は最新のSpecと整合するようにテスト・ドキュメント・実装を更新し、完了後は必ずチェックリストを更新する

## 開発指針

### 🛠️ 技術実装指針

- **設計・実装は複雑にせずに、シンプルさの極限を追求してください**
- **ただし、ユーザビリティと開発者体験の品質は決して妥協しない**
- 実装はシンプルに、開発者体験は最高品質に
- CLI操作の直感性と効率性を技術的複雑さより優先
- GPU未搭載エージェントは登録させない。API・UI・テストでGPUデバイス情報を必須とする。

### 📝 設計ガイドライン

- 設計に関するドキュメントには、ソースコードを書かないこと

## 開発品質

### 完了条件

- エラーが発生している状態で完了としないこと。必ずエラーが解消された時点で完了とする。

## 開発ワークフロー

### 基本ルール

- 作業（タスク）を完了したら、変更点を日本語でコミットログに追加して、コミット＆プッシュを必ず行う
- コミットメッセージは commitlint (Conventional Commits) に準拠した形式で記述する（例: `feat(core): add new api`）
- 作業（タスク）は、最大限の並列化をして進める
- 作業（タスク）は、最大限の細分化をしてToDoに登録する
- 作業（タスク）の開始前には、必ずToDoを登録した後に作業を開始する
- 作業（タスク）は、忖度なしで進める

### 環境固定ルール（プロジェクトカスタム）

- 勝手にブランチ作成やWorktree作成は禁止（`git branch`, `git worktree add` などを実行しない）
- 作業ディレクトリの変更は禁止（`cd`による移動を行わない）
- 現在のブランチの切り替えは禁止（`git switch`, `git checkout` などを実行しない）
- ブランチやWorktreeの作成・切り替えはリポジトリメンテナが必要時に実施する。作業者は現状の環境を維持してタスクを完了させること。

### ローカル検証（絶対厳守）

GitHub Actions が実行する検証を**全てローカルで事前に成功させてから**コミットすること。例外は認めない。

- 下記コマンド群を現在の作業環境で順番に実行し、すべて成功（終了コード0）を確認すること
  - `cargo fmt --check`
  - `cargo clippy -- -D warnings`
  - `cargo test`
  - `.specify/scripts/checks/check-tasks.sh`
  - `npx markdownlint-cli '**/*.md' --ignore node_modules --ignore .git`
  - コミット対象に応じて `.specify/scripts/checks/check-commits.sh` やその他ワークフロー相当のスクリプト
- いずれかが失敗した状態でコミットすることを固く禁止する。失敗原因を解消し、再実行→合格を確認してからコミットせよ。
- ローカル検証結果を残すため、必要に応じて実行ログをメモし、レビュー時に提示できるようにすること。

### commitlint準拠コミットログ（強制）

- コミットメッセージは必ず Conventional Commits 形式（例: `type(scope): summary`）で記述する。`type` は `feat` / `fix` / `docs` / `test` / `chore` / `refactor` / `ci` / `build` などプロジェクトで許可された識別子のみを使用する。
- `summary` は50文字以内で要点を記載し、語尾に句読点を付けない。必要なら本文に詳細とチケット番号を追記する。
- コミット前に `.specify/scripts/checks/check-commits.sh --from origin/main --to HEAD` を実行し、手元で commitlint を通過させる。スクリプトは `npx commitlint` を呼び出し、違反コミットを明示的に列挙する。
- CI（Quality Checks）でも commitlint が必ず実行される。違反が検出された場合は `git commit --amend` や `git rebase -i` でメッセージを修正し、再度ローカルチェックを合格させてからプッシュする。
- CI・ローカルいずれかで commitlint が失敗した状態でのレビュー依頼やプルリク作成は禁止。

### markdownlint準拠ドキュメント（強制）

- Markdown ファイルは commit 前に `npx markdownlint-cli '**/*.md' --ignore node_modules --ignore .git` を実行して lint を通過させる。対象が限定される場合でもルールに従ったグロブを使用し、必ず全ファイルを検証する。
- 各ドキュメントは MD013（行長）、MD029（リスト番号）、MD041（見出しタイトル）など既定ルールを満たすよう編集する。必要な場合のみ、`.markdownlint.json` で合意された例外設定を追加する。
- lint で検出された警告を放置した状態でのコミット・プッシュは禁止。修正が困難な場合は lint ルール変更の提案を issue に記録し、承認なしでローカル例外を入れない。
- CI の Quality Checks でも markdownlint が実行されるため、ローカルで合格しない限り PR がブロックされる。CLI での改善結果を再チェックし、ゼロ警告を確認してからレビューを依頼する。

### Spec駆動開発ライフサイクル

新機能の開発は、以下の3ステップで進めます：

1. **`/speckit.specify`**: 機能仕様書を作成 (`specs/SPEC-[UUID8桁]/spec.md`)
   - ビジネス要件とユーザーストーリーを定義
   - 「何を」「なぜ」に焦点を当てる（「どのように」は含めない）
   - SPECディレクトリを生成し、仕様を文書化
   - 本リポジトリではfeatureブランチ／Worktreeの自動作成機能は無効化されているため、現在のブランチ・作業ディレクトリのまま進める

2. **`/speckit.plan`**: 実装計画を作成 (`specs/SPEC-[UUID8桁]/plan.md`)
   - 技術スタック、アーキテクチャ、データモデルを設計
   - 憲章チェック（TDD/LLM最適化/シンプルさの原則）
   - Phase 0: 技術リサーチ (`research.md`)
   - Phase 1: 設計とコントラクト (`data-model.md`, `contracts/`, `quickstart.md`)
   - Phase 2: タスク計画 (`tasks.md`)

3. **`/speckit.tasks`**: 実行可能なタスクに分解 (`specs/SPEC-[UUID8桁]/tasks.md`)
   - Setup/Test/Core/Integration/Polishに分類
   - 並列実行可能なタスクに`[P]`マーク付与
   - 依存関係を明確化

#### Spec命名規則

- **形式**: `SPEC-[UUID8桁]`
- **UUID生成**: ランダムな英数字（小文字）8桁
  - ✅ 正しい例: `SPEC-a1b2c3d4`, `SPEC-3f8e9d2a`, `SPEC-7c4b1e5f`
  - ❌ 間違い例: `SPEC-001`, `SPEC-gameobj`, `SPEC-core-001`
- **禁止事項**:
  - 連番の使用（001, 002...）
  - 意味のある名前（gameobj, core, ui...）
  - 大文字の使用（UUID部分は小文字のみ）
- **生成方法**: `uuidgen | tr '[:upper:]' '[:lower:]' | cut -c1-8` またはオンラインUUID生成ツール

#### Worktree＆ブランチ運用（プロジェクトカスタム）

本リポジトリでは GitHub Spec Kit を導入していますが、featureブランチや Worktree を自動的に作成する機能はプロジェクト要件により無効化しています。運用方針は以下のとおりです。

- 現在割り当てられている作業環境（Codex CLI が示すカレントディレクトリ・ブランチ）のみを使用する。
- `git branch`, `git checkout`, `git switch`, `git worktree` など環境を変更するコマンドは実行しない。
- Spec Kit コマンドはドキュメント生成・更新にのみ利用し、Git ブランチや Worktree を変更しない前提で扱う。
- ブランチ／Worktree の新規作成・削除・切り替えが必要になった場合は、必ずメンテナに相談し指示を受ける。
- CI やリポジトリ管理スクリプトが環境を制御しているため、手動での操作は重大な不整合を引き起こす可能性がある。

### TDD遵守（妥協不可）

**絶対遵守事項:**

- **Red-Green-Refactorサイクル必須**:
  1. **RED**: テストを書く → テスト失敗を確認
  2. **GREEN**: 最小限の実装でテスト合格
  3. **REFACTOR**: コードをクリーンアップ

- **禁止事項**:
  - テストなしでの実装
  - REDフェーズのスキップ（テストが失敗することを確認せずに実装）
  - 実装後のテスト作成（テストが実装より後のコミットになる）

- **Git commitの順序**:
  - テストコミットが実装コミットより先に記録される必要がある
  - 例: `feat(test): Fooのテスト追加` → `feat: Foo実装`

- **テストカテゴリと順序**:
  1. Contract tests (統合テスト) → API/インターフェース定義
  2. Integration tests → クリティカルパス100%
  3. E2E tests → 主要ユーザーワークフロー
  4. Unit tests → 個別機能、80%以上のカバレッジ

**詳細は [`memory/constitution.md`](memory/constitution.md) を参照**

### SDD (Spec-Driven Development) 規約

**すべての機能開発・要件追加は `/speckit.specify` から開始**

**新規機能開発フロー**:

1. `/speckit.specify` - ビジネス要件を定義（技術詳細なし）
   - 本リポジトリではfeatureブランチ／Worktree自動生成を停止しているため、現在のブランチと作業ディレクトリのまま仕様ファイルを生成・更新する。
2. `/speckit.plan` - 技術設計を作成（憲章チェック必須）
   - 現在の作業ディレクトリで実行し、Gitの状態を変えない。
3. `/speckit.tasks` - 実行可能タスクに分解
   - 実装実行は `/speckit.implement` で補助的に利用可能
   - 環境を移動せずタスクを細分化する。
4. タスク実行（TDDサイクル厳守）
   - 割り当て済みブランチ上で実装し、コミットを積む。ブランチ操作は禁止。
5. 完了時はメンテナまたはCIが用意した手順に従う。`finish-feature.sh` を含むブランチ／Worktree操作系スクリプトを自己判断で実行しない。

**既存機能のSpec化フロー**:

1. 作業ディレクトリを移動せず、現在の環境で `/speckit.specify` を実行して実装済み機能のビジネス要件を文書化する。
2. `/speckit.plan` で必要に応じて技術設計を追記する。
3. 既存実装とSpecの整合性を確認する。
4. 完了報告やGit操作が必要な場合はメンテナの指示を待つ。自己判断でブランチやWorktreeを操作しない。

**Spec作成原則**:

- ビジネス価値とユーザーストーリーに焦点
- 「何を」「なぜ」のみ記述（「どのように」は禁止）
- 非技術者が理解できる言葉で記述
- テスト可能で曖昧さのない要件

**憲章準拠**:

- すべての実装は [`memory/constitution.md`](memory/constitution.md) に準拠
- TDD、ハンドラーアーキテクチャ、LLM最適化は妥協不可

## コミュニケーションガイドライン

- 回答は必ず日本語

## ドキュメント管理

- ドキュメントはREADME.md/README.ja.mdに集約する

### Assets配下の扱い（サンプル/Unityプロジェクト側）

- 目的: サンプル・検証・デモ・手動動作確認用のシーン/プレハブ/補助スクリプトを配置。
- 禁止: unity-mcp-server 実装本体（ランタイム/エディタ拡張の主要コード）を置かない。UPM配布の対象にも含めない。
- 編集: 必要最小限に留める。C#編集は外部CLIで行い、Assets側は参照/設定のみで成立させる。

## バージョン管理

### npm versionコマンドの使用

バージョンアップは必ず`npm version`コマンドを使用する：

- **パッチバージョン**: `npm version patch` (例: 2.9.0 → 2.9.1)
- **マイナーバージョン**: `npm version minor` (例: 2.9.0 → 2.10.0)
- **メジャーバージョン**: `npm version major` (例: 2.9.0 → 3.0.0)

**重要**: package.jsonを直接編集してのバージョン変更は禁止

## コードクオリティガイドライン

- マークダウンファイルはmarkdownlintでエラー及び警告がない状態にする
- コミットログはcommitlintに対応する

## 開発ガイドライン

- 既存のファイルのメンテナンスを無視して、新規ファイルばかり作成するのは禁止。既存ファイルを改修することを優先する。

## ドキュメント作成ガイドライン

- README.mdには設計などは書いてはいけない。プロジェクトの説明やディレクトリ構成などの説明のみに徹底する。設計などは、適切なファイルへのリンクを書く。
