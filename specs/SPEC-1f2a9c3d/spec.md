# SPEC-log-api: Agent / Coordinator Log Retrieval API

## 目的
- エージェントの最新ログを HTTP 経由で取得できるようにし、コーディネーター経由でも同じ内容を参照できること。
- ダッシュボードのログパネルはこの API を利用してログを表示できること。

## 機能要件
- **FR-001 (Agent Logs API)**: エージェントは `GET /api/logs?tail=N` で自身のログを返す。  
  - デフォルト `tail=200`。`1 <= tail <= 2000` を許容、超過は 400。  
  - レスポンスは `{"entries": LogEntry[], "path": "…"}` のJSON。LogEntryは既存JSONLと同じフィールドを持つ。  
  - ログファイル未存在時は 200 で `entries: []` を返す。内部エラー時は 500。

- **FR-002 (Coordinator Proxy)**: コーディネーターは `GET /api/agents/:id/logs?tail=N` で対象エージェントのログ API をプロキシする。  
  - エージェントが 200 を返した場合は本文をそのまま返す。  
  - エージェントが応答しない/タイムアウト/非200 の場合は 502 を返し、`{"error": "...reason..."}` を含める。

- **FR-003 (Dashboard Integration)**: ダッシュボードのログパネルは上記コーディネータ API を用いて最新ログを表示できる。tail 件数は UI で可変（デフォルト 200）。

## 非機能要件
- NFR-001: レイテンシはエージェント応答＋500ms以内（コーディネーター側の追加オーバーヘッド）。  
- NFR-002: レスポンスサイズは最大で tail×(1KB) を想定し、10MB を超える場合は 413 を返す。

## 例外・制約
- 認証は現状不要（既存 API ポリシーに合わせる）。将来的にトークン保護を検討。
- ローテートされた過去ログまでは対応しない（最新ファイルのみ）。

## 検証 (Acceptance)
- AC-001: エージェント `/api/logs?tail=5` が末尾5行の JSONL を返す。  
  - 事前にテスト用ログファイルを用意し、行末5が返ることを確認。  
- AC-002: ログファイルが存在しない場合でも 200・空ボディ。  
- AC-003: コーディネーター `/api/agents/:id/logs?tail=3` が 200 を返し、エージェントからの3行がそのまま届く。  
- AC-004: エージェント停止/到達不可時は 502 かつ `error` メッセージを含む。  
- AC-005: ダッシュボードのログパネルで最新ログテキストが表示される（スモーク/E2E）。
