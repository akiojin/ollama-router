# 機能仕様書: リクエスト/レスポンス履歴保存機能

**機能ID**: `SPEC-fbc50d97`
**作成日**: 2025-11-03
**ステータス**: ✅ 実装完了 (2025-11-06)
**入力**: ユーザー説明: "ルーターに送られたリクエストとノードから
返されたレスポンスを保存し、ダッシュボードで確認できるようにする機能"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - リクエスト履歴の確認 (優先度: P1)

オペレーターとして、ダッシュボードでどのリクエストがどのノードで処理されたかを
時系列で確認したい。システムがどのノードにリクエストを振り分けているか、
処理時間がどのくらいかかっているかを把握することで、システムの稼働状況を
監視できる。

**この優先度の理由**: 履歴の可視化は本機能の中核的な価値であり、他のすべての
機能（詳細表示、検索、エクスポート）の基盤となる。これだけで基本的な監視ニーズを
満たせる。

**独立テスト**: ダッシュボードにアクセスし、リクエスト履歴リストが表示されること、
各レコードに時刻・ノード名・モデル名・処理時間・成功/失敗ステータスが含まれる
ことを確認する。

**受け入れシナリオ**:

1. **前提** ルーターが複数のリクエストを処理済み、**実行** オペレーターが
   ダッシュボードの履歴タブを開く、**結果** 時系列順にリクエスト一覧が表示される
2. **前提** リクエストが成功と失敗の両方を含む、**実行** 履歴一覧を確認、**結果**
   各リクエストのステータスが視覚的に区別できる（例：色分け）
3. **前提** ノードが複数存在する、**実行** 履歴を確認、**結果** どのノード
   が各リクエストを処理したかが明確に表示される

---

### ユーザーストーリー2 - エラーの詳細調査 (優先度: P2)

開発者として、エラーが発生したリクエストの詳細（プロンプトとレスポンス本文）を
確認してデバッグしたい。失敗したリクエストの具体的な内容を見ることで、エラーの
原因を特定し、システムの改善につなげることができる。

**この優先度の理由**: デバッグ機能は開発・運用において重要だが、基本的な履歴表示
（P1）が実装されていれば、一時的に別の方法（ログファイル等）でも対応可能。

**独立テスト**: 失敗したリクエストを履歴から選択し、詳細モーダルを開いて、リクエスト
本文（プロンプト、パラメータ）とエラーメッセージが表示されることを確認する。

**受け入れシナリオ**:

1. **前提** エラーが発生したリクエストが存在、**実行** 履歴から該当レコードを
   クリック、**結果** モーダルウィンドウが開き、リクエストとレスポンスの全内容が
   見やすい形式（シンタックスハイライト等）で表示される
2. **前提** 成功したリクエストが存在、**実行** 成功レコードの詳細を開く、**結果**
   リクエスト本文と生成されたレスポンス本文の両方が確認できる
3. **前提** 詳細モーダルを開いている、**実行** モーダルを閉じる、**結果** 履歴
   一覧に戻り、前の位置が保持される

---

### ユーザーストーリー3 - 履歴の検索とフィルタリング (優先度: P3)

管理者として、特定のモデル名、ノード、成功/失敗ステータス、日時範囲で
履歴を絞り込みたい。大量のリクエストの中から関心のあるデータだけを抽出し、
効率的に分析できる。

**この優先度の理由**: 大量データの中から効率的に情報を見つけるための利便性機能。
基本的な履歴表示と詳細確認（P1-P2）があれば最低限の運用は可能。

**独立テスト**: フィルタ条件（例：ノード名="agent-001"、ステータス="エラー"）を
設定し、検索ボタンを押すと、条件に一致するレコードのみが表示されることを確認する。

**受け入れシナリオ**:

1. **前提** 複数のモデルでリクエストが実行済み、**実行** モデル名でフィルタ、
   **結果** 指定したモデルのリクエストのみが一覧に表示される
2. **前提** 複数のノードが存在、**実行** 特定のノードでフィルタ、
   **結果** そのノードが処理したリクエストのみが表示される
3. **前提** 過去7日間のデータが存在、**実行** 日時範囲を"昨日の00:00～23:59"に
   設定、**結果** その期間のリクエストのみが表示される
4. **前提** フィルタが適用されている、**実行** フィルタをクリア、**結果** 全ての
   履歴が再度表示される

---

### ユーザーストーリー4 - 履歴データのエクスポート (優先度: P3)

管理者として、特定期間のリクエスト履歴をJSON/CSV形式でエクスポートして、外部ツール
で分析したい。システム外での詳細な統計分析やレポート作成が可能になる。

**この優先度の理由**: データ分析の利便性向上機能。ダッシュボード上での確認（P1-P3）
で基本的なニーズは満たせる。

**独立テスト**: エクスポートボタンをクリックし、フィルタ条件に合致したデータが
指定形式（JSON/CSV）でダウンロードされることを確認する。

**受け入れシナリオ**:

1. **前提** 履歴データが存在、**実行** JSON形式でエクスポート、**結果** ファイルが
   ダウンロードされ、開くと正しいJSON形式でデータが含まれている
2. **前提** 履歴データが存在、**実行** CSV形式でエクスポート、**結果** ファイルが
   ダウンロードされ、Excel等で開くと表形式でデータが確認できる
3. **前提** フィルタが適用されている、**実行** エクスポート、**結果** フィルタ条件に
   合致したレコードのみがエクスポートされる

---

### エッジケース

- 7日より古いデータはどうなるか？
  - システムが定期的（例：毎日深夜）に古いデータを自動削除し、ユーザーには
    通知しない（透過的に処理）
- 大量のリクエストが短時間に発生した場合、パフォーマンスはどうなるか？
  - 履歴保存は非同期で行われるため、プロキシのレスポンスタイムに影響を与えない
  - ダッシュボードではページネーションにより、一度に表示するレコード数を制限
    （例：100件/ページ）
- ストリーミングレスポンスはどう保存されるか？
  - ストリーミング完了後、完全なレスポンスを保存する
- ストレージ容量が不足した場合はどうなるか？
  - 保存に失敗してもプロキシ機能は継続し、エラーログに記録される
  - システム管理者がストレージを監視する責任を持つ

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはルーターが受信したすべてのリクエスト（Chat、
  Generate）の本文を記録する必要がある
- **FR-002**: システムはノードから返されたすべてのレスポンスの本文を記録
  する必要がある（エラー時はエラー内容を記録）
- **FR-003**: システムは各リクエスト/レスポンスのメタデータ（タイムスタンプ、
  ノードID、モデル名、処理時間、成功/失敗ステータス）を記録する必要がある
- **FR-004**: システムは記録されたデータを7日間保持し、それより古いデータを
  自動的に削除する必要がある
- **FR-005**: ダッシュボードは保存された履歴を時系列順（新しいものから）に一覧
  表示する必要がある
- **FR-006**: ダッシュボードはリクエストをクリックすると詳細（リクエスト本文、
  レスポンス本文、メタデータ）をモーダルウィンドウで表示する必要がある
- **FR-007**: ダッシュボードはモデル名、ノード、成功/失敗ステータス、
  日時範囲で履歴をフィルタリングできる必要がある
- **FR-008**: ダッシュボードは履歴データをJSON形式でエクスポートできる必要がある
- **FR-009**: ダッシュボードは履歴データをCSV形式でエクスポートできる必要がある
- **FR-010**: システムは履歴の保存処理を非同期で実行し、プロキシのレスポンス
  タイムに影響を与えない必要がある
- **FR-011**: システムはサーバー再起動後も保存された履歴データにアクセスできる
  必要がある（永続化）
- **FR-012**: システムはストリーミングレスポンスを完全に記録する必要がある

### 主要エンティティ

- **リクエスト/レスポンスレコード**: 1つのAPIリクエストとそれに対応するレスポンス
  を表す。以下の情報を含む:
  - 一意識別子（UUID）
  - タイムスタンプ（リクエスト受信時刻）
  - リクエストタイプ（Chat / Generate）
  - モデル名
  - ノード情報（ID、マシン名、IPアドレス）
  - リクエスト本文（JSON形式）
  - レスポンス本文（JSON形式、エラー時はエラー情報）
  - 処理時間（ミリ秒）
  - ステータス（成功 / 失敗）
  - レスポンス完了時刻

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- リクエストのリプレイ機能（同じリクエストを再実行）
- 履歴データの長期アーカイブ（7日以上の保存）
- 統計グラフの追加（モデル別の使用率、ノード別の負荷分散状況等）
- リアルタイム通知（特定のエラーが発生したときの通知）
- ユーザー認証・権限管理（現時点では全ユーザーが全データにアクセス可能）

---

## 技術制約 *(該当する場合)*

- 保存方式はJSONファイルベースとし、SQLiteやPostgreSQL等のRDBMSは使用しない
  （既存のノード情報保存方式と統一）
- 保存場所は `~/.ollama-router/request_history.json` とし、環境変数
  `OLLAMA_ROUTER_DATA_DIR` で変更可能とする
- ファイルの読み書きは排他制御（Mutex等）により、並行アクセスの安全性を保証する

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- ルーターサーバーが既に稼働しており、ノードが登録されている
- ダッシュボードがWebブラウザでアクセス可能な状態である
- ストレージ（ファイルシステム）に十分な空き容量がある（目安：7日間で数GB程度）

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- ルーターのプロキシAPI機能（`/api/chat`, `/api/generate`）
- ダッシュボードのバックエンドAPI機能（`coordinator/src/api/dashboard.rs`）
- ダッシュボードのフロントエンド（`coordinator/src/web/static/`）
- 既存のストレージ層実装（`coordinator/src/db/mod.rs`のパターンを踏襲）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. オペレーターはダッシュボードで過去7日間のリクエスト履歴を1秒以内に
   確認できる
2. 開発者は失敗したリクエストの詳細を2クリック以内で確認できる
3. 管理者は特定のフィルタ条件（例：ノード名）で履歴を3秒以内に絞り込める
4. リクエスト履歴の保存がプロキシのレスポンスタイムに与える影響は5%以内である
5. システムは7日間で最低10,000件のリクエスト履歴を保存できる
6. サーバー再起動後も全ての履歴データが消失せずにアクセスできる

---

## ⚡ クイックガイドライン

- ✅ ユーザーが「何を」必要とし「なぜ」必要なのかに焦点を当てる
- ❌ 「どのように」実装するかを避ける (技術スタック、API、コード構造なし)
- 👥 ビジネス関係者向けに記述 (開発者向けではない)
