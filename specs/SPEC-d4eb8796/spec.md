# 機能仕様書: コーディネーター認証・アクセス制御

**機能ID**: `SPEC-d4eb8796`
**作成日**: 2025-11-17
**ステータス**: 下書き
**入力**: ユーザー説明: "コーディネーターに認証機能を追加し、APIアクセスを制御可能にする"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 管理者による初期セットアップとログイン (優先度: P1)

システム管理者は、コーディネーターを初めて起動する際に、自分の管理者アカウントを作成し、
管理画面にログインして、エージェントやモデルの管理作業を安全に行いたい。

**この優先度の理由**: 認証機能の基盤であり、すべての他のアクセス制御機能の前提となる。
この機能がなければ、システムが無防備な状態で公開される。

**独立テスト**: 管理者アカウントの作成とログイン操作のみで完全にテストでき、
基本的なセキュリティ保護が提供される。

**受け入れシナリオ**:

1. **前提** コーディネーターが初回起動される、**実行** 管理者がユーザー名とパスワードを設定する、
**結果** 管理者アカウントが作成され、以降ログインできる
2. **前提** 管理者アカウントが作成済み、**実行** 正しいユーザー名とパスワードで
ダッシュボードにアクセスする、**結果** ダッシュボードが表示され、全機能が利用可能になる
3. **前提** ログインしていない状態、**実行** ダッシュボードにアクセスする、
**結果** ログイン画面が表示され、認証が要求される
4. **前提** ログイン画面が表示されている、**実行** 間違ったパスワードを入力する、
**結果** ログインが拒否され、エラーメッセージが表示される

---

### ユーザーストーリー2 - 外部アプリケーション向けAPIキー発行 (優先度: P1)

管理者は、外部アプリケーション（チャットボット、カスタムツール等）が
コーディネーターのAI機能を利用できるように、APIキーを発行したい。
発行したAPIキーは、必要に応じて無効化できる。

**この優先度の理由**: 外部統合はコーディネーターの主要なユースケースであり、
セキュアなAPI提供は必須機能。管理者ログインと同等に重要。

**独立テスト**: APIキーの発行・使用・削除のみで完全にテストでき、
外部アプリケーション統合の基盤を提供する。

**受け入れシナリオ**:

1. **前提** 管理者がログイン済み、**実行** ダッシュボードでAPIキー発行ボタンを押す、
**結果** 新しいAPIキーが生成され、一度だけ画面に表示される
2. **前提** APIキーが発行されている、**実行** 外部アプリケーションがそのAPIキーを使用して
AI機能にアクセスする、**結果** リクエストが正常に処理される
3. **前提** 無効なAPIキーを使用、**実行** 外部アプリケーションがAI機能にアクセスする、
**結果** アクセスが拒否され、エラーが返される
4. **前提** APIキーが発行されている、**実行** 管理者がそのAPIキーを削除する、
**結果** 以降そのキーは使用できなくなる
5. **前提** 管理者がログイン済み、**実行** APIキー一覧画面を開く、
**結果** 発行済みキーの名前・作成日時が表示される（キー本体は表示されない）

---

### ユーザーストーリー3 - 管理機能へのアクセス制御 (優先度: P1)

認証されたユーザーのみが、エージェント管理・モデル配布・システム設定等の
管理機能にアクセスできるようにし、未認証のアクセスを防止したい。

**この優先度の理由**: 管理機能が無防備では、悪意のある第三者がエージェントを
削除したりシステムを破壊できてしまう。セキュリティの根幹。

**独立テスト**: 認証の有無による管理機能へのアクセス可否のみでテストでき、
システムの基本的なセキュリティを確保する。

**受け入れシナリオ**:

1. **前提** 認証されていない状態、**実行** エージェント一覧取得APIにアクセスする、
**結果** アクセスが拒否され、認証エラーが返される
2. **前提** 正しく認証されている、**実行** エージェント一覧取得APIにアクセスする、
**結果** エージェント情報が正常に返される
3. **前提** 認証されていない状態、**実行** エージェント削除APIを呼び出す、
**結果** アクセスが拒否され、エージェントは削除されない
4. **前提** 正しく認証されている、**実行** モデル配布APIを呼び出す、
**結果** モデル配布が正常に実行される

---

### ユーザーストーリー4 - プライベートネットワークでの認証無効化 (優先度: P2)

システム管理者は、閉じたネットワーク環境（企業内LAN等）で運用する場合に、
認証機能を無効化してシンプルに運用したい。

**この優先度の理由**: セキュリティが物理的に保護されている環境では、
認証がオーバーヘッドになる場合がある。柔軟性の提供。

**独立テスト**: 認証無効化設定の切り替えのみでテストでき、
特定の運用環境向けの選択肢を提供する。

**受け入れシナリオ**:

1. **前提** 認証無効化モードが設定されている、**実行** ダッシュボードにアクセスする、
**結果** ログイン画面なしで直接ダッシュボードが表示される
2. **前提** 認証無効化モードが設定されている、**実行** 管理APIにアクセスする、
**結果** 認証なしでAPIが実行される
3. **前提** 認証無効化モードから認証有効化モードに切り替え、**実行** システムを再起動する、
**結果** 認証が要求されるようになる

---

### ユーザーストーリー5 - エージェントからの安全な通信 (優先度: P2)

エージェントがコーディネーターに登録する際に、専用の通信トークンを受け取り、
以降の通信（ヘルスチェック、メトリクス送信等）でそのトークンを使用することで、
なりすましを防止したい。

**この優先度の理由**: エージェントとコーディネーター間の通信が無防備だと、
悪意のある第三者が偽のメトリクスを送信してシステムを混乱させる可能性がある。

**独立テスト**: エージェント登録時のトークン発行と使用のみでテストでき、
エージェント通信のセキュリティを向上させる。

**受け入れシナリオ**:

1. **前提** エージェントが登録APIを呼び出す、**実行** 登録が成功する、
**結果** レスポンスに専用トークンが含まれる
2. **前提** エージェントが専用トークンを保持している、**実行** ヘルスチェックAPIを
トークン付きで呼び出す、**結果** ヘルスチェックが正常に処理される
3. **前提** エージェントが無効なトークンを使用、**実行** ヘルスチェックAPIを呼び出す、
**結果** アクセスが拒否される
4. **前提** エージェントがトークンを紛失、**実行** トークンなしでメトリクス送信APIを呼び出す、
**結果** アクセスが拒否される

---

### ユーザーストーリー6 - 複数ユーザーの管理 (優先度: P3)

管理者は、他のユーザー（閲覧専用ユーザー、他の管理者等）を追加・削除し、
複数人でコーディネーターを管理したい。

**この優先度の理由**: 小規模な運用では単一管理者で十分だが、
組織的な運用では複数人での管理が必要になる。将来的な拡張性。

**独立テスト**: ユーザー追加・削除のみでテストでき、
マルチユーザー運用の基盤を提供する。

**受け入れシナリオ**:

1. **前提** 管理者がログイン済み、**実行** 新規ユーザー作成画面でユーザー名とパスワードを入力、
**結果** 新しいユーザーが作成される
2. **前提** 複数ユーザーが存在、**実行** 管理者がユーザー一覧を表示、
**結果** すべてのユーザーが一覧表示される
3. **前提** 不要なユーザーが存在、**実行** 管理者がそのユーザーを削除、
**結果** ユーザーが削除され、以降ログインできなくなる
4. **前提** ユーザーがパスワードを忘れた、**実行** 管理者がそのユーザーのパスワードを
再設定、**結果** 新しいパスワードでログインできるようになる

---

### エッジケース

- **初回起動時に管理者作成を中断した場合**: 再起動時に再度管理者作成プロンプトが表示される
- **全管理者ユーザーを削除した場合**: システムがロックアウト状態になるため、削除前に警告を表示する
- **APIキーが漏洩した場合**: 管理者が即座にそのキーを削除できる
- **認証トークンの有効期限切れ**: 自動的に再ログインが促される
- **同時に複数の管理者が同じエージェントを操作した場合**: 最後の操作が優先される
（競合検出は将来の機能）
- **認証無効化モードと認証有効化モードを頻繁に切り替えた場合**:
設定変更は再起動後に反映される

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは初回起動時に管理者アカウントの作成を要求する必要がある
- **FR-002**: システムはユーザー名とパスワードによるログイン機能を提供する必要がある
- **FR-003**: システムはパスワードを安全にハッシュ化して保存する必要がある
- **FR-004**: 管理者は外部アプリケーション向けにAPIキーを発行できる必要がある
- **FR-005**: システムは発行されたAPIキーを使用したAPI呼び出しを認証する必要がある
- **FR-006**: 管理者はダッシュボードで発行済みAPIキーの一覧を閲覧できる必要がある
- **FR-007**: 管理者は不要になったAPIキーを削除できる必要がある
- **FR-008**: システムは管理機能（エージェント管理、モデル配布等）へのアクセスを
認証済みユーザーに制限する必要がある
- **FR-009**: システムはエージェント登録時に専用トークンを発行する必要がある
- **FR-010**: エージェントは発行されたトークンを使用してヘルスチェック・
メトリクス送信を行う必要がある
- **FR-011**: システムは設定により認証機能を無効化できる必要がある
- **FR-012**: 認証無効化モードでは、すべてのAPIが認証なしでアクセス可能になる必要がある
- **FR-013**: 管理者は新規ユーザーを作成できる必要がある
- **FR-014**: 管理者は既存ユーザーを削除できる必要がある
- **FR-015**: 管理者はユーザーのパスワードを変更できる必要がある
- **FR-016**: システムは認証状態を一定期間（セッション）保持する必要がある
- **FR-017**: ユーザーは明示的にログアウトできる必要がある
- **FR-018**: システムは認証エラー時に適切なエラーメッセージを表示する必要がある
- **FR-019**: APIキーは発行時に一度だけ平文で表示され、以降はハッシュ化された形で保存される
必要がある
- **FR-020**: システムは管理API（/api/*）、AI機能API（/v1/*）、エージェント通信API
それぞれに適切な認証方式を適用する必要がある

### 主要エンティティ

- **ユーザー**: システムにログインして管理機能を利用する人。
ユーザー名、パスワード（ハッシュ化）、役割（管理者/閲覧専用）を持つ
- **APIキー**: 外部アプリケーションがAI機能を利用するための認証情報。
キー本体（ハッシュ化）、名前、発行者、有効期限を持つ
- **エージェントトークン**: エージェントがコーディネーターと安全に通信するための認証情報。
エージェントIDに紐づき、トークン本体（ハッシュ化）を持つ
- **セッション**: ログイン後の認証状態。ユーザーID、有効期限を持つ

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- OAuth/SAML等の外部認証プロバイダー連携
- 二要素認証（2FA）
- APIキーのスコープ制限（特定のエンドポイントのみ許可）
- ユーザー単位の詳細なアクセス制御（RBAC）
- 監査ログ・アクセスログの記録
- パスワードポリシー（複雑さ要件、有効期限）
- アカウントロックアウト機能（ログイン試行回数制限）
- セッションの複数デバイス管理
- APIキーのレート制限

---

## 技術制約 *(該当する場合)*

- Windows、macOS、Linuxの3つのOSで動作する必要がある
- 既存のデータ保存方式（JSONファイル）をデータベース（SQLite）に移行する必要がある
- 既存のエージェント登録APIの互換性を維持する必要がある
（レスポンスにトークンフィールドを追加）

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- ユーザーは初回起動時にコーディネーターに直接アクセスできる
（管理者作成前のブートストラップ問題を解決するため）
- エージェントは登録レスポンスに含まれるトークンを永続化できる
- 外部アプリケーションは発行されたAPIキーを安全に保存できる

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- 既存のエージェント管理機能（SPEC-*）
- 既存のモデル配布機能（SPEC-8ae67d67）
- 既存のダッシュボード機能

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. 未認証の第三者が管理機能にアクセスできないこと（アクセス試行時に
100%拒否される）
2. 管理者が3ステップ以内でAPIキーを発行できること
3. 初回起動から管理者ログインまでが5分以内に完了できること
4. 認証機能が有効な状態でも、既存のエージェント登録・通信が正常に動作すること
（後方互換性100%）
5. 認証無効化モードでは、すべてのAPIが認証なしでアクセス可能であること
6. Windows、macOS、Linuxのすべてで認証機能が同じように動作すること
