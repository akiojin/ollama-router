# 機能仕様書: Ollama Coordinator System

**機能ID**: `SPEC-32e2b31a`
**作成日**: 2025-10-30
**ステータス**: 下書き
**入力**: ユーザー説明: "Ollama Coordinator System - 複数マシンでOllamaインスタンスを管理する中央集権型システム"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - エージェントの自己登録と接続管理 (優先度: P1)

ユーザーは各マシンでエージェントアプリケーションを起動し、コーディネーターに自動的に登録される。エージェントはシステムトレイに常駐し、コーディネーターとの接続状態をリアルタイムで表示する。

**この優先度の理由**: エージェント登録はシステムの基盤機能であり、これがなければ他のすべての機能が動作しない。最小限の機能で動作確認が可能。

**独立テスト**: エージェントを起動してコーディネーターのURLを設定し、登録が成功することで完全にテスト可能。コーディネーター側で登録されたエージェント一覧を確認できれば価値を提供する。

**受け入れシナリオ**:

1. **前提** エージェントアプリがインストールされていない、**実行** エージェントをインストールして起動する、**結果** システムトレイにアイコンが表示され、設定ウィンドウが自動的に開く
2. **前提** エージェントが起動している、**実行** 設定ウィンドウでコーディネーターのURL（例: `http://192.168.1.10:8080`）を入力して「接続」をクリックする、**結果** エージェントがコーディネーターに登録され、接続状態が「接続済み」と表示される
3. **前提** エージェントが登録されている、**実行** コーディネーターのダッシュボードを開く、**結果** 登録されたエージェントが一覧に表示され、マシン名、IPアドレス、Ollamaのバージョンが確認できる
4. **前提** エージェントが登録されている、**実行** エージェントアプリを終了する、**結果** コーディネーターのダッシュボードで該当エージェントが「オフライン」状態になる
5. **前提** コーディネーターをホストするマシンである、**実行** そのマシンでエージェントを起動する、**結果** 同一マシン上のコーディネーターに正常に登録され、localhostとして認識される

---

### ユーザーストーリー2 - 統一APIエンドポイントによるOllamaアクセス (優先度: P2)

ユーザーは複数のOllamaインスタンスを意識せず、コーディネーターの単一エンドポイントを通じてOllama APIにアクセスできる。コーディネーターは自動的に利用可能なエージェントにリクエストを振り分ける。

**この優先度の理由**: 複数のOllamaインスタンスを統一して扱えることがこのシステムの中核的な価値。エージェント登録が完了していれば独立して実装・テスト可能。

**独立テスト**: コーディネーターのエンドポイント（例: `http://coordinator:8080/api/chat`）に対してOllama API形式のリクエストを送信し、正常にレスポンスが返ることで価値を提供する。

**受け入れシナリオ**:

1. **前提** 2台のエージェントが登録されている、**実行** コーディネーターのAPI（`POST /api/chat`）にチャットリクエストを送信する、**結果** いずれかのエージェントが処理し、LLMからのレスポンスが返される
2. **前提** 登録されたエージェントがない、**実行** コーディネーターのAPIにリクエストを送信する、**結果** 「利用可能なエージェントがありません」というエラーメッセージが返される
3. **前提** 1台のエージェントが登録されている、**実行** 同時に5つのリクエストを送信する、**結果** すべてのリクエストが同じエージェントで処理され、順次レスポンスが返される
4. **前提** 3台のエージェントが登録されている、**実行** 連続して9つのリクエストを送信する、**結果** リクエストが3台のエージェントに均等に分散され（各エージェントが3リクエストずつ処理）、すべてレスポンスが返される

---

### ユーザーストーリー3 - ロードバランシングと負荷分散 (優先度: P3)

ユーザーが複数のリクエストを送信した際、コーディネーターは各エージェントの負荷状況に応じて最適なエージェントにリクエストを振り分ける。これにより、特定のマシンに負荷が集中することを防ぐ。

**この優先度の理由**: 基本的なAPI統合が完了していれば、負荷分散の最適化は段階的に改善可能。最初はラウンドロビンで動作し、後で負荷ベースに改善できる。

**独立テスト**: 複数のエージェントが登録された状態で大量のリクエストを送信し、各エージェントへの分散状況を監視することで価値を提供する。

**受け入れシナリオ**:

1. **前提** 3台のエージェントが登録され、すべてアイドル状態、**実行** 連続して30個のリクエストを送信する、**結果** 各エージェントがほぼ均等（各10個前後）のリクエストを処理する
2. **前提** 2台のエージェントが登録され、1台が高負荷（CPU 90%）、**実行** 新しいリクエストを送信する、**結果** 低負荷のエージェントが優先的に選択される
3. **前提** 4台のエージェントが登録されている、**実行** ダッシュボードでリアルタイムのリクエスト分散状況を確認する、**結果** 各エージェントが処理中のリクエスト数と処理済みリクエスト数が表示される

---

### ユーザーストーリー4 - ヘルスチェックと自動障害検知 (優先度: P4)

コーディネーターは各エージェントの稼働状況を定期的に監視し、応答がないエージェントを自動的に検出する。障害が検出されたエージェントは自動的にリクエスト振り分けから除外され、復旧時に自動的に再登録される。

**この優先度の理由**: 基本的なロードバランシングが動作していれば、障害検知は追加機能として実装可能。手動でのエージェント管理でも最低限の運用は可能。

**独立テスト**: エージェントを強制終了し、コーディネーターがそれを検知して除外することで価値を提供する。

**受け入れシナリオ**:

1. **前提** 3台のエージェントが登録され稼働中、**実行** 1台のエージェントを強制終了する、**結果** 30秒以内にコーディネーターが障害を検知し、該当エージェントを「オフライン」状態にする
2. **前提** 1台のエージェントがオフライン状態、**実行** 新しいリクエストを送信する、**結果** オフラインのエージェントにはリクエストが振り分けられず、オンラインのエージェントのみが使用される
3. **前提** 1台のエージェントがオフライン状態、**実行** そのエージェントを再起動する、**結果** エージェントが自動的にコーディネーターに再登録され、リクエスト振り分けの対象に戻る
4. **前提** すべてのエージェントがオフライン、**実行** 新しいリクエストを送信する、**結果** 「すべてのエージェントが利用不可」というエラーメッセージが返される

---

### ユーザーストーリー5 - 管理ダッシュボードとリアルタイム監視 (優先度: P5)

ユーザーはWebブラウザからコーディネーターのダッシュボードにアクセスし、すべてのエージェントの状態、リクエスト処理状況、パフォーマンスメトリクスをリアルタイムで確認できる。

**この優先度の理由**: システムがAPI経由で動作していれば、ダッシュボードは可視化のための追加機能。運用初期はログやAPIレスポンスで状態確認が可能。

**独立テスト**: ブラウザでダッシュボードにアクセスし、エージェント情報が表示されることで価値を提供する。

**受け入れシナリオ**:

1. **前提** コーディネーターが起動している、**実行** ブラウザで`http://coordinator:8080/dashboard`にアクセスする、**結果** ダッシュボードが表示され、登録済みエージェントの一覧が確認できる
2. **前提** 複数のエージェントが登録されている、**実行** ダッシュボードでエージェント一覧を確認する、**結果** 各エージェントのマシン名、IPアドレス、Ollamaバージョン、稼働時間、状態（オンライン/オフライン）が表示される
3. **前提** エージェントがリクエストを処理中、**実行** ダッシュボードをリロードする、**結果** リアルタイムでリクエスト処理数、レスポンスタイム、エラー数が更新される
4. **前提** ダッシュボードを表示中、**実行** 新しいエージェントが登録される、**結果** ページをリロードせずに新しいエージェントが一覧に自動追加される

---

### エッジケース

- エージェントが複数のネットワークインターフェースを持つ場合、どのIPアドレスを登録に使用するか？
- コーディネーターが再起動された際、以前に登録されていたエージェントの情報は保持されるか？それとも再登録が必要か？
- エージェントとコーディネーター間のネットワークが不安定な場合、どのくらいの頻度で再接続を試みるか？
- 同一マシン上で複数のOllamaインスタンスが動作している場合、エージェントはどれを管理対象とするか？
- Ollamaインスタンスが応答しないがエージェント自体は稼働している場合、どのように検知・処理するか？
- リクエスト処理中にエージェントがオフラインになった場合、リクエストはどうなるか？（リトライ、エラー返却、他エージェントへ転送？）
- Windows Firewall環境でエージェント→コーディネーター、コーディネーター→Ollamaの通信が許可されていない場合、適切なエラーメッセージを表示できるか？

## 要件 *(必須)*

### 機能要件

#### コーディネーター機能

- **FR-001**: コーディネーターはWebサーバーとして動作し、HTTPSまたはHTTPでアクセス可能である必要がある
- **FR-002**: コーディネーターはエージェントからの登録リクエスト（マシン名、IPアドレス、Ollamaバージョン、ポート番号）を受け入れる必要がある
- **FR-003**: コーディネーターは登録されたすべてのエージェントの一覧を管理し、永続化する必要がある
- **FR-004**: コーディネーターは統一APIエンドポイント（`/api/chat`, `/api/generate`など）を提供し、Ollama APIと互換性のあるリクエスト・レスポンス形式をサポートする必要がある
- **FR-005**: コーディネーターは受信したリクエストを利用可能なエージェントに振り分ける必要がある（ラウンドロビンまたは負荷ベース）
- **FR-006**: コーディネーターは各エージェントに対して定期的にヘルスチェックを実行し、応答がないエージェントを検知する必要がある
- **FR-007**: コーディネーターはオフラインと判定されたエージェントをリクエスト振り分け対象から除外する必要がある
- **FR-008**: コーディネーターはWebベースのダッシュボードを提供し、エージェント一覧、状態、メトリクスを表示する必要がある
- **FR-009**: コーディネーターはリアルタイム更新（WebSocketまたはSSE）でダッシュボードの情報を更新する必要がある
- **FR-010**: コーディネーターはログを記録し、エージェント登録、リクエスト処理、エラーなどのイベントを永続化する必要がある

#### エージェント機能

- **FR-011**: エージェントはWindows上でGUIアプリケーションとして動作する必要がある
- **FR-012**: エージェントは起動時にシステムトレイに常駐し、アイコンを表示する必要がある
- **FR-013**: エージェントはシステムトレイアイコンから設定ウィンドウを開くことができる必要がある
- **FR-014**: エージェント設定ウィンドウは、コーディネーターのURL、自動起動設定、接続状態を表示・変更できる必要がある
- **FR-015**: エージェントは起動時または設定変更時に、コーディネーターに自己登録リクエストを送信する必要がある
- **FR-016**: **【重要】エージェントは起動時にOllamaの存在を確認し、インストールされていない場合は自動的にダウンロード・インストールする必要がある**
- **FR-017**: **【重要】エージェントはOllamaが停止している場合、自動的に起動する必要がある（ユーザーによる手動操作不要）**
- **FR-018**: エージェントはローカルOllamaインスタンスの稼働状況を常時監視する必要がある
- **FR-019**: エージェントは定期的にコーディネーターにヘルスチェック情報（CPU使用率、メモリ使用率、処理中リクエスト数）を送信する必要がある
- **FR-020**: エージェントはコーディネーターからのリクエストをローカルOllamaインスタンスに転送し、レスポンスを返す必要がある
- **FR-021**: エージェントはWindows起動時に自動起動できる必要がある（オプション設定可能）
- **FR-022**: エージェントはコーディネーターと同一マシン上で動作可能である必要がある

### 主要エンティティ

- **コーディネーター**: 中央管理サーバー。複数のエージェントを管理し、リクエストを振り分け、ダッシュボードを提供する。属性: URL、ポート番号、登録エージェント数、稼働時間。
- **エージェント**: 各マシン上で動作するクライアントアプリケーション。ローカルOllamaインスタンスを管理し、コーディネーターに登録する。属性: マシン名、IPアドレス、Ollamaバージョン、状態（オンライン/オフライン）、最終ヘルスチェック時刻。
- **Ollamaインスタンス**: 各マシン上で動作するLLMランタイム。HTTP APIを提供し、エージェント経由でリクエストを受け取る。属性: ポート番号、バージョン、利用可能モデル一覧。
- **リクエスト**: クライアントからコーディネーターへ送信されるOllama API呼び出し。属性: リクエストID、タイムスタンプ、振り分け先エージェント、処理時間、ステータス（処理中/完了/エラー）。

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- エージェント認証・認可機能（現バージョンではコーディネーターURLを知っていれば誰でも登録可能）
- コーディネーターの高可用性構成（複数コーディネーターのクラスタリング）
- ユーザーごとのリクエスト管理・割り当て制御
- モデル別のルーティング（特定のモデルを持つエージェントへの優先割り当て）
- リクエストキューイングと優先度制御
- 詳細なパフォーマンスメトリクス（レイテンシ分布、スループット、エラーレート）
- コーディネーター・エージェント間の暗号化通信（TLS/SSL）
- Linux/macOS対応（現バージョンはWindows専用）
- エージェントのリモート設定変更（コーディネーター側からの設定プッシュ）

---

## 技術制約 *(該当する場合)*

- Windows 10以降が必要（エージェントアプリケーション）
- .NET Framework 4.8以降、または適切なRustランタイムが必要
- **Ollamaは自動ダウンロード・自動起動されるため、ユーザーによる事前インストールは不要**
- ネットワーク環境: エージェントとコーディネーター間でHTTP/HTTPS通信が可能である必要がある
- ネットワーク環境: エージェントからOllamaダウンロードサイト（https://ollama.com）への接続が可能である必要がある
- ポート要件: コーディネーターはデフォルトでポート8080、Ollamaはデフォルトでポート11434を使用

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- **Ollamaはエージェントによって自動ダウンロード・起動されるため、ユーザーによる事前インストールは不要**
- エージェントとコーディネーター間のネットワーク通信が許可されている（ファイアウォール設定が適切である）
- エージェントがインターネットに接続可能であり、Ollamaダウンロードサイト（https://ollama.com）にアクセスできる
- Windows環境でGUIアプリケーションの実行が許可されている
- ユーザーが管理者権限を持ち、スタートアップ登録やネットワーク設定が可能である

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- **Ollama**: ローカルLLMランタイム。エージェントによって自動ダウンロード・起動され、各エージェントマシン上で動作し、HTTP API（デフォルト: `http://localhost:11434`）を提供する。ユーザーによる手動インストール・起動は不要。
- **Webブラウザ**: ダッシュボード表示のため、モダンなWebブラウザ（Chrome、Edge、Firefox等）が必要。

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. **Ollama自動管理**: Ollamaが未インストールの状態でエージェントを起動した場合、自動的にOllamaがダウンロード・インストール・起動され、ユーザーによる手動操作なしにコーディネーターに登録される
2. **エージェント登録の即座性**: エージェントが起動してからコーディネーターに登録されるまでの時間が5秒以内である（Ollamaが既にインストールされている場合）
3. **リクエスト振り分けの均等性**: 10個のリクエストを送信した場合、3台のエージェントがそれぞれ2〜5個のリクエストを処理する（完全に均等ではないが大きな偏りがない）
4. **障害検知の迅速性**: エージェントがオフラインになってから60秒以内にコーディネーターが検知し、リクエスト振り分けから除外する
5. **ダッシュボードのリアルタイム性**: エージェントの状態変化（オンライン↔オフライン）がダッシュボード上で10秒以内に反映される
6. **システムの安定性**: コーディネーターが24時間連続稼働し、エージェントの登録・解除、リクエスト処理を問題なく継続できる
7. **ユーザビリティ**: 技術者でないユーザーが、設定ウィンドウでコーディネーターURLを入力するだけでエージェントを登録できる
8. **同一マシン動作**: コーディネーターとエージェントが同一マシン上で動作し、localhostとして正常に認識・処理される

---

## ⚡ クイックガイドライン

- ✅ ユーザーが「何を」必要とし「なぜ」必要なのかに焦点を当てる
- ❌ 「どのように」実装するかを避ける (技術スタック、API、コード構造なし)
- 👥 ビジネス関係者向けに記述 (開発者向けではない)
