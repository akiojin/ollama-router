# 機能仕様書: LLM Router System（統合版・アーカイブ）

**機能ID**: `SPEC-32e2b31a`
**作成日**: 2025-10-30
**ステータス**: ✅ **分割済み・アーカイブ**
**入力**: ユーザー説明: "LLM Router System - 複数マシンでOllamaインスタンスを管理する中央集権型システム"

---

## 📋 本SPECの分割先

本SPECは以下の5つの独立したSPECに分割されました：

1. **[SPEC-94621a1f](../SPEC-94621a1f/spec.md)** - ノード自己登録システム（✅ 実装済み）
   - ノード登録API
   - ハートビート処理
   - ノード情報永続化

2. **[SPEC-63acef08](../SPEC-63acef08/spec.md)** - 統一APIプロキシ（✅ 実装済み）
   - Ollama API互換プロキシ
   - リクエスト転送
   - ラウンドロビンロードバランシング

3. **[SPEC-443acc8c](../SPEC-443acc8c/spec.md)** - ヘルスチェックシステム（✅ 実装済み）
   - パッシブヘルスチェック（ハートビートベース）
   - 自動オフライン検出
   - 自動復旧

4. **[SPEC-589f2df1](../SPEC-589f2df1/spec.md)** - ロードバランシングシステム（✅ 実装済み）
   - Phase 1: ラウンドロビン方式（✅ 実装済み）
   - Phase 2: メトリクスベース選択（✅ 実装済み）

5. **[SPEC-712c20cf](../SPEC-712c20cf/spec.md)** - 管理ダッシュボード＋ノード管理UI（✅ 実装済み）
   - WebダッシュボードUI
   - リアルタイム監視
   - ノード設定管理
   - ノード制御機能

---

## ⚠️ アーカイブ後の変更点

本アーカイブ版は、実装方針の変更により以下の調整を行いました：

### 削除された要件（Windows GUI関連）
- ~~FR-011: Windows GUIアプリケーション~~
- ~~FR-012: システムトレイ常駐~~
- ~~FR-013: システムトレイアイコンから設定ウィンドウ~~
- ~~FR-021: Windows自動起動設定~~

> **2025-11-12追記**: Windows / macOS に限りシステムトレイ常駐要件（FR-012 相当）が `SPEC-94621a1f` の FR-005 として再導入されました。Linux では従来通り CLI 常駐です。

### 変更された要件
- **ノード**: CLIベース実装（クロスプラットフォーム対応）
- **ノード管理**: WebUI（SPEC-712c20cf）で提供
- **プラットフォーム**: Windows 10+ / macOS 12+（将来的にLinux対応予定）

---

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - ノードの自己登録と接続管理 (優先度: P1)
> **分割先**: [SPEC-94621a1f](../SPEC-94621a1f/spec.md) + [SPEC-712c20cf](../SPEC-712c20cf/spec.md)

ユーザーは各マシンでノードアプリケーション（CLIベース）を起動し、ルーターに自動的に登録される。ノードの状態確認・設定変更はWebダッシュボードで行う。

**この優先度の理由**: ノード登録はシステムの基盤機能であり、これがなければ他のすべての機能が動作しない。最小限の機能で動作確認が可能。

**独立テスト**: ノードを起動してルーターのURLを環境変数で設定し、登録が成功することで完全にテスト可能。ルーター側で登録されたノード一覧を確認できれば価値を提供する。

**受け入れシナリオ（アーカイブ版・参考用）**:

1. ~~**前提** ノードアプリがインストールされていない、**実行** ノードをインストールして起動する、**結果** システムトレイにアイコンが表示され、設定ウィンドウが自動的に開く~~ → **変更**: CLIアプリとして起動
2. ~~**前提** ノードが起動している、**実行** 設定ウィンドウでルーターのURL（例: `http://192.168.1.10:8080`）を入力して「接続」をクリックする、**結果** ノードがルーターに登録され、接続状態が「接続済み」と表示される~~ → **変更**: 環境変数`ROUTER_URL`で設定、WebUIで状態確認
3. **前提** ノードが登録されている、**実行** ルーターのダッシュボードを開く、**結果** 登録されたノードが一覧に表示され、マシン名、IPアドレス、Ollamaのバージョンが確認できる（✅ 維持）
4. **前提** ノードが登録されている、**実行** ノードアプリを終了する、**結果** ルーターのダッシュボードで該当ノードが「オフライン」状態になる（✅ 維持）
5. **前提** ルーターをホストするマシンである、**実行** そのマシンでノードを起動する、**結果** 同一マシン上のルーターに正常に登録され、localhostとして認識される（✅ 維持）

---

### ユーザーストーリー2 - 統一APIエンドポイントによるOllamaアクセス (優先度: P2)
> **分割先**: [SPEC-63acef08](../SPEC-63acef08/spec.md)

ユーザーは複数のOllamaインスタンスを意識せず、ルーターの単一エンドポイントを通じてOllama APIにアクセスできる。ルーターは自動的に利用可能なノードにリクエストを振り分ける。

**この優先度の理由**: 複数のOllamaインスタンスを統一して扱えることがこのシステムの中核的な価値。ノード登録が完了していれば独立して実装・テスト可能。

**独立テスト**: ルーターのエンドポイント（例: `http://coordinator:8080/api/chat`）に対してOllama API形式のリクエストを送信し、正常にレスポンスが返ることで価値を提供する。

**受け入れシナリオ**:

1. **前提** 2台のノードが登録されている、**実行** ルーターのAPI（`POST /api/chat`）にチャットリクエストを送信する、**結果** いずれかのノードが処理し、LLMからのレスポンスが返される
2. **前提** 登録されたノードがない、**実行** ルーターのAPIにリクエストを送信する、**結果** 「利用可能なノードがありません」というエラーメッセージが返される
3. **前提** 1台のノードが登録されている、**実行** 同時に5つのリクエストを送信する、**結果** すべてのリクエストが同じノードで処理され、順次レスポンスが返される
4. **前提** 3台のノードが登録されている、**実行** 連続して9つのリクエストを送信する、**結果** リクエストが3台のノードに均等に分散され（各ノードが3リクエストずつ処理）、すべてレスポンスが返される

---

### ユーザーストーリー3 - ロードバランシングと負荷分散 (優先度: P3)
> **分割先**: [SPEC-589f2df1](../SPEC-589f2df1/spec.md)

ユーザーが複数のリクエストを送信した際、ルーターは各ノードの負荷状況に応じて最適なノードにリクエストを振り分ける。これにより、特定のマシンに負荷が集中することを防ぐ。

**この優先度の理由**: 基本的なAPI統合が完了していれば、負荷分散の最適化は段階的に改善可能。最初はラウンドロビンで動作し、後で負荷ベースに改善できる。

**独立テスト**: 複数のノードが登録された状態で大量のリクエストを送信し、各ノードへの分散状況を監視することで価値を提供する。

**受け入れシナリオ**:

1. **前提** 3台のノードが登録され、すべてアイドル状態、**実行** 連続して30個のリクエストを送信する、**結果** 各ノードがほぼ均等（各10個前後）のリクエストを処理する
2. **前提** 2台のノードが登録され、1台が高負荷（CPU 90%）、**実行** 新しいリクエストを送信する、**結果** 低負荷のノードが優先的に選択される
3. **前提** 4台のノードが登録されている、**実行** ダッシュボードでリアルタイムのリクエスト分散状況を確認する、**結果** 各ノードが処理中のリクエスト数と処理済みリクエスト数が表示される

---

### ユーザーストーリー4 - ヘルスチェックと自動障害検知 (優先度: P4)
> **分割先**: [SPEC-443acc8c](../SPEC-443acc8c/spec.md)

ルーターは各ノードの稼働状況を定期的に監視し、応答がないノードを自動的に検出する。障害が検出されたノードは自動的にリクエスト振り分けから除外され、復旧時に自動的に再登録される。

**この優先度の理由**: 基本的なロードバランシングが動作していれば、障害検知は追加機能として実装可能。手動でのノード管理でも最低限の運用は可能。

**独立テスト**: ノードを強制終了し、ルーターがそれを検知して除外することで価値を提供する。

**受け入れシナリオ**:

1. **前提** 3台のノードが登録され稼働中、**実行** 1台のノードを強制終了する、**結果** 30秒以内にルーターが障害を検知し、該当ノードを「オフライン」状態にする
2. **前提** 1台のノードがオフライン状態、**実行** 新しいリクエストを送信する、**結果** オフラインのノードにはリクエストが振り分けられず、オンラインのノードのみが使用される
3. **前提** 1台のノードがオフライン状態、**実行** そのノードを再起動する、**結果** ノードが自動的にルーターに再登録され、リクエスト振り分けの対象に戻る
4. **前提** すべてのノードがオフライン、**実行** 新しいリクエストを送信する、**結果** 「すべてのノードが利用不可」というエラーメッセージが返される

---

### ユーザーストーリー5 - 管理ダッシュボードとリアルタイム監視 (優先度: P5)
> **分割先**: [SPEC-712c20cf](../SPEC-712c20cf/spec.md)

ユーザーはWebブラウザからルーターのダッシュボードにアクセスし、すべてのノードの状態、リクエスト処理状況、パフォーマンスメトリクスをリアルタイムで確認できる。ノード設定の管理もWebUIで実施する。

**この優先度の理由**: システムがAPI経由で動作していれば、ダッシュボードは可視化のための追加機能。運用初期はログやAPIレスポンスで状態確認が可能。

**独立テスト**: ブラウザでダッシュボードにアクセスし、ノード情報が表示されることで価値を提供する。

**受け入れシナリオ**:

1. **前提** ルーターが起動している、**実行** ブラウザで`http://coordinator:8080/dashboard`にアクセスする、**結果** ダッシュボードが表示され、登録済みノードの一覧が確認できる
2. **前提** 複数のノードが登録されている、**実行** ダッシュボードでノード一覧を確認する、**結果** 各ノードのマシン名、IPアドレス、Ollamaバージョン、稼働時間、状態（オンライン/オフライン）が表示される
3. **前提** ノードがリクエストを処理中、**実行** ダッシュボードをリロードする、**結果** リアルタイムでリクエスト処理数、レスポンスタイム、エラー数が更新される
4. **前提** ダッシュボードを表示中、**実行** 新しいノードが登録される、**結果** ページをリロードせずに新しいノードが一覧に自動追加される

---

### エッジケース

- ノードが複数のネットワークインターフェースを持つ場合、どのIPアドレスを登録に使用するか？
- ルーターが再起動された際、以前に登録されていたノードの情報は保持されるか？それとも再登録が必要か？
- ノードとルーター間のネットワークが不安定な場合、どのくらいの頻度で再接続を試みるか？
- 同一マシン上で複数のOllamaインスタンスが動作している場合、ノードはどれを管理対象とするか？
- Ollamaインスタンスが応答しないがノード自体は稼働している場合、どのように検知・処理するか？
- リクエスト処理中にノードがオフラインになった場合、リクエストはどうなるか？（リトライ、エラー返却、他ノードへ転送？）
- Windows Firewall環境でノード→ルーター、ルーター→Ollamaの通信が許可されていない場合、適切なエラーメッセージを表示できるか？

## 要件 *(必須)*

### 機能要件

#### ルーター機能

- **FR-001**: ルーターはWebサーバーとして動作し、HTTPSまたはHTTPでアクセス可能である必要がある
- **FR-002**: ルーターはノードからの登録リクエスト（マシン名、IPアドレス、Ollamaバージョン、ポート番号）を受け入れる必要がある
- **FR-003a**: ルーターは登録されたすべてのノードの一覧を管理する必要がある
- **FR-003b**: ルーターはノード情報をデータベースに永続化する必要がある
- **FR-004a**: ルーターは統一APIエンドポイント（`/api/chat`, `/api/generate`）を提供する必要がある
- **FR-004b**: ルーターのAPIはOllama APIと互換性のあるリクエスト・レスポンス形式をサポートする必要がある
- **FR-005**: ルーターは受信したリクエストを利用可能なノードに振り分ける必要がある（ラウンドロビンまたは負荷ベース）
- **FR-006a**: ルーターは各ノードに対して定期的にヘルスチェックを実行する必要がある
- **FR-006b**: ルーターは応答がないノードを自動検知する必要がある
- **FR-007**: ルーターはオフラインと判定されたノードをリクエスト振り分け対象から除外する必要がある
- **FR-008a**: ルーターはWebベースのダッシュボードを提供する必要がある
- **FR-008b**: ダッシュボードはノード一覧、状態、メトリクスを表示する必要がある
- **FR-009**: ルーターはリアルタイム更新（WebSocketまたはSSE）でダッシュボードの情報を更新する必要がある
- **FR-010**: ルーターはログを記録し、ノード登録、リクエスト処理、エラーなどのイベントを永続化する必要がある

#### ノード機能

##### 削除された要件（Windows GUI関連）
- ~~**FR-011**: ノードはWindows上でGUIアプリケーションとして動作する必要がある~~ → **変更**: CLIベース実装
- ~~**FR-012**: ノードは起動時にシステムトレイに常駐し、アイコンを表示する必要がある~~ → **削除**
- ~~**FR-013**: ノードはシステムトレイアイコンから設定ウィンドウを開くことができる必要がある~~ → **削除**
- ~~**FR-014**: ノード設定ウィンドウは、ルーターのURL、自動起動設定、接続状態を表示・変更できる必要がある~~ → **変更**: WebUI（SPEC-712c20cf）で提供
- ~~**FR-021**: ノードはWindows起動時に自動起動できる必要がある（オプション設定可能）~~ → **変更**: systemd/launchd/Task Schedulerで設定

##### 維持された要件（CLIノード）
- **FR-015**: ノードは起動時または設定変更時に、ルーターに自己登録リクエストを送信する必要がある（✅ 実装済み）
- **FR-016a**: ノードは起動時にOllamaの存在を確認する必要がある（✅ 実装済み）
- **FR-016b**: ノードはOllamaが未インストールの場合、自動的にダウンロードする必要がある（✅ 実装済み: `download()`）
- **FR-016c**: ノードはダウンロードしたOllamaを自動的にインストールする必要がある（✅ 実装済み: `download()`）
- **FR-016d**: ノードはOllamaバイナリとモデルのダウンロード進捗をユーザーに表示する必要がある（✅ 実装済み: `ProgressBar`, `DownloadProgress`、`download()`と`pull_model()`に統合）
- **FR-016e**: ノードはネットワークエラー時に指数バックオフによる自動リトライを実行する必要がある（✅ 実装済み: `retry_http_request()`、`download()`と`pull_model()`に統合）
- **FR-016f**: ノードはダウンロードしたバイナリの整合性をSHA256チェックサムで検証する必要がある（✅ 実装済み: `verify_checksum()`, 環境変数 `OLLAMA_VERIFY_CHECKSUM`）
- **FR-016g**: ノードはHTTP/HTTPSプロキシ経由でのダウンロードをサポートする必要がある（✅ 実装済み: `build_http_client_with_proxy()`、環境変数 `HTTP_PROXY`/`HTTPS_PROXY`/`NO_PROXY`）
- **FR-016h**: ノードはデフォルトモデルをメモリ容量に応じて自動選択してプルする必要がある（✅ 実装済み: `ensure_default_model()`）
- **FR-016i**: ノードは既存のOllamaインストールと競合しない専用ディレクトリにOllamaをインストールする必要がある（✅ 実装済み: `get_ollama_directory()`）
- **FR-017**: ノードはOllamaが停止している場合、自動的に起動する必要がある（✅ 実装済み: `ensure_running()`）
- **FR-018**: ノードはローカルOllamaインスタンスの稼働状況を常時監視する必要がある（✅ 実装済み）
- **FR-019**: ノードは定期的にルーターにヘルスチェック情報（CPU使用率、メモリ使用率、処理中リクエスト数）を送信する必要がある（✅ 実装済み）
- **FR-020**: ~~ノードはルーターからのリクエストをローカルOllamaインスタンスに転送し、レスポンスを返す必要がある~~ → **変更**: ルーターが直接ノードのOllamaにリクエスト送信（SPEC-63acef08）
- **FR-022**: ノードはルーターと同一マシン上で動作可能である必要がある（✅ 実装済み）

### 主要エンティティ

- **ルーター**: 中央管理サーバー。複数のノードを管理し、リクエストを振り分け、ダッシュボードを提供する。属性: URL、ポート番号、登録ノード数、稼働時間。
- **ノード**: 各マシン上で動作するクライアントアプリケーション。ローカルOllamaインスタンスを管理し、ルーターに登録する。属性: マシン名、IPアドレス、Ollamaバージョン、状態（オンライン/オフライン）、最終ヘルスチェック時刻。
- **Ollamaインスタンス**: 各マシン上で動作するLLMランタイム。HTTP APIを提供し、ノード経由でリクエストを受け取る。属性: ポート番号、バージョン、利用可能モデル一覧。
- **リクエスト**: クライアントからルーターへ送信されるOllama API呼び出し。属性: リクエストID、タイムスタンプ、振り分け先ノード、処理時間、ステータス（処理中/完了/エラー）。

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- ノード認証・認可機能（現バージョンではルーターURLを知っていれば誰でも登録可能）
- ルーターの高可用性構成（複数ルーターのクラスタリング）
- ユーザーごとのリクエスト管理・割り当て制御
- モデル別のルーティング（特定のモデルを持つノードへの優先割り当て）
- リクエストキューイングと優先度制御
- 詳細なパフォーマンスメトリクス（レイテンシ分布、スループット、エラーレート）
- ルーター・ノード間の暗号化通信（TLS/SSL）
- ~~Linux/macOS対応（現バージョンはWindows専用）~~ → **変更**: Windows 10+/macOS 12+対応済み
- ノードのリモート設定変更（ルーター側からのWebUI経由設定）

---

## 技術制約 *(該当する場合)*

### プラットフォーム要件
- **ルーター**: Linux / Windows 10+ / macOS 12+
- **ノード**: Windows 10+ / macOS 12+（CLIアプリケーション）
- **ランタイム**: Rustバイナリ（追加ランタイム不要）

### Ollama管理
- **Ollamaは自動ダウンロード・自動起動されるため、ユーザーによる事前インストールは不要**（✅ 実装済み）
  - Ollamaバイナリの自動ダウンロード・インストール機能実装済み（`ollama.rs:download()`）
  - デフォルトモデルの自動プル機能実装済み（メモリ容量に応じた最適モデル選択）
  - Ollama自動ダウンロード機能強化完了:
    - ✅ ダウンロード進捗表示（FR-016d: indicatifプログレスバー）
    - ✅ ネットワークエラー時の自動リトライ（FR-016e: 指数バックオフ、環境変数設定可能）
    - ✅ SHA256チェックサム検証（FR-016f: 環境変数 `OLLAMA_VERIFY_CHECKSUM`で有効化）
    - ✅ プロキシ対応（FR-016g: HTTP_PROXY/HTTPS_PROXY/NO_PROXY自動認識）

### ネットワーク要件
- ノードとルーター間でHTTP/HTTPS通信が可能である必要がある
- ポート要件: ルーターはデフォルトでポート8080、Ollamaはデフォルトでポート11434を使用

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- **Ollama**: 各ノードマシンにインストール済みであることを推奨（自動起動機能あり）
- **ネットワーク**: ノードとルーター間のHTTP/HTTPS通信が許可されている（ファイアウォール設定が適切である）
- ~~Windows環境でGUIアプリケーションの実行が許可されている~~ → **削除**: CLIアプリケーション
- **ノード設定**: WebUI（ダッシュボード）へのアクセス、または環境変数`ROUTER_URL`での設定

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- **Ollama**: ローカルLLMランタイム。ノードによって自動ダウンロード・起動され、各ノードマシン上で動作し、HTTP API（デフォルト: `http://localhost:11434`）を提供する。ユーザーによる手動インストール・起動は不要。
- **Webブラウザ**: ダッシュボード表示のため、モダンなWebブラウザ（Chrome、Edge、Firefox等）が必要。

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. **Ollama自動管理**（✅ 実装済み）: Ollamaが未インストールの状態でノードを起動した場合、自動的にOllamaがダウンロード・インストール・起動され、ユーザーによる手動操作なしにルーターに登録される
2. **ノード登録の即座性**: ノードが起動してからルーターに登録されるまでの時間が5秒以内である（Ollamaが既にインストールされている場合）
3. **リクエスト振り分けの均等性**: 10個のリクエストを送信した場合、3台のノードがそれぞれ2〜5個のリクエストを処理する（完全に均等ではないが大きな偏りがない）
4. **障害検知の迅速性**: ノードがオフラインになってから60秒以内にルーターが検知し、リクエスト振り分けから除外する
5. **ダッシュボードのリアルタイム性**: ノードの状態変化（オンライン↔オフライン）がダッシュボード上で10秒以内に反映される
6. **システムの安定性**: ルーターが24時間連続稼働し、ノードの登録・解除、リクエスト処理を問題なく継続できる
7. **ユーザビリティ**: 技術者でないユーザーが、設定ウィンドウでルーターURLを入力するだけでノードを登録できる
8. **同一マシン動作**: ルーターとノードが同一マシン上で動作し、localhostとして正常に認識・処理される
9. **ダウンロード進捗の可視性**（✅ 実装済み）: Ollamaバイナリまたはモデルのダウンロード中、進捗率（パーセンテージ）とダウンロード速度がリアルタイムで表示される（FR-016d、indicatifライブラリ使用）
10. **ダウンロード失敗時の自動復旧**（✅ 実装済み）: ネットワークエラーでダウンロードが失敗した場合、指数バックオフ（1秒 → 2秒 → 4秒...最大60秒）で最大5回まで自動リトライされる（FR-016e、retry_http_request関数）
11. **バイナリの整合性保証**（✅ 実装済み）: ダウンロードしたOllamaバイナリのSHA256チェックサムが公式ハッシュと一致することが検証され、不一致の場合はエラーとして報告される（FR-016f、verify_checksum関数）
12. **プロキシ環境での動作**（✅ 実装済み）: 環境変数`HTTP_PROXY`/`HTTPS_PROXY`が設定されている環境で、プロキシ経由でOllamaバイナリとモデルが正常にダウンロードされる（FR-016g、reqwestのプロキシサポート）
13. **リリース配布形式の整合性**: GitHubリリースに添付される配布物は、Unix系プラットフォーム向けを`.tar.gz`、Windows向けを`.zip`で提供し、それぞれにCoordinator/Agentバイナリと最低限 `README.md` / `README.ja.md` / `LICENSE` が同梱されている（追加ドキュメントを含める場合はリリースノートで明示する）
14. **リリースタイミングの統制**: バイナリ配布用ワークフローは`main`ブランチにマージ済みのコミットだけを対象とし、その他のブランチでトリガーされた場合はエラーとして停止する
15. **プラットフォームインストーラー**: macOS `.pkg` と Windows `.msi` で Router インストーラーを提供し、`or-router-*` の命名規則に従うこと（Node は C++ 実装 `node/` ディレクトリに配置、llama.cpp統合実装完了）

---

## ⚡ クイックガイドライン

- ✅ ユーザーが「何を」必要とし「なぜ」必要なのかに焦点を当てる
- ❌ 「どのように」実装するかを避ける (技術スタック、API、コード構造なし)
- 👥 ビジネス関係者向けに記述 (開発者向けではない)
