# 機能仕様書: GPU必須エージェント登録要件

**機能ID**: `SPEC-5cd7b614`
**作成日**: 2025-11-01
**ステータス**: 下書き
**入力**: ユーザー説明: "GPUが必須のエージェント登録要件を実装する。GPUを持たないエージェントは登録を403 Forbiddenで拒否し、既存のGPUなしエージェントはコーディネーター起動時にデータベースから自動削除する。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - GPUを持つエージェントのみ登録可能 (優先度: P1)

Ollamaコーディネーターを利用する運用管理者として、GPU搭載マシンで動作しているエージェントのみをシステムに登録したい。GPUがないエージェントからの登録試行は明確に拒否され、システムにGPU非搭載エージェントが混入しないことを保証する必要がある。

**この優先度の理由**: OllamaはGPUを使用してモデル推論を行うため、GPUなしのエージェントは実用的な性能を提供できません。GPUなしエージェントの登録を防ぐことで、システム全体の品質と性能を保証できます。

**独立テスト**: GPU搭載エージェントの登録試行とGPU非搭載エージェントの登録試行を実行し、前者が成功し後者が拒否されることで完全にテスト可能です。

**受け入れシナリオ**:

1. **前提** GPU搭載マシンでエージェントが起動している、**実行** コーディネーターへ登録リクエストを送信、**結果** 登録が成功し、エージェントがダッシュボードに表示される
2. **前提** GPU非搭載マシンでエージェントが起動している、**実行** コーディネーターへ登録リクエストを送信、**結果** 登録が拒否され、「GPUが必要です」というメッセージが返される
3. **前提** GPU情報を送信しないエージェントが登録を試みる、**実行** コーディネーターへ登録リクエストを送信、**結果** 登録が拒否される

---

### ユーザーストーリー2 - 既存GPUなしエージェントの自動削除 (優先度: P2)

Ollamaコーディネーターの運用管理者として、コーディネーターを起動したときに、過去に登録されたGPU非搭載エージェントが自動的にシステムから削除されることを期待する。これにより、システムアップグレード後も一貫性のあるエージェント群を維持できる。

**この優先度の理由**: 既存環境からのマイグレーションやシステムアップグレード時に、古いGPU非搭配エージェントが残っている可能性があります。これらを自動削除することで、運用管理者が手動でクリーンアップする必要がなくなります。

**独立テスト**: データベースにGPU情報のないエージェントを事前に登録しておき、コーディネーターを再起動後、それらが削除されていることで独立してテスト可能です。

**受け入れシナリオ**:

1. **前提** データベースにGPU情報なしのエージェントが3件登録されている、**実行** コーディネーターを起動、**結果** 起動後、GPU情報なしのエージェントが自動的に削除され、ダッシュボードに表示されない
2. **前提** データベースにGPU搭載エージェント5件とGPU非搭載エージェント2件が混在している、**実行** コーディネーターを起動、**結果** GPU搭載エージェント5件のみが残り、GPU非搭載エージェント2件は削除される
3. **前提** データベースにGPU搭載エージェントのみが登録されている、**実行** コーディネーターを起動、**結果** すべてのエージェントが保持され、削除されない

---

### ユーザーストーリー3 - GPU情報のダッシュボード表示 (優先度: P3)

コーディネーターのダッシュボードを閲覧する運用管理者として、各エージェントのGPU情報（モデル名、個数）を一目で確認したい。これにより、システム全体のGPUリソースを把握できる。

**この優先度の理由**: エージェントがGPUを持つことが保証されているため、どのようなGPUが利用可能かを可視化することで、リソース配分やキャパシティプランニングに役立ちます。

**独立テスト**: 異なるGPUモデルを持つエージェントを登録し、ダッシュボードで各エージェントのGPU情報が正しく表示されることで独立してテスト可能です。

**受け入れシナリオ**:

1. **前提** NVIDIA RTX 4090を1枚搭載したエージェントが登録されている、**実行** ダッシュボードを開く、**結果** エージェント詳細に「GPU: NVIDIA RTX 4090 (1枚)」と表示される
2. **前提** Apple M3 Maxチップ搭載Macでエージェントが登録されている、**実行** ダッシュボードを開く、**結果** エージェント詳細に「GPU: Apple M3 Max」と表示される
3. **前提** AMD Radeon RX 7900 XTを1枚搭載したエージェントが登録されている、**実行** ダッシュボードを開く、**結果** エージェント詳細に「GPU: AMD Radeon RX 7900 XT (1枚)」と表示される
4. **前提** 複数の異なるGPUモデルを持つエージェントが登録されている、**実行** ダッシュボードを開く、**結果** 各エージェントのGPU情報が個別に正しく表示される

---

### ユーザーストーリー4 - GPU能力スコアの表示 (優先度: P3)

コーディネーターのダッシュボードを閲覧する運用管理者として、各エージェントのGPU性能を定量的に比較したい。GPU能力スコア（0-10000の数値）をダッシュボードで確認することで、リソース配分の意思決定を迅速に行える。

**この優先度の理由**: GPU能力スコアはGPUモデル名だけでは分かりにくい性能差を数値化し、運用管理者がどのエージェントが最も高性能かを一目で把握できるようにします。リソース配分やワークロード振り分けの意思決定に役立ちます。

**独立テスト**: 異なる性能のGPUを持つ複数のエージェントを登録し、ダッシュボードで各エージェントのGPU能力スコアが正しく表示され、スコアの大小関係が実際の性能と一致することで独立してテスト可能です。

**受け入れシナリオ**:

1. **前提** NVIDIA RTX 4090搭載エージェント（スコア約9850）が登録されている、**実行** エージェント一覧を開く、**結果** GPU使用率の横に「スコア 9850」と表示される
2. **前提** NVIDIA RTX 3080搭載エージェント（スコア約9170）が登録されている、**実行** エージェント詳細モーダルを開く、**結果** GPU能力スコア「9170」、GPUモデル「NVIDIA GeForce RTX 3080」、GPU Compute「8.6」が表示される
3. **前提** 複数の異なるGPU性能を持つエージェントが登録されている、**実行** エージェント一覧を開く、**結果** スコアの高い順（RTX 4090 > RTX 3080 > GTX 1660）に性能差が明確に確認できる
4. **前提** GPU能力情報が取得できないエージェント（AMD/Apple Silicon）が登録されている、**実行** エージェント一覧を開く、**結果** GPU能力スコア欄に「-」と表示され、エラーにならない

---

### エッジケース

- GPU検出が一時的に失敗した場合（ドライバーの問題など）、どう扱うか？→ GPU情報が取得できない場合は登録を拒否する
- エージェントが起動後にGPUを失った場合（ハードウェア障害など）、どう扱うか？→ 既に登録済みのエージェントは維持されるが、次回ヘルスチェックで検出可能
- GPUモデル名が取得できない場合でも、GPU自体は存在する場合、どう扱うか？→ GPUの存在が確認できれば登録を許可し、モデル名は「不明」として表示

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはエージェント登録時にGPUの有無を確認する必要がある
- **FR-002**: システムはGPUを持たないエージェントからの登録リクエストを拒否する必要がある
- **FR-003**: システムは登録拒否時に「403 Forbidden」ステータスと明確なエラーメッセージを返す必要がある
- **FR-004**: システムはコーディネーター起動時に既存のGPU非搭載エージェントをデータベースから自動削除する必要がある
- **FR-005**: システムは各エージェントのGPU情報（モデル名、個数）を保存する必要がある
- **FR-006**: ダッシュボードは各エージェントのGPU情報を表示する必要がある
- **FR-007**: エージェントはGPU情報を自動検出して登録リクエストに含める必要がある
- **FR-008**: システムはNVIDIA GPUの能力スコア（0-10000の数値）を計算して保存する必要がある
- **FR-009**: ダッシュボードはエージェント一覧と詳細モーダルでGPU能力スコアを表示する必要がある
- **FR-010**: GPU能力スコアはメモリ容量、クロック速度、Compute Capabilityに基づいて算出される必要がある

### 主要エンティティ

- **エージェント**: Ollamaを実行するマシン。GPU搭載が必須要件。GPU情報（有無、モデル名、個数、能力スコア、Compute Capability）を持つ。
- **登録リクエスト**: エージェントがコーディネーターに送信する登録情報。GPU情報とGPU能力情報を含む必要がある。
- **GPU能力スコア**: GPUのハードウェア性能を0-10000の数値で表す指標。メモリ容量、最大クロック速度、CUDA Compute Capabilityから計算される。NVIDIA GPUのみ対応。

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- GPUメモリ容量の確認と最小要件の設定
- 特定のGPUモデルのホワイトリスト/ブラックリスト
- GPU使用率のリアルタイム監視とアラート
- GPUが一時的に利用不可になったエージェントの自動一時停止機能

---

## 技術制約 *(該当する場合)*

- 以下のGPUベンダーをサポート:
  - **NVIDIA GPU**: NVML (NVIDIA Management Library) 経由で検出、またはデバイスファイル (`/dev/nvidia0`) で検出
  - **Apple Silicon**: Metal API、`lscpu`コマンド、または `/proc/cpuinfo` で検出 (M1/M2/M3/M4シリーズ)
  - **AMD GPU**: sysfs KFD Topology (`/sys/class/kfd/kfd/topology/nodes`) で検出（Linuxのみ）
  - **Intel GPU**: sysinfo経由で検出（Linuxのみ）
- Linux、Windows、macOS環境でのGPU検出をサポート
- **Docker for Mac対応**: Linuxコンテナ内でもApple Siliconを自動検出（`lscpu`と`/proc/cpuinfo`を使用）
- GPUベンダー検出の優先順位: 環境変数 → NVIDIA → AMD → Apple Silicon

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- エージェントマシンに何らかのGPU（NVIDIA/Apple/AMD/Intel）が搭載されている
- 該当するGPUドライバーがインストールされている
  - NVIDIA: NVIDIA GPU Driver + CUDA Toolkit
  - Apple Silicon: macOS標準（Metal API）
  - AMD: ROCm Driver（Linuxの場合）
  - Intel: Intel GPU Driver
- OllamaがGPUを利用する設定になっている

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- 各GPUベンダーのドライバーとツールキット
  - NVIDIA: CUDA Toolkit / NVML
  - Apple: Metal Framework (macOS標準)
  - AMD: ROCm (Linuxのみ)
  - Intel: Intel GPU Driver
- エージェント・コーディネーター間の通信プロトコル
- データベースストレージ機能

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. GPU非搭載エージェントの登録試行が100%拒否される
2. コーディネーター起動時、既存のGPU非搭載エージェントが自動的に削除される
3. ダッシュボードで各エージェントのGPU情報（モデル名、個数）が正しく表示される
4. GPU搭載エージェントの登録成功率が99%以上（GPU検出の信頼性）
5. 登録拒否時、運用管理者が理由を明確に理解できるエラーメッセージが表示される
6. NVIDIA GPUエージェントのGPU能力スコアがダッシュボードに表示される
7. GPU能力スコアが実際のGPU性能の大小関係を正しく反映している（例: RTX 4090 > RTX 3080 > GTX 1660）
8. GPU能力情報が取得できないエージェント（AMD/Apple Silicon）でもエラーにならず、「-」と表示される

---

## ⚡ クイックガイドライン

- ✅ ユーザーが「何を」必要とし「なぜ」必要なのかに焦点を当てる
- ❌ 「どのように」実装するかを避ける (技術スタック、API、コード構造なし)
- 👥 ビジネス関係者向けに記述 (開発者向けではない)
