# タスク一覧: ノード自己登録システム

**機能ID**: `SPEC-94621a1f`
**ステータス**: ✅ すべて完了
**完了日**: 2025-10-30 (PR #1)
**依存SPEC**: なし（基盤機能）

## 追加要件（2025-11-01更新）
- ノード登録時の `machine_name` は環境変数 `OLLAMA_AGENT_MACHINE_NAME`（未設定の場合は `OLLAMA_MACHINE_NAME` / `HOSTNAME`）を優先し、ホスト固有名を反映できること。
- Coordinatorへの登録が失敗した場合は所定の間隔で自動再試行し、成功するまで継続できること（環境変数で間隔／試行回数を調整可能）。

## 本日のToDo (2025-11-12)

- [x] **T701** SPECを更新し、Windows/macOSでのシステムトレイ常駐とダッシュボード起動要件を明文化する
- [x] **T702** ノード起動フローにシステムトレイ実装を組み込み、CLI/GUIのハイブリッド起動を実装する
- [x] **T703** READMEなどユーザードキュメントと検証手順を更新し、新機能の動作確認を行う

---

## Phase 1: セットアップ ✅ (完了)

### S001: Cargoワークスペース構成 ✅
- **説明**: Cargo.tomlでワークスペース構成
- **詳細**:
  - common, coordinator, agentの3つのクレート
  - 共通依存関係の管理
- **完了条件**: `cargo build`が成功
- **実行時間**: 10分
- **コミット**: 初期コミット
- **ステータス**: ✅ 完了

### S002: 依存関係追加 ✅
- **説明**: Cargo.tomlに必要な依存関係を追加
- **詳細**:
  - axum, tokio, serde, uuid, chrono
  - tower-http（CORS、ロギング）
- **完了条件**: コンパイル成功
- **実行時間**: 5分
- **コミット**: 初期コミット
- **ステータス**: ✅ 完了

---

## Phase 2: 共通型定義 ✅ (完了)

### C001: Agent構造体定義 ✅
- **説明**: `common/src/types.rs`にAgent構造体定義
- **詳細**:
  - id, machine_name, ip_address, status, etc.
  - AgentStatus列挙型（Online/Offline）
  - SystemInfo構造体
- **完了条件**: コンパイル成功
- **実行時間**: 15分
- **コミット**: feat: Agent構造体定義
- **ステータス**: ✅ 完了

### C002: RegisterRequest構造体定義 ✅
- **説明**: ノード登録リクエストの型定義
- **詳細**: machine_name, ip_address, ollama_version, system_info
- **完了条件**: コンパイル成功
- **実行時間**: 5分
- **コミット**: feat: RegisterRequest定義
- **ステータス**: ✅ 完了

---

## Phase 3: ストレージ実装 (TDD) ✅ (完了)

### D001: ストレージモジュール作成 ✅
- **説明**: `coordinator/src/db/mod.rs`作成
- **完了条件**: コンパイル成功
- **実行時間**: 5分
- **コミット**: feat: ストレージモジュール作成
- **ステータス**: ✅ 完了

### D002: ストレージテスト作成 (RED) ✅
- **説明**: test_save_and_load作成
- **完了条件**: テスト失敗を確認
- **実行時間**: 10分
- **コミット**: test: ストレージテスト追加
- **ステータス**: ✅ 完了

### D003: JSONファイルストレージ実装 (GREEN) ✅
- **説明**: `~/.llm-router/agents.json`に保存/読み込み
- **詳細**:
  - save_agents(): Vec<Agent>をJSONで保存
  - load_agents(): ファイルから読み込み
  - ディレクトリ自動作成
- **完了条件**: テスト合格
- **実行時間**: 30分
- **コミット**: feat: JSONストレージ実装
- **ステータス**: ✅ 完了

---

## Phase 4: レジストリ実装 ✅ (完了)

### R001: AgentRegistryモジュール作成 ✅
- **説明**: `coordinator/src/registry/mod.rs`作成
- **詳細**: Arc<RwLock<HashMap<Uuid, Agent>>>で管理
- **完了条件**: コンパイル成功
- **実行時間**: 10分
- **コミット**: feat: AgentRegistry作成
- **ステータス**: ✅ 完了

### R002: register_agentメソッド実装 ✅
- **説明**: ノード登録ロジック
- **詳細**:
  - UUID生成
  - タイムスタンプ設定
  - Registryに追加
  - ストレージに保存
- **完了条件**: コンパイル成功
- **実行時間**: 20分
- **コミット**: feat: register_agent実装
- **ステータス**: ✅ 完了

### R003: list_allメソッド実装 ✅
- **説明**: 全ノード一覧取得
- **完了条件**: Vec<Agent>を返却
- **実行時間**: 10分
- **コミット**: feat: list_all実装
- **ステータス**: ✅ 完了

### R004: get_by_idメソッド実装 ✅
- **説明**: ID指定でノード取得
- **完了条件**: Option<Agent>を返却
- **実行時間**: 10分
- **コミット**: feat: get_by_id実装
- **ステータス**: ✅ 完了

### R005: update_heartbeatメソッド実装 ✅
- **説明**: ハートビート受信時の処理
- **詳細**:
  - last_seenを更新
  - statusをOnlineに設定
  - ストレージに保存
- **完了条件**: コンパイル成功
- **実行時間**: 15分
- **コミット**: feat: update_heartbeat実装
- **ステータス**: ✅ 完了

---

## Phase 5: API実装 (TDD) ✅ (完了)

### A001: APIモジュール作成 ✅
- **説明**: `coordinator/src/api/mod.rs`および`agent.rs`作成
- **完了条件**: コンパイル成功
- **実行時間**: 5分
- **コミット**: feat: APIモジュール作成
- **ステータス**: ✅ 完了

### A002: 登録APIテスト作成 (RED) ✅
- **説明**: test_register_agent作成
- **完了条件**: テスト失敗を確認
- **実行時間**: 15分
- **コミット**: test: 登録APIテスト追加
- **ステータス**: ✅ 完了

### A003: 登録API実装 (GREEN) ✅
- **説明**: `POST /api/agents/register`実装
- **詳細**:
  - リクエストボディの検証
  - AgentRegistry::register_agent呼び出し
  - レスポンス生成（id, status）
- **完了条件**: テスト合格
- **実行時間**: 30分
- **コミット**: feat: 登録API実装
- **ステータス**: ✅ 完了

### A004: 一覧APIテスト作成 (RED) ✅
- **説明**: test_list_agents作成
- **完了条件**: テスト失敗を確認
- **実行時間**: 10分
- **コミット**: test: 一覧APIテスト追加
- **ステータス**: ✅ 完了

### A005: 一覧API実装 (GREEN) ✅
- **説明**: `GET /api/agents`実装
- **詳細**: AgentRegistry::list_all呼び出し、JSON配列で返却
- **完了条件**: テスト合格
- **実行時間**: 20分
- **コミット**: feat: 一覧API実装
- **ステータス**: ✅ 完了

### A006: ハートビートAPIテスト作成 (RED) ✅
- **説明**: test_heartbeat作成
- **完了条件**: テスト失敗を確認
- **実行時間**: 10分
- **コミット**: test: ハートビートAPIテスト追加
- **ステータス**: ✅ 完了

### A007: ハートビートAPI実装 (GREEN) ✅
- **説明**: `POST /api/agents/:id/heartbeat`実装
- **詳細**:
  - ノードIDの検証
  - AgentRegistry::update_heartbeat呼び出し
  - 200 OK返却
- **完了条件**: テスト合格
- **実行時間**: 20分
- **コミット**: feat: ハートビートAPI実装
- **ステータス**: ✅ 完了

---

## Phase 6: 統合 ✅ (完了)

### I001: main.rsでルーティング設定 ✅
- **説明**: Axumルーターでエンドポイント登録
- **詳細**:
  - `/api/agents/register` → register_agent
  - `/api/agents` → list_agents
  - `/api/agents/:id/heartbeat` → heartbeat
- **完了条件**: `cargo run`で起動成功
- **実行時間**: 20分
- **コミット**: feat: ルーティング設定
- **ステータス**: ✅ 完了

### I002: AgentRegistry初期化 ✅
- **説明**: main.rsでAgentRegistry初期化
- **詳細**:
  - ストレージから既存データ読み込み
  - Arc<AgentRegistry>でシェアステート作成
- **完了条件**: 起動時にデータ読み込み成功
- **実行時間**: 15分
- **コミット**: feat: Registry初期化
- **ステータス**: ✅ 完了

### I003: CORS設定 ✅
- **説明**: CORSミドルウェア追加
- **詳細**: tower-httpのCorsLayerを使用
- **完了条件**: クロスオリジンリクエスト成功
- **実行時間**: 10分
- **コミット**: feat: CORS設定
- **ステータス**: ✅ 完了

### I004: ロギング設定 ✅
- **説明**: tracingクレートでロギング設定
- **詳細**: EnvFilterでログレベル制御
- **完了条件**: ログが出力される
- **実行時間**: 15分
- **コミット**: feat: ロギング設定
- **ステータス**: ✅ 完了

---

## Phase 7: バグ修正 ✅ (完了)

### B001: clippy警告修正 ✅
- **説明**: `cargo clippy`の警告を修正
- **詳細**:
  - 未使用の変数削除
  - 不要なクローン削除
  - 型推論の改善
- **完了条件**: clippy警告ゼロ
- **実行時間**: 30分
- **コミット**: fix: clippy警告修正
- **ステータス**: ✅ 完了

### B002: SQLite→JSON移行 ✅
- **説明**: ストレージをSQLiteからJSONファイルに変更
- **理由**: シンプルさの追求（CLAUDE.md原則）
- **詳細**:
  - SQLiteコード削除
  - JSONファイルI/O実装
- **完了条件**: 全テスト合格
- **実行時間**: 1時間
- **コミット**: fix: SQLiteをJSONファイルストレージに置き換え
- **ステータス**: ✅ 完了

### B003: await_holding_lock警告修正 ✅
- **説明**: tokio::sync::Mutexを使用してawait_holding_lock警告修正
- **完了条件**: clippy警告ゼロ
- **実行時間**: 30分
- **コミット**: fix: await_holding_lock警告を修正（tokio::sync::Mutexを使用）
- **ステータス**: ✅ 完了

### B004: cargo fmt実行 ✅
- **説明**: コードフォーマット統一
- **完了条件**: `cargo fmt --check`が成功
- **実行時間**: 5分
- **コミット**: style: cargo fmtでフォーマット修正
- **ステータス**: ✅ 完了

---

## 統計

- **総タスク数**: 30
- **完了タスク数**: 30 (100%)
- **総開発時間**: 約8時間
- **テストカバレッジ**: 全機能
- **コミット数**: 約30

## レッスン

### うまくいったこと ✅
1. TDDサイクルの厳守により、バグが少ない実装が可能
2. JSONファイルストレージによるシンプルな設計
3. Arc<RwLock<T>>による効率的な状態管理
4. Axumの型安全なルーティング

### 改善点 🔄
1. 初期実装でSQLiteを使用したが、過剰だった → JSONに移行
2. await_holding_lock警告に気づくのが遅れた → tokio::sync::Mutex使用
3. clippy警告の早期対応が必要

## 依存関係

**前提タスク**:
- なし（基盤機能）

**後続SPEC**:
- SPEC-63acef08: ノード情報を使用したプロキシ機能
- SPEC-443acc8c: ハートビート機能を使用したヘルスチェック
- SPEC-589f2df1: ノード選択を使用したロードバランシング
- SPEC-712c20cf: ノード情報を使用した管理ダッシュボード
