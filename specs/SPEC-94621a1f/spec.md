# 機能仕様書: エージェント自己登録システム

**機能ID**: `SPEC-94621a1f`
**作成日**: 2025-10-30
**ステータス**: 実装済み
**元のSPEC**: SPEC-32e2b31a から分割

## 概要

各マシンでエージェントアプリケーションを起動し、コーディネーターに自動的に登録される機能。エージェントはコーディネーターとの接続状態を管理し、ハートビートを送信する。

## ユーザーシナリオ＆テスト

### ユーザーストーリー - エージェントの自己登録と接続管理

ユーザーは各マシンでエージェントアプリケーションを起動し、コーディネーターに自動的に登録される。Windows / macOS 環境ではエージェントがシステムトレイに常駐し、コーディネーターとの接続状態をリアルタイムで表示する。Linux では従来通り CLI 常駐プロセスとして動作する。

**この優先度の理由**: エージェント登録はシステムの基盤機能であり、これがなければ他のすべての機能が動作しない。最小限の機能で動作確認が可能。

**独立テスト**: エージェントを起動してコーディネーターのURLを設定し、登録が成功することで完全にテスト可能。コーディネーター側で登録されたエージェント一覧を確認できれば価値を提供する。

**受け入れシナリオ**:

1. **前提** エージェントアプリがインストールされていない、**実行** エージェントをインストールして起動する、**結果** システムトレイにアイコンが表示され、設定ウィンドウが自動的に開く
2. **前提** エージェントが起動している、**実行** 設定ウィンドウでコーディネーターのURL（例: `http://192.168.1.10:8080`）を入力して「接続」をクリックする、**結果** エージェントがコーディネーターに登録され、接続状態が「接続済み」と表示される
3. **前提** エージェントが登録されている、**実行** コーディネーターのダッシュボードを開く、**結果** 登録されたエージェントが一覧に表示され、マシン名、IPアドレス、Ollamaのバージョンが確認できる
4. **前提** エージェントが登録されている、**実行** エージェントアプリを終了する、**結果** コーディネーターのダッシュボードで該当エージェントが「オフライン」状態になる
5. **前提** コーディネーターをホストするマシンである、**実行** そのマシンでエージェントを起動する、**結果** 同一マシン上のコーディネーターに正常に登録され、localhostとして認識される
6. **前提** WindowsまたはmacOS上でエージェントを起動している、**実行** システムトレイアイコンをダブルクリックする、**結果** ローカル設定パネルがブラウザで開き、コーディネーターURLやポートなどを入力・保存できる（保存内容は次回起動時に反映）
7. **前提** CLI からエージェントを起動する、**実行** `COORDINATOR_URL=http://coordinator:8080 ./ollama-coordinator-agent` のように環境変数を指定する、**結果** 保存済み設定より優先して該当URLで登録が行われる

## エッジケース

- エージェントが複数のネットワークインターフェースを持つ場合、どのIPアドレスを登録に使用するか？
- コーディネーターが再起動された際、以前に登録されていたエージェントの情報は保持されるか？それとも再登録が必要か？
- エージェントとコーディネーター間のネットワークが不安定な場合、どのくらいの頻度で再接続を試みるか？

## 機能要件

### FR-001: エージェント登録API

コーディネーターは、エージェントからの登録リクエストを受け付けるREST APIを提供する。

- エンドポイント: `POST /api/agents/register`
- リクエストボディ: マシン名、IPアドレス、Ollamaバージョン、ポート番号
- レスポンス: 登録成功/失敗のステータスとエージェントID

### FR-002: エージェント一覧API

登録されたエージェントの一覧を取得するAPIを提供する。

- エンドポイント: `GET /api/agents`
- レスポンス: エージェントID、マシン名、IPアドレス、ステータス、最終確認時刻

### FR-003: ハートビート送信

エージェントは定期的にコーディネーターにハートビートを送信し、稼働状態を通知する。

- 送信間隔: 30秒ごと
- エンドポイント: `POST /api/agents/:id/heartbeat`
- タイムアウト: 60秒以内に応答がない場合はオフラインとみなす

### FR-004: データ永続化

コーディネーターは登録されたエージェント情報を永続化し、再起動後も情報を保持する。

- ストレージ: JSONファイル（`~/.ollama-coordinator/agents.json`）
- 起動時にデータを読み込み、メモリ上で管理

### FR-005: Windows/macOSシステムトレイ統合

- Windows 10 以降と macOS 12 以降では、エージェント起動と同時にシステムトレイ（メニューバー）へ常駐し、アイコンを表示する。
- トレイアイコンのダブルクリック、またはコンテキストメニューの「設定パネルを開く」を選択すると、ローカルでホストしている設定パネル (`http://127.0.0.1:<dynamic>/`) が開き、コーディネーターURLや監視間隔を編集できる。
- 「Dashboardを開く」から `COORDINATOR_URL/dashboard` に遷移でき、コンテキストメニューの「エージェントを終了」で常駐プロセスを停止できる。
- Linux など非対応プラットフォームでは従来のCLI常駐プロセス（トレイなし）として動作する。

### FR-006: 環境変数／設定パネルによる上書き

- エージェントのエントリーポイントは `COORDINATOR_URL`, `OLLAMA_PORT`, `AGENT_HEARTBEAT_INTERVAL_SECS` などの環境変数で設定を上書きできる。
- 同じ設定項目はローカル設定パネルからも編集でき、`~/.ollama-coordinator/agent-settings.json` に保存され、環境変数が未指定のときに適用される。

## 非機能要件

### NFR-001: パフォーマンス

- エージェント登録APIは100ms以内にレスポンスを返す
- 最大1000台のエージェントを同時に管理可能

### NFR-002: 可用性

- コーディネーターの再起動時、エージェント情報は失われない
- エージェントは接続失敗時、指数バックオフで再接続を試みる

### NFR-003: セキュリティ

- 現バージョンでは認証なし（将来的にAPIキーまたはトークンベース認証を追加予定）

## 実装状態

✅ **実装済み** (PR #1でマージ済み)

- エージェント登録API
- エージェント一覧API
- ハートビート機能
- JSONファイルベースの永続化
- 統合テスト
