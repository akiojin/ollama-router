# 機能仕様書: 統一APIプロキシ

**機能ID**: `SPEC-63acef08`
**作成日**: 2025-10-30
**ステータス**: 実装済み
**元のSPEC**: SPEC-32e2b31a から分割
**依存SPEC**: SPEC-94621a1f（ノード自己登録）

## 概要

複数のLLM runtimeインスタンスを統一して扱うプロキシ機能。ユーザーはルーターの単一エンドポイントを通じてLLM runtime APIにアクセスでき、ルーターが自動的に利用可能なノードにリクエストを振り分ける。

## ユーザーシナリオ＆テスト

### ユーザーストーリー - 統一APIエンドポイントによるLLM runtimeアクセス

ユーザーは複数のLLM runtimeインスタンスを意識せず、ルーターの単一エンドポイントを通じてLLM runtime APIにアクセスできる。ルーターは自動的に利用可能なノードにリクエストを振り分ける。

**この優先度の理由**: 複数のLLM runtimeインスタンスを統一して扱えることがこのシステムの中核的な価値。ノード登録が完了していれば独立して実装・テスト可能。

**独立テスト**: ルーターのエンドポイント（例: `http://coordinator:8080/api/chat`）に対してLLM runtime API形式のリクエストを送信し、正常にレスポンスが返ることで価値を提供する。

**受け入れシナリオ**:

1. **前提** 2台のノードが登録されている、**実行** ルーターのAPI（`POST /api/chat`）にチャットリクエストを送信する、**結果** いずれかのノードが処理し、LLMからのレスポンスが返される
2. **前提** 登録されたノードがない、**実行** ルーターのAPIにリクエストを送信する、**結果** 「利用可能なノードがありません」というエラーメッセージが返される
3. **前提** 1台のノードが登録されている、**実行** 同時に5つのリクエストを送信する、**結果** すべてのリクエストが同じノードで処理され、順次レスポンスが返される
4. **前提** 3台のノードが登録されている、**実行** 連続して9つのリクエストを送信する、**結果** リクエストが3台のノードに均等に分散され（各ノードが3リクエストずつ処理）、すべてレスポンスが返される

## 機能要件

### FR-005: LLM runtime APIプロキシ

ルーターはLLM runtime API互換のエンドポイントを提供し、リクエストを適切なノードに転送する。

- エンドポイント:
  - `POST /api/chat` - チャット完了リクエスト
  - `POST /api/generate` - テキスト生成リクエスト
- リクエスト形式: LLM runtime API互換
- レスポンス形式: LLM runtime API互換

### FR-006: ノード選択ロジック

利用可能なノードから、リクエストを処理するノードを選択する。

- 初期実装: ラウンドロビン方式
- オンライン状態のノードのみを選択対象とする
- ノードが存在しない場合はエラーを返す

### FR-007: リクエスト転送

選択されたノードにリクエストを転送し、レスポンスをクライアントに返す。

- HTTPプロキシとして動作
- ストリーミングレスポンスをサポート
- タイムアウト: 60秒

### FR-008: エラーハンドリング

ノードへのリクエスト転送が失敗した場合の処理。

- ノードが応答しない場合、エラーレスポンスを返す
- 将来的には他のノードへのフェイルオーバーを実装予定

## 非機能要件

### NFR-004: パフォーマンス

- プロキシのオーバーヘッドは50ms以内
- 同時に最大100個のリクエストを処理可能

### NFR-005: 互換性

- LLM runtime API v0.1.0以降と互換性を持つ
- 既存のLLM runtimeクライアントから透過的に利用可能

## 実装状態

✅ **実装済み** (PR #1でマージ済み)

- `/api/chat` プロキシエンドポイント
- `/api/generate` プロキシエンドポイント
- ラウンドロビン方式のノード選択
- HTTPリクエスト転送
- 統合テスト
