# 機能仕様書: 自動マージ機能の実装

**機能ID**: `SPEC-47c6f44c`
**作成日**: 2025-10-30
**ステータス**: ✅ 実装完了 (2025-10-30)
**入力**: ユーザー説明: "GitHub Actionsを使用して、全てのPRでGitHubの自動マージを自動的に有効化し、Requiredチェック合格時にGitHub自身がmainブランチへマージする仕組みを実装します。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - PR作成後の自動品質チェック (優先度: P1)

メンテナが用意した自動PR生成ワークフロー（`finish-feature` 系スクリプトやGitHub Actions手動トリガー）が起動すると、GitHub Actionsが自動的に品質チェック（テスト、lint、tasks完了確認、commitlint）を実行します。開発者はローカル環境を変更せず、結果を確認するだけで品質基準を把握できます。

**この優先度の理由**: 自動マージの前提条件として、品質チェックが必須です。これがないと、品質基準を満たさないコードがmainに入るリスクがあります。

**独立テスト**: メンテナがPR生成ワークフローを実行すると、GitHub Actionsが起動し、各チェック結果がPRページで確認できることをテストできます。

**受け入れシナリオ**:

1. **前提** メンテナが対象ブランチをレビュー済み、**実行** PR生成ワークフロー（`finish-feature` CI ジョブ等）を起動、**結果** GitHub Actionsで以下のチェックが並列実行される: tasks-check、Rustテスト（cargo test）、Rust lint（cargo fmt --check, cargo clippy）、commitlint、markdownlint
2. **前提** 未完了タスクが1つ存在（tasks.mdで`- [ ]`）、**実行** PR作成、**結果** tasks-checkジョブが失敗し、PRページに失敗理由が表示される
3. **前提** コミットメッセージが規約違反（例: プレフィックスなし）、**実行** PR作成、**結果** commitlintジョブが失敗し、どのコミットが規約違反かが表示される
4. **前提** すべてのチェックが合格、**実行** PR作成、**結果** 全ジョブが成功し、PRページに緑のチェックマークが表示される

---

### ユーザーストーリー2 - 品質チェック合格後の自動マージ設定 (優先度: P1)

メンテナが生成したPRがレビュー対象になると、Auto MergeワークフローがGraphQL APIを通じてGitHubの「自動マージを有効化」スイッチをONにします。実際のマージはGitHubのブランチ保護（Requiredチェック）に委ねられ、指定されたチェックが合格した瞬間にGitHubがMERGE方式でmainへ反映します。

**この優先度の理由**: メンテナが毎回「Enable auto-merge」ボタンを押す手間をなくし、Requiredチェックだけで安全にマージを完了できるようにするためです。

**独立テスト**: PR作成→Ready for review→Auto Mergeワークフロー完了後にPR画面で`Auto-merge: Enabled (MERGE)`と表示され、その後Requiredチェックが通過したときにGitHubが自動でmainにマージすることを検証できます。

**受け入れシナリオ**:

1. **前提** PRがオープンでDraftではない、**実行** Ready for review状態にする、**結果** Auto Mergeワークフローが起動し、PRに「Auto-merge enabled (MERGE)」が表示される
2. **前提** Auto-mergeが有効なPRでRequiredチェックが合格、**実行** 追加操作なし、**結果** GitHubが自動的にMERGEコミットをmainへ追加する
3. **前提** PRに新しいコミットをpush、**実行** ワークフローが再トリガされる、**結果** Auto-mergeが既に有効であることを検出して再設定をスキップする
4. **前提** PRが`CONFLICTING`状態、**実行** ワークフローが自動実行、**結果** Auto-mergeは有効化されず、ログにスキップ理由が表示される

---

### ユーザーストーリー3 - ドラフトPRの除外 (優先度: P2)

メンテナが作業途中のPRをドラフト状態で用意した場合でも、品質チェックは実行されますが、Auto MergeワークフローはGitHubの自動マージを有効化しません。Ready for reviewに切り替えられて初めて自動マージ設定が行われます。

**この優先度の理由**: 未完成のコードが誤ってauto-merge対象になることを避けるためです。

**独立テスト**: ドラフトPRを用意し、`Auto Merge`ワークフローがスキップされること、Ready for review後に自動マージが再度有効化されることを確認できます。

**受け入れシナリオ**:

1. **前提** ドラフトPRが存在、**実行** ワークフロー実行、**結果** ログに「PR is draft」のためスキップされたことが表示される
2. **前提** ドラフトPRで品質チェックが合格、**実行** Ready for reviewに変更、**結果** 次のトリガで自動マージが有効化される
3. **前提** Auto-mergeが有効化済みのPRを再びDraftに変更、**実行** GitHub UIでAuto-mergeが自動的にOFFになることを確認、**結果** Ready for reviewへ戻したタイミングでワークフローが再度有効化する

---

### ユーザーストーリー4 - commitlint設定 (優先度: P2)

開発者がコミットメッセージを作成する際、Conventional Commits準拠の形式（feat:, fix:, docs:など）が強制されます。これにより、コミット履歴が統一され、変更履歴の追跡が容易になります。

**この優先度の理由**: コード品質の一部ですが、既存のコミット履歴への影響があるため、P2としています。

**独立テスト**: 規約違反のコミットメッセージを含むPRを作成し、commitlintチェックが失敗することをテストできます。

**受け入れシナリオ**:

1. **前提** `.commitlintrc.json`が作成済み、**実行** 規約に準拠したコミット（例: `feat: 新機能追加`）でPR作成、**結果** commitlintチェックが合格する
2. **前提** `.commitlintrc.json`が作成済み、**実行** 規約違反のコミット（例: `新機能追加`、プレフィックスなし）でPR作成、**結果** commitlintチェックが失敗し、違反コミットのリストが表示される
3. **前提** 複数のコミットが存在、**実行** 1つでも規約違反があれば、**結果** commitlintチェックが失敗する
4. **前提** 日本語のコミットメッセージ（例: `feat: 新機能追加`）、**実行** PR作成、**結果** commitlintチェックが合格する（日本語サポート）

---

### エッジケース

- **同時に複数のPRが作成された場合**: 各PRは独立して品質チェックと自動マージが実行される。順序は保証されない。
- **品質チェック実行中にPRが更新された場合**: 新しいコミットがpushされた場合、品質チェックが再実行される。以前の実行は中断される。
- **mainブランチが保護されている場合**: GitHub Actionsに`contents: write`と`pull-requests: write`の権限が必要。権限がない場合、auto-mergeが失敗する。
- **GitHub Actions実行中にエラーが発生した場合**: 各チェックジョブは独立しているため、1つが失敗しても他のジョブは継続実行される。全体の結果は失敗扱い。
- **tasks.mdが存在しないまたは形式が異なる場合**: tasks-checkスクリプトがエラーを返し、品質チェックが失敗する。

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはPR作成時に自動的にGitHub Actionsワークフローを起動する必要がある
- **FR-002**: システムはtasks.mdの全タスク完了（`- [x]`形式）をチェックする必要がある。未完了タスク（`- [ ]`）が1つでもあれば失敗する
- **FR-003**: システムはRustプロジェクトのテスト（`cargo test --all-features --workspace`）を実行する必要がある
- **FR-004**: システムはRust lintチェック（`cargo fmt --all -- --check`と`cargo clippy --all-targets --all-features -- -D warnings`）を実行する必要がある
- **FR-005**: システムはコミットメッセージがConventional Commits準拠であることを検証する必要がある
- **FR-006**: システムはmarkdownlintを実行して、マークダウンファイルのスタイル違反を検出する必要がある
- **FR-007**: システムは品質チェックジョブを並列実行し、実行時間を最小化する必要がある
- **FR-008**: システムは`pull_request_target`イベントを監視し、開いていてDraftでないPRを対象に自動マージ有効化処理を実行する必要がある
- **FR-009**: システムは`mergeable`が`MERGEABLE`のときのみGitHub自動マージを有効化し、その他の状態では理由をログに出して終了する必要がある
- **FR-010**: 自動マージを有効化する際は`MERGE`方式を明示的に指定し、マージコミットで履歴を保持する必要がある
- **FR-011**: 既に自動マージが有効化済みのPRについては冪等的にスキップし、不要なGraphQLエラーを発生させない必要がある
- **FR-012**: ドラフトPRでは自動マージを有効化せず、Ready for reviewイベント後に再度自動マージ有効化を試行する必要がある

### 主要エンティティ

- **品質チェックワークフロー**: 5つの独立したジョブ（tasks-check, rust-test, rust-lint, commitlint, markdownlint）を並列実行し、全体の成功/失敗を判定
- **自動マージワークフロー**: 品質チェックワークフローの完了をトリガーとして起動し、PRの状態を検証してマージを実行
- **commitlint設定**: `.commitlintrc.json`ファイルで定義されたルール。Conventional Commits準拠を強制

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- PRへの自動コメント投稿（失敗理由の詳細な説明）
- PRラベルの自動付与（`needs-fix`, `tests-failing`など）
- Slackやメールによる通知
- カスタムチェックスクリプトの追加（ユーザー定義）
- 自動マージの承認フロー（レビュアー承認後のマージ）
- Unity C#テストの統合（現在はRustのみ）
- TypeScriptコンパイルチェックの統合

---

## 技術制約 *(該当する場合)*

- GitHub Actionsの`workflow_run`トリガーを使用するため、GitHub Enterpriseの一部バージョンでは動作しない可能性がある
- GitHub Actionsの実行時間制限（デフォルト6時間）内に品質チェックが完了する必要がある
- GitHub ActionsのデフォルトGITHUB_TOKENを使用するため、組織レベルの権限設定によっては動作しない可能性がある
- tasks.mdは`- [ ]` / `- [x]`形式を維持する必要がある（他の形式はサポート外）

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- GitHub CLIがメンテナ環境で認証済みである（`gh auth login`がCI またはメンテナ端末で実行済み）
- `.specify/scripts/checks/`以下のチェックスクリプトが正常に動作する
- `finish-feature.sh`スクリプトがCI／メンテナ環境で正常に動作し、PR作成が可能である
- Rustプロジェクトのビルド環境が正常に構成されている（`cargo`コマンドが利用可能）
- mainブランチへのpush権限がGitHub Actionsに付与されている

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- `.specify/scripts/bash/finish-feature.sh`: PR作成スクリプト
- `.specify/scripts/checks/check-tasks.sh`: tasks.md完了チェック
- `.specify/scripts/checks/check-tests.sh`: テスト実行スクリプト
- `.specify/scripts/checks/check-commits.sh`: commitlintチェック
- GitHub Actions: ワークフロー実行プラットフォーム
- GitHub GraphQL API: 自動マージ有効化API
- commitlint: コミットメッセージ検証ツール
- markdownlint: マークダウンファイルlintツール

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. **品質チェック自動実行**: PR作成から5分以内に全ての品質チェックが完了し、結果が確認できる
2. **自動マージ設定成功率**: オープンなPRの95%以上でGitHubの自動マージが自動的に有効化され、Requiredチェック合格時にGitHubがmainへMERGEコミットを追加できる状態になる（コンフリクトやドラフト除外を除く）
3. **TDD履歴保持**: 自動マージ後、featureブランチのTDDサイクルのコミット履歴がmainブランチで完全に保持される
4. **ドラフトPR除外**: ドラフトPRが100%自動マージから除外される
5. **commitlint準拠**: 規約違反のコミットメッセージを含むPRが100%品質チェックで失敗する
6. **並行開発対応**: 複数のPRが同時に作成された場合でも、各PRが独立して品質チェックと自動マージが実行される
