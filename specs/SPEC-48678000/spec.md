# 機能仕様書: モデル自動解決機能

**機能ID**: `SPEC-48678000`
**作成日**: 2025-12-06
**ステータス**: 下書き
**入力**: ユーザー説明: "モデル自動解決機能: モデルがローカルにない場合、1)共有パス（ルーター側キャッシュ）を直接参照、2)共有パスがアクセス不可ならルーターHTTP API経由でダウンロード、3)ルーターにもなければエラー。従来のauto_repair（破損検出・修復）機能は削除。Hugging Face直接ダウンロードは禁止。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 共有パスからの直接モデル利用 (優先度: P1)

ノードオペレーターとして、推論リクエストを受けた際にモデルがローカルにない場合、ルーター側で管理されている共有ストレージ上のモデルを直接利用できるようにしたい。これにより、各ノードにモデルをコピーする必要がなくなり、ストレージ効率が向上する。

**この優先度の理由**: 最も一般的なユースケースであり、ストレージ効率とモデル更新の即時反映という2つの重要なメリットを提供する。

**独立テスト**: 共有パスにモデルが存在する状態で推論リクエストを送信し、モデルがロードされて推論結果が返ることを確認することで完全にテストできる。

**受け入れシナリオ**:

1. **前提** ノードのローカルにモデルがなく、共有パスにモデルが存在する、**実行** 推論リクエストを送信、**結果** 共有パスからモデルが直接ロードされ、推論結果が返る

2. **前提** 共有パスのモデルが更新された、**実行** 次の推論リクエストを送信、**結果** 更新されたモデルが使用される（ノード側でコピー不要）

---

### ユーザーストーリー2 - ルーターAPI経由でのモデル取得 (優先度: P2)

ノードオペレーターとして、共有パスにアクセスできない環境でも、ルーターのHTTP API経由でモデルをダウンロードできるようにしたい。これにより、NFS等の共有ストレージがない環境でもシステムを運用できる。

**この優先度の理由**: 共有ストレージを持たない環境でのフォールバック手段として必要。共有パスが利用できる環境では使用されない。

**独立テスト**: 共有パスがアクセス不可な状態で推論リクエストを送信し、ルーターAPI経由でモデルがダウンロードされることを確認する。

**受け入れシナリオ**:

1. **前提** ノードのローカルにモデルがなく、共有パスがアクセス不可、ルーターにモデルが存在する、**実行** 推論リクエストを送信、**結果** ルーターHTTP API経由でモデルがダウンロードされ、ローカルに保存後、推論結果が返る

---

### ユーザーストーリー3 - モデル不在時のエラー通知 (優先度: P2)

ノードオペレーターとして、リクエストされたモデルがどこにも存在しない場合、明確なエラーメッセージを受け取りたい。これにより、問題の原因を迅速に特定し、適切な対処（モデルの事前配布など）を行える。

**この優先度の理由**: 運用時のトラブルシューティングに必須。ユーザーが問題を理解し対処するために必要。

**独立テスト**: 存在しないモデル名で推論リクエストを送信し、適切なエラーレスポンスが返ることを確認する。

**受け入れシナリオ**:

1. **前提** モデルがローカル、共有パス、ルーターのいずれにも存在しない、**実行** 推論リクエストを送信、**結果** モデルが見つからないことを示すエラーレスポンスが返る

---

### エッジケース

- 共有パスへのネットワーク接続が切断された場合、ルーターAPI経由でのダウンロードにフォールバックする
- ルーターAPI経由のダウンロード中にノードが再起動した場合、次回起動時に再ダウンロードを試行する
- 複数のリクエストが同時に同じモデルを要求した場合、重複ダウンロードを防止する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはモデル要求時、まずローカルストレージを確認し、存在すればそのパスを使用する必要がある
- **FR-002**: システムはローカルにモデルがない場合、共有パス（ルーター側キャッシュ）を直接参照する必要がある（コピーしない）
- **FR-003**: システムは共有パスがアクセス不可の場合、ルーターHTTP API経由でモデルをダウンロードする必要がある
- **FR-004**: システムはルーターAPI経由でダウンロードしたモデルをローカルに保存する必要がある
- **FR-005**: システムはルーターにもモデルが存在しない場合、エラーを返す必要がある
- **FR-006**: システムはHugging Face等の外部ソースへの直接ダウンロードを行ってはならない
- **FR-007**: システムは従来のauto_repair（破損検出・修復）機能を削除する必要がある

### 主要エンティティ

- **モデルパス**: モデルファイル（GGUF形式）の場所を示す。ローカル、共有パス、またはルーターAPI経由のいずれかで解決される
- **共有パス**: ルーター側で管理される共有ストレージ上のモデルファイルへのパス
- **ルーターAPI**: モデルファイルをHTTP経由で配信するルーターのエンドポイント

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- モデルファイルの破損検出・自動修復機能（auto_repair）
- Hugging Face等の外部ソースからの直接ダウンロード
- モデルファイルのバージョン管理・ロールバック機能

---

## 技術制約 *(該当する場合)*

- 共有パスはNFSまたは同等のネットワークファイルシステムを前提とする
- ルーターAPI経由のダウンロードはGGUF形式のモデルファイルのみ対応

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- ルーターが稼働しており、モデルキャッシュディレクトリが設定されている
- ノードからルーターへのネットワーク接続が確立されている

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- ルーター側のモデルキャッシュ機能（既存）
- ルーター側のモデル配布機能（既存）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. モデルがローカルにない場合でも、共有パスまたはルーターAPI経由で自動的に取得され、推論リクエストが成功する
2. 共有パスからの直接参照時、モデルファイルのコピーが発生しない
3. モデルがどこにも存在しない場合、1秒以内に明確なエラーメッセージが返る
4. 従来のauto_repair関連のコードが完全に削除され、関連する環境変数の警告が表示されない
