# 技術リサーチ: SPEC-11106000 Hugging Face GGUFモデル対応登録

## リサーチ課題
1. HF API へのアクセス方法と認証要否（GGUF一覧取得）。
2. 対応モデルIDの命名規則（repo / ファイル名の組み立て）。
3. 非GGUFモデルの変換とホスティング方針。
4. レートリミットとキャッシュ戦略。

## 調査結果と決定

### 1) HF API アクセス / 認証
- HF Hub 公開モデルは匿名でも取得可能だが、レートリミットが厳しいためトークン指定（`Authorization: Bearer <HF_TOKEN>`）を許可する。
- GGUF一覧取得は `GET https://huggingface.co/api/models?library=gguf&search=<query>&limit=<n>&offset=<m>` を利用する方針。
- トークン未設定時は匿名で試行し、429/401 時に「トークン設定を推奨」メッセージを返す。

### 2) モデルID命名規則
- 対応モデルIDは衝突回避と一意性を優先し、`hf/<repo>/<filename>` を基本形とする（例: `hf/TheBloke/Llama-2-7B-GGUF/llama-2-7b.Q4_K_M.gguf`）。
- 表示名は repo と量子化レベルを含めた短縮形を併記（UI/CLIはラベルで短縮、IDはフルパスで保持）。
- 将来のバージョン違いも同一IDで区別できるよう、ファイル名を必須要素とする。

### 3) 非GGUFモデルの変換・ホスティング
- 方針: ルーター側（または専用ワーカー）で一度だけ GGUF へ変換し、内部ストレージにホスティングする。ノードは manifest を介してダウンロードのみ行う。
- 変換キューと出力先ストレージ（S3 互換 / ローカルHTTP）を後続スコープで決定。現仕様では「変換待ち」状態のみ扱う。
- 各ノードでの個別変換は帯域・CPU重複コストが大きく、再現性も下がるため採用しない。

### 4) レートリミットとキャッシュ
- HF API 呼び出しは 1 回の操作で 1 リクエスト程度だが、一覧再取得はキャッシュ前提とする（メモリキャッシュ + TTL 5分を推奨）。
- HF 障害時や 429 時はキャッシュ結果を返し、最新でないことを明示。

## 検討した代替案
- **モデルIDを repo:tag 形式にする**: ファイル名が落ちると量子化違いを区別できないため却下。
- **ノード個別変換**: 帯域とCPU/時間をノード数だけ消費し、結果がばらつくため却下。
- **常時匿名アクセスのみ**: レートリミット回避の余地がなく運用で詰まるため、トークン可にする。

## 未決事項（要明確化）
- 内部ストレージの具体実装（S3 / GCS / ローカルHTTP）とURLスキーム。
- 変換ジョブの実行基盤（キュー / ワーカーの実装場所）。
