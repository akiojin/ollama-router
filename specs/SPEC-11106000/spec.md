# 機能仕様書: Hugging Face GGUFモデル対応登録

**機能ID**: `SPEC-11106000`
**作成日**: 2025-12-01
**ステータス**: 下書き
**入力**: ユーザー説明: "Hugging FaceのGGUFモデル一覧をルーターで取得・表示し、選択したGGUFを対応モデルとして登録できるようにする（将来は非GGUFも変換して登録したい）"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - HF GGUFカタログを確認する (優先度: P1)
運用管理者として、Hugging Faceで配布されているGGUF形式のモデルを一覧・検索でき、サイズや量子化バリアントを確認したい。これにより利用可能なモデル候補を把握し、社内対応モデルに採用する判断ができる。

**この優先度の理由**: まずは候補の可視化がないと選定・配布に進めないため。

**独立テスト**: 「HF検索キーワードを指定 → GGUFタグ付きモデルのリストが返る → 各項目にモデル名・最終更新日・ダウンロードサイズ・量子化バリアントが含まれる」ことを確認する。

**受け入れシナリオ**:
1. **前提** HF API が利用可能、**実行** キーワードなしで一覧取得、**結果** GGUFモデルがページングされて返る。
2. **前提** 特定モデル名で検索、**実行** 「Q4_K_M」を含むバリアントを表示、**結果** サイズ情報とダウンロードURL（またはファイル名）が確認できる。

---

### ユーザーストーリー2 - GGUFモデルを対応モデルに登録する (優先度: P1)
運用管理者として、一覧から選んだGGUFモデル（特定バリアント）を「対応モデル」としてルーターに登録し、ノード配布フローで利用可能にしたい。登録後は /v1/models やダッシュボードに反映されることを期待する。

**この優先度の理由**: 実際に配布・推論に使うための最短経路。

**独立テスト**: 一覧から1件選択→登録APIを呼ぶ→ /v1/models に新しいモデルIDが含まれ、登録結果がダッシュボードに表示されることを確認する。

**受け入れシナリオ**:
1. **前提** GGUF候補リスト表示済み、**実行** 任意のバリアントを選び登録、**結果** 対応モデル一覧に追加される。
2. **前提** 同一モデルを重複登録しようとする、**実行** 登録操作、**結果** 重複エラーまたはスキップの明示メッセージが返る。
3. **前提** 「対応可能モデル」タブと「対応モデル」タブがある、**実行** 対応可能リストから登録後に対応モデルタブを開く、**結果** 登録済みに表示され、対応可能側は状態が登録済みになる。

### ユーザーストーリー3 - 登録済みモデルを今すぐノードにダウンロードさせる (優先度: P1)
運用管理者として、登録済みの対応モデルについて「今すぐダウンロード」を指示し、全ノードまたは特定ノードのダウンロード進捗をWeb/CLIで確認したい。これによりリクエスト前にモデルを温められる。

**この優先度の理由**: 推論前の準備時間を短縮する直接的効果があるため。

**独立テスト**: 登録済みモデルを選択→「全ノードにダウンロード」を実行→進捗が表示され、少なくとも1ノードで完了が確認できる。

**受け入れシナリオ**:
1. **前提** 対応モデル一覧にモデルがある、**実行** 「全ノードにダウンロード」を押下、**結果** タスクIDが発行され、進捗が5秒以内に表示される。
2. **前提** 特定ノードを指定、**実行** CLI `llm-router model download <model> --node <uuid>`、**結果** 進捗がCLIに表示され、完了後にノードの状態が更新される。
3. **前提** CLI で全ノード指定、**実行** `llm-router model download <model> --all`、**結果** 各ノードにダウンロードタスクが生成され、進捗が確認できる。

---

### ユーザーストーリー3 - 非GGUFモデルの将来拡張を予約する (優先度: P3)
運用管理者として、将来的にHF上の非GGUFモデル（例: safetensors）も選択し、変換キューに投入してGGUF化後に対応モデルへ追加できる道筋を確保したい（現時点では変換完了まで待ち表示のみ）。

**この優先度の理由**: 将来の拡張計画を明示し、UI/APIの拡張余地を確保するため。ただし本リリースでは変換処理自体は行わない。

**独立テスト**: 非GGUFモデルを選択すると「変換対象として登録済み／未対応」のステータスが表示されることを確認する（実際の変換は行わない）。

**受け入れシナリオ**:
1. **前提** 非GGUFモデルを選択、**実行** 登録操作、**結果** 「変換待ち」などのステータスが付与され、配布対象にはならない。

---

### エッジケース
- HF APIが一時的にダウンまたはレートリミットされた場合、一覧はキャッシュから返し、最新でない旨を表示する。
- 選択したGGUFファイルが実際には存在しない／削除されていた場合、登録を失敗として詳細メッセージを返す。
- 巨大モデル（>50GB）が登録された場合、ノード側の容量不足を事前警告として返す。

### 要明確化
- HF APIへのアクセスは匿名で十分か、それともアクセストークン必須か（レートリミットと運用責任の所在を決める必要がある）。
- 対応モデルIDの命名規則を HF リポジトリ／ファイル名からどう組み立てるか（例: `TheBloke/Llama-2-7B-GGUF:Q4_K_M` など）を統一する必要がある。
- 将来の非GGUF変換で生成したGGUFをどこにホストし、ノードに配布するか（HF直リンクか社内ミラー/オブジェクトストレージか）を決める必要がある。
- 将来、非GGUF（safetensors/PyTorch）モデルを扱う場合は「ルーター側で一度だけ変換・量子化し、GGUFをホスティングしてノードはダウンロードのみとする」か、「各ノードが個別にダウンロード・変換する」かの方針を決める必要がある（負荷・帯域・再現性に大きく影響）。

## 要件 *(必須)*

### 機能要件
- **FR-001**: システムはHFのGGUFタグ付きモデルを検索・ページングして返す必要がある。
- **FR-002**: システムは各GGUFバリアントのメタ情報（サイズ、量子化レベル、最終更新日、直リンク）を表示する必要がある。
- **FR-003**: 管理者は選択したGGUFバリアントを「対応モデル」として登録できる必要がある。
- **FR-004**: 登録されたモデルは /v1/models やダッシュボードの対応モデル一覧に反映される必要がある。
- **FR-005**: 既存対応モデルとの重複登録を防ぎ、重複時は理由付きで失敗を返す必要がある。
- **FR-006**: HF API障害時でも直近キャッシュを返し、操作不能時は明示的なエラーメッセージを出す必要がある。
- **FR-007**: 将来の非GGUFモデルを「変換待ち」として登録し、その状態を表示できる必要がある（変換自体は本スコープ外）。
- **FR-008**: モデル登録時に想定容量超過や推奨GPU要件未達を検出した場合、警告を返す必要がある。
- **FR-009**: Web UIは「対応可能モデル一覧（HFカタログ）」と「対応モデル一覧（配布対象）」を明確に分けて表示する必要がある。
- **FR-010**: 登録・削除などの操作後、対応モデル一覧への反映が即時または5秒以内に確認できる必要がある（手動リロード不要）。
- **FR-011**: CLI は `llm-router model list`（HF GGUFカタログ取得）と `llm-router model add <repo> --file <gguf_file>`（対応モデル登録）を提供し、旧`llm-router hf`系コマンドは使用しない。
- **FR-012**: WebとCLIは登録済みモデルに対して「ダウンロード開始」操作を提供し、ターゲット（全ノード/指定ノード）を選べる必要がある。
- **FR-013**: ダウンロード進捗をWeb/CLI双方でポーリングまたはストリーミング表示できる必要がある（少なくとも5秒間隔で更新）。

### 主要エンティティ
- **Hugging Face モデル**: HF上のリポジトリとそのファイル（特にGGUFファイル）。属性: リポジトリ名、ファイル名、サイズ、量子化、更新日時、直リンク。
- **対応モデル**: ルーターが配布・推論対象として認識するモデル。属性: モデルID、ソース種別（predefined / hf_gguf / future_non_gguf）、ステータス（登録済み／変換待ち／無効）、サイズ目安。
- **変換タスク（将来）**: 非GGUFからGGUFへの変換要求。属性: 入力モデル、状態（待機/進行/失敗/完了）、出力先。

## スコープ外 *(オプション)*
- 非GGUF→GGUF の変換処理そのものと配布までの自動パイプライン実行。
- HF 認証が必要なプライベートモデル対応（今回は公開モデル前提）。

## 技術制約 *(該当する場合)*
- HF 公開APIのレートリミット内で動作すること。
- GGUF以外の形式は本スコープでは配布不可（将来拡張を前提にUI/APIのみ予約）。

## 前提条件 *(該当する場合)*
- ルーターとノード間の既存配布・登録フローが動作していること。
- 管理者はHF公開モデルへのアクセス権（ネットワーク到達性）があること。

## 依存関係 *(該当する場合)*
- 既存のモデル自動配布機能（SPEC-8ae67d67）とモデル一覧API。
- ノード側が /v1/models に基づき manifest/ファイルを取得できる既存仕組み。

## 成功基準 *(必須)*
1. HF GGUF一覧APIが平均1秒以内（P95 3秒以内）で結果を返し、最低50件をページング表示できる。
2. 選択登録したGGUFモデルが1分以内に /v1/models に反映され、ダッシュボードに表示される。
3. 重複登録や欠損ファイル指定時に100%で意味のあるエラーメッセージを返す。
4. HF API障害時でも最後のキャッシュ結果を返し、操作不能時はユーザーに再試行を案内する。
