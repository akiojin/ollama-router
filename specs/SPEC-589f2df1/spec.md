# 機能仕様書: ロードバランシングシステム

**機能ID**: `SPEC-589f2df1`
**作成日**: 2025-10-30
**ステータス**: ✅ 実装完了 (2025-11-06)
**元のSPEC**: SPEC-32e2b31a から分割
**依存SPEC**: SPEC-63acef08（統一APIプロキシ）

## 概要

複数のノード間でリクエストを最適に分散するロードバランシング機能。各ノードの負荷状況に応じて、最も適切なノードにリクエストを振り分ける。

## ユーザーシナリオ＆テスト

### ユーザーストーリー - ロードバランシングと負荷分散

ユーザーが複数のリクエストを送信した際、ルーターは各ノードの負荷状況に応じて最適なノードにリクエストを振り分ける。これにより、特定のマシンに負荷が集中することを防ぐ。

**この優先度の理由**: 基本的なAPI統合が完了していれば、負荷分散の最適化は段階的に改善可能。最初はラウンドロビンで動作し、後で負荷ベースに改善できる。

**独立テスト**: 複数のノードが登録された状態で大量のリクエストを送信し、各ノードへの分散状況を監視することで価値を提供する。

**受け入れシナリオ**:

1. **前提** 3台のノードが登録され、すべてアイドル状態、**実行** 連続して30個のリクエストを送信する、**結果** 各ノードがほぼ均等（各10個前後）のリクエストを処理する
2. **前提** 2台のノードが登録され、1台が高負荷（CPU 90%）、**実行** 新しいリクエストを送信する、**結果** 低負荷のノードが優先的に選択される
3. **前提** 4台のノードが登録されている、**実行** ダッシュボードでリアルタイムのリクエスト分散状況を確認する、**結果** 各ノードが処理中のリクエスト数と処理済みリクエスト数が表示される

## 機能要件

### FR-009: メトリクス収集

ノードから定期的にパフォーマンスメトリクスを収集する。

- メトリクス項目:
  - CPU使用率
  - メモリ使用率
  - 処理中のリクエスト数
  - 平均レスポンスタイム
- 収集間隔: 30秒ごと
- エンドポイント: `POST /api/agents/:id/metrics`

### FR-010: 負荷ベースのノード選択

収集されたメトリクスに基づいて、最も負荷の低いノードを選択する。

- 選択アルゴリズム:
  1. オンライン状態のノードを抽出
  2. CPU使用率が80%以下のノードを優先
  3. 処理中のリクエスト数が最も少ないノードを選択
- フォールバック: すべてのノードが高負荷の場合、ラウンドロビンを使用

### FR-013: GPUスペック優先度とフォールバック

ノードのGPU能力スコア（0-10000）をロードバランサーが考慮し、以下の順序で優先順位を決定する。

1. **スペック優先**: すべての候補がアイドル（CPU<=80%かつアクティブリクエスト数が少ない）であれば、GPU能力スコアの高いノードから順に選択する。
2. **ビジー時フォールバック**: 最上位スペックがビジー状態（CPU>80%またはアクティブリクエストが閾値超過）の場合、次点のGPU能力スコアを持つノードにフォールバックする。
3. **メトリクス欠如時の扱い**: 一部のノードが最新メトリクスを送信していない場合でも、GPU能力スコアを基準に優先順位を決め、同点のみラウンドロビンで解決する。
4. **メトリクスモード動作**: `LOAD_BALANCER_MODE=metrics` でも同じ優先度ルールを適用する。負荷スコアが同一ならGPU能力スコア→ラウンドロビンの順で決定する。

**受け入れ条件**

- 高スペックのGPUがアイドルなら常に最優先で割り当てられる。
- 高スペックGPUがビジーになると、次点スペックのノードへ自動でリクエストが移る。
- メトリクス欠如時も「スペック→ラウンドロビン」で公平に分配される。

### FR-011: リクエスト統計

各ノードの処理リクエスト数を追跡する。

- トラッキング項目:
  - 総リクエスト数
  - 成功リクエスト数
  - エラーリクエスト数
  - 平均処理時間

### FR-012: カスタムロードバランシングアルゴリズム

将来的に複数のロードバランシングアルゴリズムから選択可能にする。

- サポート予定のアルゴリズム:
  - ラウンドロビン（現在実装済み）
  - 最小接続数
  - 重み付けラウンドロビン
  - レスポンスタイム優先

## 非機能要件

### NFR-006: パフォーマンス

- ノード選択ロジックは10ms以内に完了
- メトリクス収集がプロキシ処理をブロックしない

### NFR-007: スケーラビリティ

- 最大1000台のノードでメトリクスベースの選択が可能

## 実装状態

### ✅ 実装済み
- ラウンドロビン方式のロードバランシング
- 基本的なリクエスト統計

### 🚧 未実装（今後の拡張）
- メトリクスベースのノード選択
- CPU/メモリ使用率の監視
- カスタムロードバランシングアルゴリズム
- リアルタイムメトリクスダッシュボード
