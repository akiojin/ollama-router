# ã‚¿ã‚¹ã‚¯: ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸš§ **éƒ¨åˆ†å®Ÿè£…** (Phase 1å®Œäº†: 3/24ã‚¿ã‚¹ã‚¯ = 12.5%)
**å…¥åŠ›**: `/ollama-coordinator/specs/SPEC-589f2df1/`ã®è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

---

## âœ… Phase 1: ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³æ–¹å¼ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

**å®Ÿè£…å®Œäº†**: PR #1ã§ãƒãƒ¼ã‚¸æ¸ˆã¿ï¼ˆ2025-10-30ï¼‰

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼†å®Ÿè£…

- [x] **T001** `coordinator/src/registry/mod.rs` ã«round_robin_indexãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
  - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: `round_robin_index: AtomicUsize`
  - åˆæœŸåŒ–: `AtomicUsize::new(0)`

- [x] **T002** `coordinator/src/registry/mod.rs` ã«select_agent()ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
  - æ©Ÿèƒ½: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸€è¦§å–å¾— â†’ ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ã§é¸æŠ
  - ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ : `index % online_agents.len()`

### ãƒ†ã‚¹ãƒˆ

- [x] **T003** `coordinator/tests/integration/proxy_test.rs` ã«ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³å‹•ä½œãƒ†ã‚¹ãƒˆ
  - å‰æ: 3å°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç™»éŒ²æ¸ˆã¿
  - å®Ÿè¡Œ: 9å›é€£ç¶šãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
  - æ¤œè¨¼: å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ3ãƒªã‚¯ã‚¨ã‚¹ãƒˆãšã¤å‡¦ç†

**Phase 1 å®Ÿè£…æ™‚é–“**: ç´„1æ™‚é–“ï¼ˆSPEC-63acef08ã«å«ã‚€ï¼‰

---

## ğŸš§ Phase 2: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ™ãƒ¼ã‚¹é¸æŠï¼ˆæœªå®Ÿè£…ï¼‰

**æ¨å®šå®Ÿè£…æ™‚é–“**: ç´„10æ™‚é–“

### Phase 2.1: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

- [ ] **T004** [P] Cargo.tomlä¾å­˜é–¢ä¿‚è¿½åŠ : `sysinfo`ï¼ˆCPU/ãƒ¡ãƒ¢ãƒªç›£è¦–ï¼‰
- [ ] **T005** [P] ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®£è¨€: `coordinator/src/metrics/mod.rs` ä½œæˆ
- [ ] **T006** [P] ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å®šç¾©: `common/src/types.rs` ã«AgentMetricsæ§‹é€ ä½“è¿½åŠ 

**æ¨å®šæ™‚é–“**: 30åˆ†

### Phase 2.2: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆï¼ˆTDDï¼‰

#### Contract Tests

- [ ] **T007** [P] `coordinator/tests/contract/metrics_test.rs` ã« POST /api/agents/:id/metrics ã®contract test
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: AgentMetrics
  - æœŸå¾…ãƒ¬ã‚¹ãƒãƒ³ã‚¹: 204 No Content

#### Integration Tests

- [ ] **T008** `coordinator/tests/integration/metrics_test.rs` ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ãƒ†ã‚¹ãƒˆ
  - å‰æ: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç™»éŒ²æ¸ˆã¿
  - å®Ÿè¡Œ: POST /api/agents/:id/metrics ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹é€ä¿¡
  - æ¤œè¨¼: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒãƒ¡ãƒ¢ãƒªã«ä¿å­˜ã•ã‚Œã‚‹

- [ ] **T009** `coordinator/tests/integration/loadbalancer_test.rs` ã«è² è·ãƒ™ãƒ¼ã‚¹é¸æŠãƒ†ã‚¹ãƒˆ
  - å‰æ: 3å°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€1å°ãŒé«˜è² è·ï¼ˆCPU 90%ï¼‰
  - å®Ÿè¡Œ: select_agent_by_metrics() å‘¼ã³å‡ºã—
  - æ¤œè¨¼: ä½è² è·ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒé¸æŠã•ã‚Œã‚‹

- [ ] **T010** `coordinator/tests/integration/loadbalancer_test.rs` ã«å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé«˜è² è·æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
  - å‰æ: ã™ã¹ã¦ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒCPU 95%
  - å®Ÿè¡Œ: select_agent_by_metrics() å‘¼ã³å‡ºã—
  - æ¤œè¨¼: ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

**æ¨å®šæ™‚é–“**: 2æ™‚é–“

### Phase 2.3: ã‚³ã‚¢å®Ÿè£…

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

- [ ] **T011** [P] `common/src/types.rs` ã«AgentMetricså®Ÿè£…
  - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: agent_id, cpu_usage, memory_usage, active_requests, avg_response_time, timestamp
  - Derive: Debug, Clone, Serialize, Deserialize

#### ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸

- [ ] **T012** `coordinator/src/registry/mod.rs` ã«metricsãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
  - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: `metrics: Arc<RwLock<HashMap<Uuid, AgentMetrics>>>`
  - åˆæœŸåŒ–: ç©ºã®HashMap

- [ ] **T013** `coordinator/src/registry/mod.rs` ã«update_metrics()ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
  - æ©Ÿèƒ½: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆIDã‚’ã‚­ãƒ¼ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ä¿å­˜

#### è² è·ãƒ™ãƒ¼ã‚¹é¸æŠãƒ­ã‚¸ãƒƒã‚¯

- [ ] **T014** `coordinator/src/registry/mod.rs` ã«select_agent_by_metrics()ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
  - æ©Ÿèƒ½: è² è·ã‚¹ã‚³ã‚¢è¨ˆç®— â†’ æœ€å°ã‚¹ã‚³ã‚¢ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé¸æŠ
  - ã‚¹ã‚³ã‚¢è¨ˆç®—: `cpu_usage + memory_usage + (active_requests * 10)`

- [ ] **T015** `coordinator/src/registry/mod.rs` ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
  - æ¡ä»¶: ã™ã¹ã¦ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒCPU > 80%
  - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

#### ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†API

- [ ] **T016** `coordinator/src/api/metrics.rs` ã«update_metrics()ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…
  - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: POST /api/agents/:id/metrics
  - æ©Ÿèƒ½: AgentMetricså—ä¿¡ â†’ registry.update_metrics() â†’ 204è¿”å´

**æ¨å®šæ™‚é–“**: 3æ™‚é–“

### Phase 2.4: çµ±åˆ

- [ ] **T017** `coordinator/src/main.rs` ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ«ãƒ¼ãƒˆè¿½åŠ 
  - /api/agents/:id/metrics â†’ update_metrics

- [ ] **T018** `coordinator/src/api/proxy.rs` ã§select_agent_by_metrics()ä½¿ç”¨
  - ç’°å¢ƒå¤‰æ•° `LOAD_BALANCER_MODE` ã§åˆ‡ã‚Šæ›¿ãˆï¼ˆroundrobin / metricsï¼‰

- [ ] **T019** èµ·å‹•ãƒ­ã‚°ã«ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ãƒ¢ãƒ¼ãƒ‰è¿½åŠ 
  - `tracing::info!("Load balancer mode: {}", mode);`

**æ¨å®šæ™‚é–“**: 1æ™‚é–“

### Phase 2.5: ä»•ä¸Šã’

#### Unit Tests

- [ ] **T020** [P] `coordinator/src/registry/mod.rs` ã«è² è·ã‚¹ã‚³ã‚¢è¨ˆç®—ã®unit test
  - æ­£å¸¸ã‚±ãƒ¼ã‚¹: ä½è² è·ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒé«˜ã‚¹ã‚³ã‚¢
  - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãªã—ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯æœ€ä½å„ªå…ˆåº¦

- [ ] **T021** [P] `common/src/types.rs` ã«AgentMetricså‹ã®unit test
  - JSONã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³/ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ

#### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ ] **T022** [P] README.md ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
  - ä½¿ç”¨ä¾‹ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆèª¬æ˜ã€ç’°å¢ƒå¤‰æ•°èª¬æ˜

- [ ] **T023** [P] Rustdocã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
  - select_agent_by_metrics() ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚³ãƒ¡ãƒ³ãƒˆ

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

- [ ] **T024** [P] `coordinator/benches/loadbalancer_bench.rs` ã«ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯è¿½åŠ 
  - æ¸¬å®š: select_agent_by_metrics() ã®å®Ÿè¡Œæ™‚é–“
  - ç›®æ¨™: 1000ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ < 10ms

**æ¨å®šæ™‚é–“**: 3.5æ™‚é–“

---

## ã‚¿ã‚¹ã‚¯çµ±è¨ˆ

| ãƒ•ã‚§ãƒ¼ã‚º | ã‚¿ã‚¹ã‚¯æ•° | å®Œäº† | æœªå®Œäº† | æ¨å®šæ™‚é–“ |
|---------|---------|------|--------|----------|
| Phase 1: Roundrobin | 3 | 3 (100%) | 0 | 1æ™‚é–“ï¼ˆå®Œäº†ï¼‰ |
| Phase 2.1: Setup | 3 | 0 | 3 | 30åˆ† |
| Phase 2.2: Tests | 4 | 0 | 4 | 2æ™‚é–“ |
| Phase 2.3: Core | 6 | 0 | 6 | 3æ™‚é–“ |
| Phase 2.4: Integration | 3 | 0 | 3 | 1æ™‚é–“ |
| Phase 2.5: Polish | 5 | 0 | 5 | 3.5æ™‚é–“ |
| **åˆè¨ˆ** | **24** | **3 (12.5%)** | **21 (87.5%)** | **ç´„11æ™‚é–“** |

---

## å®Ÿè£…å®Œäº†ç¢ºèª

**Phase 1ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ï¼‰**:
- [x] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- [x] TDDéµå®ˆ
- [x] cargo clippy: ã‚¨ãƒ©ãƒ¼/è­¦å‘Šã‚¼ãƒ­
- [x] cargo fmt --check: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæº–æ‹ 

**Phase 2ï¼ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ™ãƒ¼ã‚¹ï¼‰**:
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- [ ] TDDéµå®ˆ
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™é”æˆï¼ˆ< 10msï¼‰
- [ ] cargo clippy: ã‚¨ãƒ©ãƒ¼/è­¦å‘Šã‚¼ãƒ­
- [ ] cargo fmt --check: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæº–æ‹ 

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [æ©Ÿèƒ½ä»•æ§˜æ›¸](./spec.md)
- [å®Ÿè£…è¨ˆç”»](./plan.md)
