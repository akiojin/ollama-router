# 実装計画: クラウドモデルプレフィックスルーティング

**機能ID**: `SPEC-4b6e9f2a`  
**作成日**: 2025-11-25  
**ステータス**: 完了

## 目的と範囲

- 目的: OpenAI互換APIのモデル名プレフィックスでクラウドLLMを明示的に選択できるようにし、ローカルLLMとクラウドLLMを単一点で切り替え可能にする。
- 範囲: ルーター側のリクエスト受領～クラウドAPIへのプロキシ～レスポンス中継。ノード側の変更は不要。
- スコープ外: 課金管理、ベンダーごとのリトライポリシー最適化、プロンプト変換の高度化。

## アーキテクチャ方針

- モデル名をパースして `CloudRoute::OpenAI|Google|Anthropic|None` を決定するパーサを単一箇所に集約。
- ベンダーごとに薄いHTTPクライアントモジュールを用意し、OpenAI互換JSONを入出力とするアダプタ層で差分吸収。
- ストリーミングはベンダーからのチャンクをそのままSSEへ橋渡しし、ルーターが独自バッファリングしない。
- APIキー・ベースURLは環境変数ベースの設定に統一し、未設定時は即時バリデーションエラーを返す。
- 既存のローカルルーティングとは完全に分離し、プレフィックス有無で経路決定が決まるようにする。

## データフロー（高レベル）

1. `/v1/chat/completions` 受信時にモデル名を解析し、クラウド種別を判定。
2. クラウド種別が決まれば、対応するクライアントに標準化されたリクエストを渡す。
3. クラウドクライアントがHTTP通信を行い、レスポンスをOpenAI互換形式に変換。
4. `stream: true` の場合はレスポンスストリームをSSEとしてパススルー。
5. ログ/メトリクスには `provider`, `model`, `request_id`, `latency_ms`, `status` を記録。

## テスト戦略（TDD）

- **Contract/Integration**: `router` クレートで `cloud_prefix_routing` 系統の統合テストを追加し、クラウドプレフィックス付きリクエストがローカルパスを通らないことを確認する。HTTPクライアントはテストダブルでモックし、外部通信を行わない。
- **Unit**: モデル名パーサ、設定バリデーション、ストリーミング中継のチャンク変換を小さく分けてテスト。
- **E2E（後続）**: 実際のクラウドAPIキーを利用したスモークテストを別ジョブで用意（CIではモックのみ）。

## マイルストーン

1. モデル名パーサ実装＋ユニットテスト（RED→GREEN）
2. OpenAIクライアントのモック統合テスト（非ストリーミング）  
3. ストリーミング中継テスト（モック）  
4. Google/Anthropicクライアントのインタフェース確立（モック）  
5. メトリクス・ログの追加 + ダッシュボード統計にクラウドAPIキー設定有無を表示  
6. ドキュメント更新（README/USAGE/API仕様）

## リスクと対応

- **API差分**: ベンダーごとに出力フォーマットが微妙に異なる → 変換アダプタを明示的に定義し、スナップショットテストで固定。
- **認証形式の差**: GoogleはAPIキーとOAuthが混在 → MVPではAPIキーに限定し、未対応をエラーで明示。
- **ストリーミング中断**: 長時間ストリームで接続切断時にリーク → 中継時にキャンセル伝播を必須化し、テストで確認。

## 完了条件

- FR-CLD-001〜006 を満たすテストが追加され、全てGREENであること。
- 既存のOpenAI互換APIテストが回帰しないこと。
- docs/README系に利用方法と環境変数が追記されていること。
