# 機能仕様書: クラウドモデルプレフィックスルーティング

**機能ID**: `SPEC-4b6e9f2a`  
**作成日**: 2025-11-25  
**ステータス**: 実装完了  
**依存SPEC**: SPEC-63acef08（統一APIプロキシ）

## 概要

OpenAI互換エンドポイントで指定されたモデル名にクラウド事業者プレフィックス（`openai:` `google:` `anthropic:`）が付与されている場合、ルーターはローカルLLMに転送せず、対応するクラウド推論APIへプロキシする。プレフィックスなしのモデルは従来どおりローカルノードへルーティングする。

この仕組みにより、利用者は単一のエンドポイントからローカルLLMとクラウドLLMをシームレスに使い分けられる。

## ユーザーストーリー

1. **クラウド強制指定**  
   - 前提: `OPENAI_API_KEY` が設定されている  
   - 行動: `model: "openai:gpt-4.1"` を指定して `/v1/chat/completions` を呼び出す  
   - 結果: ルーターはノードには振り分けず OpenAI API に転送し、応答をそのまま返す

2. **ベンダー切替**  
   - 前提: `GOOGLE_API_KEY` または相当の認証情報が設定されている  
   - 行動: `model: "google:gemini-1.5-pro"` を指定してチャットリクエストを送信  
   - 結果: Google Generative Language API に転送され、レスポンスが返る

3. **Anthropic利用**  
   - 前提: `ANTHROPIC_API_KEY` が設定されている  
   - 行動: `model: "anthropic:claude-3-opus"` を指定してチャットリクエストを送信  
   - 結果: Anthropic API に転送され、レスポンスが返る

4. **ストリーミング**  
   - 前提: いずれかのクラウドキーが設定されている  
   - 行動: `stream: true` でクラウドプレフィックス付きモデルを指定  
   - 結果: ルーターはクラウドAPIのストリーミングレスポンスをSSEとしてクライアントへ中継する

5. **認証未設定エラー**  
   - 前提: 該当ベンダーのAPIキーが未設定  
   - 行動: `model: "openai:gpt-4.1"` などを指定  
   - 結果: 401（または 400）で「当該クラウドAPIキーが未設定」エラーを返す

6. **ローカル優先の既存動作維持**  
   - 行動: プレフィックスなし（例: `model: "gpt-oss:20b"`）でリクエスト  
   - 結果: 従来どおりローカルノードにルーティングされる

## 機能要件

- **FR-CLD-001: プレフィックス検出**  
  - モデル名の先頭に `openai:` `google:` `anthropic:`（`ahtnorpic:` のタイポ互換含む）が付いている場合、クラウド経路を選択する。

- **FR-CLD-002: クラウドAPIプロキシ**  
  - プレフィックスに応じて各クラウド推論APIへHTTPリクエストを送信し、結果をOpenAI互換形式でクライアントに返す。  
  - 必要なAPIキー/エンドポイントは環境変数で設定できること。  
    - OpenAI: `OPENAI_API_KEY`（必須）、`OPENAI_BASE_URL`（任意）  
    - Google: `GOOGLE_API_KEY` もしくは同等の認証情報、`GOOGLE_API_BASE_URL`（任意）  
    - Anthropic: `ANTHROPIC_API_KEY`、`ANTHROPIC_API_BASE_URL`（任意）

- **FR-CLD-003: ストリーミング中継**  
  - `stream: true` の場合、クラウドAPIのストリーミングレスポンスをSSEでクライアントへ中継する。  
  - ルーター独自のJSONチャンク生成ではなく、クラウドAPIからのイベントを順次転送する。

- **FR-CLD-004: エラーハンドリング**  
  - APIキー未設定、権限不足、モデル未対応、ベンダーダウン時などを判別し、HTTPステータスとメッセージを明示的に返す。  
  - 不明なプレフィックスは 400 Bad Request とする。

- **FR-CLD-005: ローカルとの分離**  
  - クラウドプレフィックス付きリクエストはローカルノード選択の対象に含めない。  
  - 逆にプレフィックスなしモデルはクラウド経路に送らない。

- **FR-CLD-006: オブザーバビリティ**  
  - ベンダー種別・モデル名を含むトレースID/ログを出力し、遅延・失敗を計測できる。  
  - メトリクスにクラウド呼び出し回数とレイテンシを追加する（ベンダー別カウンタ・ヒストグラム）。
  - ダッシュボード統計でクラウドAPIキーの有無（OpenAI/Google/Anthropic）を確認できる。

## 非機能要件

- 追加のクラウドAPI呼び出しによるレイテンシ増を可視化し、ローカル経路への影響を最小化する。
- 既存のOpenAI互換APIコントラクトテストと両立し、回帰を生まない。
- 環境変数のみで有効化・無効化でき、デフォルトは現行と同一動作（プレフィックスなし=ローカル）。
