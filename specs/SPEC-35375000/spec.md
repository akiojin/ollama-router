# 機能仕様書: ルーター負荷最適化

**機能ID**: `SPEC-35375000`
**作成日**: 2025-12-04
**ステータス**: 下書き
**入力**: ユーザー説明: "ルーター負荷最適化機能を実装します。クライアント増加時のルーター負荷を軽減するため、HTTPクライアントプーリング、待機機構の改善（タイムアウト付き待機、段階的バックプレッシャー）、ノード選択の最適化（キャッシュ化）を行います。制約条件として、ノード非公開は必須（セキュリティ要件）、中規模（〜1000 req/s）、外部依存は最小限（Redis/NATS等は避ける）です。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 高負荷時の安定したレスポンス (優先度: P1)

運用管理者として、クライアント数が増加しても安定したレスポンス時間を維持したい。
なぜなら、ユーザー体験の一貫性を保ち、サービス品質を維持するためである。

**この優先度の理由**: ルーターのパフォーマンスは全クライアントに影響するため、最も基本的かつ重要な改善である。

**独立テスト**: 同時接続数を増加させながらレスポンス時間を測定することで、改善効果を独立して検証できる。

**受け入れシナリオ**:

1. **前提** 100クライアントが同時接続している状態、**実行** 新しいリクエストを送信、**結果** レスポンス時間が現状より20%以上改善される
2. **前提** 500クライアントが同時接続している状態、**実行** 新しいリクエストを送信、**結果** p95レスポンス時間が100ms以下を維持する

---

### ユーザーストーリー2 - 全ノードビジー時の適切なフィードバック (優先度: P2)

クライアントとして、全てのノードがビジーな場合に適切なフィードバックを受け取りたい。
なぜなら、無限に待機するのではなく、リトライや代替手段を検討できるようにするためである。

**この優先度の理由**: システム安定性と雪崩効果の防止に直結し、サービスの信頼性を高める。

**独立テスト**: 全ノードがビジーな状態でリクエストを送信し、タイムアウトと段階的な負荷制御の動作を検証できる。

**受け入れシナリオ**:

1. **前提** 全ノードがビジーで待機中のリクエストが50%未満、**実行** 新しいリクエストを送信、**結果** リクエストは通常通り受け付けられる
2. **前提** 全ノードがビジーで待機中のリクエストが80%以上、**実行** 新しいリクエストを送信、**結果** 早期に拒否され、クライアントはリトライ可能な状態になる
3. **前提** 全ノードがビジーな状態、**実行** リクエストが一定時間待機、**結果** 設定されたタイムアウト時間後に適切なエラーが返される

---

### ユーザーストーリー3 - 高頻度リクエスト時の効率的な処理 (優先度: P3)

運用管理者として、短時間に大量のリクエストが来ても効率的に処理したい。
なぜなら、ルーター自体がボトルネックにならないようにするためである。

**この優先度の理由**: P1/P2の改善後、さらなる最適化として計算コストを削減する。

**独立テスト**: 高頻度でリクエストを送信し、ルーター自体のCPU使用率とレスポンス時間を測定することで検証できる。

**受け入れシナリオ**:

1. **前提** 1000 req/sの負荷がかかっている状態、**実行** 継続的にリクエストを送信、**結果** ルーターのCPU使用率が過度に上昇しない

---

### エッジケース

- 全ノードが同時に初期化中（モデルロード中）の場合、どのように処理するか?
  - 段階的バックプレッシャーにより早期に拒否し、503エラーを返す
- 待機中のリクエストがタイムアウトした場合、何が起こるか?
  - クライアントに504 Gateway Timeoutを返し、リソースを解放する
- ノードが突然オフラインになった場合、待機中のリクエストはどうなるか?
  - 他のノードに再ルーティングを試み、不可能な場合はエラーを返す

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは接続を効率的に再利用し、新規接続のオーバーヘッドを削減する必要がある
- **FR-002**: システムは待機中のリクエストに対してタイムアウトを設定できる必要がある
- **FR-003**: システムは待機者数に応じて段階的にリクエストの受け入れを制御する必要がある
- **FR-004**: システムはノード選択の計算コストを最適化し、高頻度リクエストに対応する必要がある
- **FR-005**: システムはクライアントにノードの内部情報（IPアドレス等）を公開してはならない

### 主要エンティティ

- **待機キュー**: リクエストの待機状態を管理し、タイムアウトとバックプレッシャーを制御する
- **接続プール**: ノードへの接続を管理し、再利用を可能にする
- **ノード選択キャッシュ**: 短期間の選択結果を保持し、計算コストを削減する

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- 複数ルーターインスタンス間の状態共有
- 外部キューイングシステム（Redis、NATS等）の導入
- クライアントへのノード直接接続の許可

---

## 技術制約 *(該当する場合)*

- ノード非公開は必須（セキュリティ要件）のため、プロキシ構成を維持する
- 外部依存は最小限に抑える（Redis、NATS等は使用しない）
- 現在の単一ルーター構成を前提とする

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- 既存のロードバランシング機能（SPEC-589f2df1）が実装済みである
- 既存のヘルスチェックシステム（SPEC-443acc8c）が動作している
- 中規模（〜1000 req/s）の負荷を想定する

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- 既存のLoadManager（balancer/mod.rs）
- 既存のプロキシ機能（proxy.rs）
- 既存のOpenAI互換API（openai.rs）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. レスポンス時間が現状より20%以上改善される（同一負荷条件下）
2. 1000 req/sの負荷でp95レスポンス時間が100ms以下を維持する
3. 全ノードビジー時、待機上限超過のリクエストは1秒以内に拒否される
4. 待機中のリクエストは設定されたタイムアウト時間（デフォルト30秒）後に適切にエラーを返す
5. ルーター自体のメモリ使用量がアイドル時50MB以下を維持する
