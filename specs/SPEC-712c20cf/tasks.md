# タスク一覧: 管理ダッシュボード

**機能ID**: `SPEC-712c20cf`
**ステータス**: ✅ 完了
**推定開発時間**: 約14時間
**依存SPEC**: SPEC-94621a1f, SPEC-63acef08, SPEC-443acc8c

## 追加要件（2025-11-01更新）
- 同一マシン上で複数のノードを起動する場合でも、`OLLAMA_PORT` が異なれば別インスタンスとして自動登録できること。
- OpenAI互換API (`/api/chat`, `/api/generate`) のハッピーパス/エラーケースを自動テスト（TDD）で保証すること。
- ノード起動時にデフォルトモデル `gpt-oss:20b` を自動プルし、必要に応じて環境変数 `OLLAMA_DEFAULT_MODEL` で上書きできること。
- ダッシュボードのノード一覧でロード済みモデル列を表示し、詳細モーダルでも全モデルを確認できること。
- ダッシュボードのノード一覧テーブルはヘッダーと行の列幅が一致し、視覚的なずれが発生しないこと。

## 追加要件（2025-11-30更新）
- ダッシュボード内でチャットコンソールを新規タブではなく全画面モーダルとしてオーバーレイ表示すること。
- モーダルはESC/背景クリックで閉じ、再読み込みボタンでiframe内のみをリロードできること。
- ローカル/クラウド/すべてのモデルフィルタとセッション復元は埋め込み表示でも利用できること。
- TDD遵守: UIの静的配信・埋め込み有無・アクセシビリティ属性をE2E/スモークテストでRED→GREENの順に追加すること。

---

## 本日のToDo (2025-11-01)

- [x] **T608** `GET /api/dashboard/overview` に集計時間と生成タイムスタンプを追加し、バックエンド処理時間を計測
- [x] **T609** ダッシュボードのパフォーマンスインジケーターを拡張し、閾値評価とサーバー生成時刻の表示を実装
- [x] **T610** `GET /api/dashboard/metrics/:agent_id` を実装し、ノードごとのCPU/メモリ履歴を返却
- [x] **T611** ノード詳細モーダルにCPU/メモリ折れ線グラフを追加し、最新指標とエラーハンドリングを表示

## 本日のToDo (2025-10-31)

- [x] **T601** `coordinator/src/api/mod.rs` のルーター結線スモークテストを修正し、静的配信・API経路の確認を通す
- [x] **T602** `cargo test -p llm-router-coordinator` でダッシュボードAPI関連テストを実行し、失敗時は原因を特定して修正
- [x] **T603** 本ファイルを含む関連Specドキュメントのステータス更新と変更点のコミット準備
- [x] **T604** `coordinator/tests/dashboard_smoke.rs` を追加し、ダッシュボードAPIと静的ファイルのE2Eスモークテストを実装
- [x] **T605** ダッシュボードSpecのタスク進捗（ページネーション等）を現状に合わせて更新
- [x] **T606** ダッシュボードのDOM差分更新とポーリング処理の最適化（Phase 6 T002 着手）
- [x] **T607** `GET /api/dashboard/overview` を追加し、ダッシュボードの3リクエストを集約する

## 本日のToDo (2025-11-30)

- [ ] **T710 (RED)** `coordinator/tests/contract/chat_modal_embed.rs` を作成し、`GET /dashboard` のHTMLに `id="chat-open"` ボタンと `id="chat-modal"` iframe（src=/chat）が存在することをスナップショットで検証
- [ ] **T711 (GREEN)** 上記テストをパスするようダッシュボードHTML/JS/スタイルを整備（モーダル表示/ESC・背景クリック閉鎖/iframe再読み込み）
- [ ] **T712 (RED)** `coordinator/tests/contract/chat_page_spec.rs` を追加し、`GET /chat` でサイドバーセッションリスト、プロバイダー切替(ローカル/クラウド/すべて)が含まれることを検証
- [ ] **T713 (GREEN)** `/chat` の静的アセットをビルドに含め、モデルフィルタ・セッション永続化が壊れていないことを手動確認＆必要なら追加単体テスト
- [x] **T714 (DOCS)** `specs/SPEC-712c20cf/spec.md` にチャットモーダル要件と受け入れシナリオを追記

## Phase 1: 基本UI実装 📋 (推定3時間)

### U001: 静的ファイル配信設定 ✅
- **説明**: Axumで静的ファイルを配信
- **詳細**:
  - `tower-http`の`ServeDir`ミドルウェア使用
  - `coordinator/src/web/static/`ディレクトリ作成
- **完了条件**: `/dashboard`で静的HTMLが表示される
- **推定時間**: 30分
- **ステータス**: ✅ 完了

### U002: HTML基本構造作成 ✅
- **説明**: `index.html`作成
- **詳細**:
  - システム統計カード
  - ノード一覧テーブル
  - リクエスト履歴グラフ（プレースホルダー）
- **完了条件**: HTML構造が完成
- **推定時間**: 1時間
- **ステータス**: ✅ 完了

### U003: CSS基本スタイル作成 ✅
- **説明**: `styles.css`作成
- **詳細**:
  - レスポンシブレイアウト
  - カードコンポーネント
  - テーブルスタイル
  - ステータスバッジ（Online/Offline）
- **完了条件**: 基本的な見た目が完成
- **推定時間**: 1時間
- **ステータス**: ✅ 完了

### U004: 手動リフレッシュ機能 ✅
- **説明**: リフレッシュボタンでデータ更新
- **詳細**:
  - `fetchAgents()`関数実装
  - ボタンクリックでデータ取得＆UI更新
- **完了条件**: ボタンクリックでデータが更新される
- **推定時間**: 30分
- **ステータス**: ✅ 完了

---

## Phase 2: バックエンドAPI実装 (TDD) 📋 (推定2時間)

### B001: ダッシュボードモジュール作成 ✅
- **説明**: `coordinator/src/api/dashboard.rs`作成
- **完了条件**: コンパイル成功
- **推定時間**: 5分
- **ステータス**: ✅ 完了

### B002: ノード状態APIテスト作成 (RED) ✅
- **説明**: test_get_agents_status作成
- **完了条件**: テスト失敗を確認
- **推定時間**: 10分
- **ステータス**: ✅ 完了

### B003: ノード状態API実装 (GREEN) ✅
- **説明**: `GET /api/dashboard/agents`実装
- **詳細**:
  - レジストリから全ノード取得
  - uptimeを計算（online_sinceがあればそこから現在時刻まで、未設定なら0秒）
  - JSON配列で返却
- **完了条件**: テスト合格
- **推定時間**: 30分
- **ステータス**: ✅ 完了

### B004: システム統計APIテスト作成 (RED) ✅
- **説明**: test_get_system_stats作成
- **完了条件**: テスト失敗を確認
- **推定時間**: 10分
- **ステータス**: ✅ 完了

### B005: システム統計API実装 (GREEN) ✅
- **説明**: `GET /api/dashboard/stats`実装
- **詳細**:
  - total_agents, online_agents, offline_agentsを計算
  - リクエスト統計（将来拡張）
- **完了条件**: テスト合格
- **推定時間**: 45分
- **ステータス**: ✅ 完了

### B006: ルーティング設定 ✅
- **説明**: main.rsにダッシュボードエンドポイント追加
- **詳細**:
  - `/dashboard` → index.html
  - `/api/dashboard/agents` → get_agents
  - `/api/dashboard/stats` → get_stats
- **完了条件**: エンドポイントが正常に動作
- **推定時間**: 10分
- **ステータス**: ✅ 完了

---

## Phase 3: リアルタイム更新実装 📋 (推定2時間)

### R001: ポーリング実装 ✅
- **説明**: 5秒ごとにAPIを呼び出し
- **詳細**:
  - `setInterval`で定期実行
  - `fetchAgents()`と`fetchStats()`を呼び出し
- **完了条件**: 自動的にデータが更新される
- **推定時間**: 30分
- **ステータス**: ✅ 完了

### R002: UI更新ロジック実装 ✅
- **説明**: API レスポンスからDOMを更新
- **詳細**:
  - `updateAgentTable(agents)`関数
  - `updateStats(stats)`関数
  - ステータス変更時のアニメーション
- **完了条件**: UIがリアルタイムで更新される
- **推定時間**: 1時間
- **ステータス**: ✅ 完了

### R003: エラーハンドリング ✅
- **説明**: API呼び出し失敗時の処理
- **詳細**:
  - リトライロジック
  - エラーメッセージ表示
  - 接続状態インジケーター
- **完了条件**: エラー時も安定して動作
- **推定時間**: 30分
- **ステータス**: ✅ 完了

---

## Phase 4: メトリクス可視化実装 📋 (推定4時間)

### M001: Chart.js統合 ✅
- **説明**: Chart.jsライブラリを追加
- **詳細**: CDNまたはローカルファイル
- **完了条件**: Chart.jsが読み込まれる
- **推定時間**: 15分
- **ステータス**: ✅ 完了

### M002: リクエスト履歴API実装 ✅
- **説明**: `GET /api/dashboard/request-history`実装
- **詳細**:
  - 最新1時間のリクエスト数を1分単位で返却
  - メモリに履歴を保持（リングバッファ）
- **完了条件**: 履歴データが取得可能
- **推定時間**: 1時間
- **ステータス**: ✅ 完了

### M003: リクエスト履歴グラフ実装 ✅
- **説明**: Chart.jsでリクエスト履歴をグラフ化
- **詳細**:
  - 折れ線グラフ
  - X軸: 時刻、Y軸: リクエスト数
  - 自動更新
- **完了条件**: グラフが表示され、リアルタイム更新される
- **推定時間**: 1時間
- **ステータス**: ✅ 完了

### M004: メトリクスAPI実装（SPEC-589f2df1依存） ✅
- **説明**: `GET /api/dashboard/metrics/:agent_id`実装
- **詳細**: SPEC-589f2df1のメトリクス収集が完了後に実装
- **完了条件**: ノードごとのメトリクスが取得可能
- **推定時間**: 30分
- **ステータス**: ✅ 完了（ロードマネージャでCPU/メモリ履歴を保持し、過去360件を返却）

### M005: CPU/メモリグラフ実装 ✅
- **説明**: ノードのCPU/メモリ使用率をグラフ化
- **詳細**: SPEC-589f2df1のメトリクスを使用
- **完了条件**: ノード詳細でメトリクスが表示される
- **推定時間**: 1時間
- **ステータス**: ✅ 完了（モーダルにChart.jsの折れ線グラフを追加し、CPU/メモリの推移と最新時刻を表示）

---

## Phase 5: 高度な機能実装 📋 (推定5時間)

### A001: ノード詳細モーダル実装 ✅
- **説明**: ノードの詳細情報をモーダル表示
- **詳細**:
  - システム情報
  - LLM runtime設定
  - 処理履歴
  - メトリクスグラフ
- **完了条件**: Detailsボタンクリックでモーダルが表示される
- **推定時間**: 1時間30分
- **ステータス**: ✅ 完了

### A002: フィルタリング機能実装 ✅
- **説明**: ノード一覧のフィルタリング
- **詳細**:
  - ステータスでフィルタ（Online/Offline）
  - マシン名で検索
  - IPアドレスで検索
- **完了条件**: フィルタリングが動作する
- **推定時間**: 1時間
- **ステータス**: ✅ 完了

### A003: ソート機能実装 ✅
- **説明**: ノード一覧のソート
- **詳細**:
  - マシン名でソート
  - ステータスでソート
  - 稼働時間でソート
- **完了条件**: カラムヘッダークリックでソート
- **推定時間**: 1時間
- **ステータス**: ✅ 完了

### A004: ノード設定API実装 ✅ (FR-023)
- **説明**: `PUT /api/agents/:id/settings` 実装
- **詳細**:
  - リクエスト: custom_name, tags, notes
  - Agentモデルに設定フィールド追加
  - JSONストレージに永続化
- **完了条件**: 設定が保存・取得できる
- **推定時間**: 1時間
- **ステータス**: ✅ 完了

### A005: ノード設定UI実装 ✅ (FR-023)
- **説明**: ノード設定画面UI
- **詳細**:
  - 「設定」ボタン追加
  - 設定モーダル表示
  - カスタム名、タグ、メモ入力フォーム
  - 保存ボタン
- **完了条件**: 設定が変更できる
- **推定時間**: 1時間30分
- **ステータス**: ✅ 完了

### A006: ノード削除API実装 ✅ (FR-024)
- **説明**: `DELETE /api/agents/:id` 実装
- **詳細**:
  - ノード情報削除
  - JSONストレージから削除
  - 登録解除
- **完了条件**: ノードが削除できる
- **推定時間**: 30分
- **ステータス**: ✅ 完了

### A007: ノード削除UI実装 ✅ (FR-024)
- **説明**: ノード削除UI
- **詳細**:
  - 「削除」ボタン追加
  - 確認ダイアログ表示
  - 削除後に一覧から削除
- **完了条件**: ノードが削除できる
- **推定時間**: 45分
- **ステータス**: ✅ 完了

### A008: ノード強制切断API実装 ✅ (FR-024)
- **説明**: `POST /api/agents/:id/disconnect` 実装
- **詳細**:
  - ノードステータスをOfflineに変更
  - 強制切断フラグ設定
- **完了条件**: ノードが強制切断できる
- **推定時間**: 30分
- **ステータス**: ✅ 完了

### A009: ノード強制切断UI実装 ✅ (FR-024)
- **説明**: ノード強制切断UI
- **詳細**:
  - 「強制切断」ボタン追加
  - 確認ダイアログ表示
  - 切断後にステータス更新
- **完了条件**: ノードが強制切断できる
- **推定時間**: 30分
- **ステータス**: ✅ 完了

### A010: エクスポート機能実装 ✅
- **説明**: ノード情報をエクスポート
- **詳細**:
  - JSON形式
  - CSV形式
  - ダウンロードボタン
- **完了条件**: ファイルがダウンロードされる
- **推定時間**: 1時間
- **ステータス**: ✅ 完了

### A005: ページネーション実装 ✅
- **説明**: ノード一覧のページネーション
- **詳細**: 100ノード以上の場合にページング
- **完了条件**: ページ切り替えが動作する
- **推定時間**: 30分
- **ステータス**: ✅ 完了（`coordinator/src/web/static/app.js` で `pageSize=50` のページングを実装）

---

## Phase 6: テストと最適化 📋 (推定2時間)

### T001: E2Eテスト作成 ✅
- **説明**: ダッシュボードのE2Eテスト
- **詳細**:
  - ページが表示される
  - データが正しく表示される
  - リアルタイム更新が動作する
- **完了条件**: 全シナリオが成功
- **推定時間**: 1時間
- **ステータス**: ✅ 完了（`coordinator/tests/dashboard_smoke.rs` で主要シナリオを検証）

### T002: パフォーマンス最適化 ✅
- **説明**: 初回ロード時間とポーリングの最適化
- **詳細**:
  - 差分更新（変更があった部分のみDOM更新）
  - Virtual DOM検討
  - リクエストのバッチ化
- **完了条件**: 初回ロード<2秒、ポーリング<100ms
- **推定時間**: 1時間
- **ステータス**: ✅ 完了（`GET /api/dashboard/overview` に集計時間を付加、フロントで取得/描画/サーバー集計の各メトリクスを計測し閾値評価を表示。警告・フォールバック検知を実装して性能予算を監視可能に）

### T003: OpenAI互換APIの自動検証 ✅
- **説明**: `/api/chat` `/api/generate` エンドポイントがOpenAI互換仕様に沿って応答することを確認する
- **詳細**:
  - ノード（またはモック）を用意し、API経由でリクエストを送信する統合テストを追加
  - 正常系（レスポンス形式・ステータスコード）／異常系（ノード未登録時など）の評価を含める
- **完了条件**: CIで自動実行され、OpenAI互換APIの挙動が回帰しないようになる
- **推定時間**: 2時間
- **ステータス**: ✅ 完了
- **検証ログ (2025-11-02)**:
  - `make openai-tests`（内部で `cargo test -p llm-router-coordinator --test openai_proxy` を実行）により、`/api/chat`・`/api/generate` の正常系／未登録ノード／404エラーがOpenAI互換レスポンスで返ることを確認
  - `curl http://127.0.0.1:8080/api/chat` でノードを経由した疎通を手動確認済み（`gpt-oss:20b` 応答およびメモリ不足エラーの両ケースを取得）
  - `make openai-tests` のストリーミングケースを追加し、`stream: true` 指定時にSSEレスポンスがそのまま転送されることを確認（2025-11-03）

### T004: 同一マシン複数ノードE2E ✅
- **説明**: 同一マシン名でもポート差異で複数ノードを登録できることをTDDで保証
- **詳細**:
  - レジストリの登録ロジック変更（マシン名+ポートで識別）
  - `/api/agents` に対する統合テストを追加し、2件が登録されることを確認
- **完了条件**: テストがCIで成功し、仕様がTDDで守られている
- **推定時間**: 1時間
- **ステータス**: ✅ 完了（`coordinator/src/registry/mod.rs` 更新と `test_register_same_machine_different_port_creates_multiple_agents` を追加）

---

## Phase 7: ドキュメント 📋 (推定1時間)

### D001: ユーザーガイド作成 ✅
- **説明**: ダッシュボードの使い方ドキュメント
- **完了条件**: README.mdに追記
- **推定時間**: 30分
- **ステータス**: ✅ 完了

### D002: 開発者ガイド作成 ✅
- **説明**: ダッシュボードのカスタマイズ方法
- **完了条件**: docs/dashboard.md作成
- **推定時間**: 30分
- **ステータス**: ✅ 完了

---

## 統計

- **総タスク数**: 30
- **完了タスク数**: 30 (100%)
- **未実装タスク数**: 0 (0%)
- **推定総時間**: 約14時間

## 実装優先度

### 最優先 (P1)
- Phase 1: 基本UI実装
- Phase 2: バックエンドAPI実装
- Phase 3: リアルタイム更新実装

### 高優先度 (P2)
- Phase 4: メトリクス可視化実装（M001-M003）

### 中優先度 (P3)
- Phase 4: メトリクス可視化実装（M004-M005、SPEC-589f2df1依存）
- Phase 5: 高度な機能実装（A001-A003）

### 低優先度 (P4)
- Phase 5: 高度な機能実装（A004-A005）
- Phase 6: テストと最適化
- Phase 7: ドキュメント

## 技術的決定事項

### フロントエンド技術スタック
**推奨**: Vanilla JS + Chart.js

**理由**:
1. シンプルさの極限を追求（CLAUDE.md準拠）
2. ビルドプロセス不要
3. 依存関係の最小化
4. デバッグが容易

**トレードオフ**:
- Reactなどのフレームワークより保守性は低い
- 大規模になるとコード管理が複雑化
- しかし、ダッシュボードは比較的小規模なのでVanilla JSで十分

### リアルタイム通信
**選択**: ポーリング（5秒間隔）

**理由**:
1. 実装が最もシンプル
2. 5秒間隔なら負荷も許容範囲
3. デバッグが容易

**トレードオフ**:
- WebSocketより遅延が大きい
- しかし、ダッシュボードの用途では5秒遅延は許容範囲

## 次のステップ

1. Phase 1から順次実装開始
2. 各Phaseごとにコミット＆プッシュ
3. SPEC-589f2df1実装後、メトリクス可視化を追加
4. ユーザーフィードバックを受けて改善

## 依存関係

**前提タスク**:
- SPEC-94621a1fの全タスクが完了していること
- SPEC-63acef08の全タスクが完了していること
- SPEC-443acc8cの全タスクが完了していること

**オプション依存**:
- SPEC-589f2df1: メトリクス可視化（M004-M005）
