# 機能仕様書: 管理ダッシュボード

**機能ID**: `SPEC-712c20cf`
**作成日**: 2025-10-30
**ステータス**: ✅ 実装完了 (2025-11-01)
**元のSPEC**: SPEC-32e2b31a から分割
**依存SPEC**: SPEC-94621a1f, SPEC-63acef08, SPEC-443acc8c

## 概要

WebブラウザからアクセスできるリアルタイムダッシュボードUI。ノードの状態、リクエスト処理状況、パフォーマンスメトリクスを可視化し、/api/chat への動作確認を行うチャットコンソールを備える。

## ユーザーシナリオ＆テスト

### ユーザーストーリー - 管理ダッシュボードとリアルタイム監視

ユーザーはWebブラウザからルーターのダッシュボードにアクセスし、すべてのノードの状態、リクエスト処理状況、パフォーマンスメトリクスをリアルタイムで確認できる。

**この優先度の理由**: システムがAPI経由で動作していれば、ダッシュボードは可視化のための追加機能。運用初期はログやAPIレスポンスで状態確認が可能。

**独立テスト**: ブラウザでダッシュボードにアクセスし、ノード情報が表示されることで価値を提供する。

**受け入れシナリオ（監視機能）**:

1. **前提** ルーターが起動している、**実行** ブラウザで`http://coordinator:8080/dashboard`にアクセスする、**結果** ダッシュボードが表示され、登録済みノードの一覧が確認できる
2. **前提** 複数のノードが登録されている、**実行** ダッシュボードでノード一覧を確認する、**結果** 各ノードのマシン名、IPアドレス、Ollamaバージョン、稼働時間、状態（オンライン/オフライン）が表示される
3. **前提** ノードがリクエストを処理中、**実行** ダッシュボードをリロードする、**結果** リアルタイムでリクエスト処理数、レスポンスタイム、エラー数が更新される
4. **前提** ダッシュボードを表示中、**実行** 新しいノードが登録される、**結果** ページをリロードせずに新しいノードが一覧に自動追加される

**受け入れシナリオ（チャットコンソール）**:

1. **前提** ルーターが起動している、**実行** ダッシュボードヘッダーの「Chat」ボタンを押す、**結果** 全画面モーダルでチャットコンソールがオーバーレイ表示される（新規タブは開かれない）
2. **前提** ローカルモデルとクラウドモデルが登録されている、**実行** プロバイダー切替を「ローカル」「クラウド」「すべて」で切り替える、**結果** モデルドロップダウンが選択した種類のモデルのみを表示する（クラウドは `openai:` 等のプレフィックス付き）
3. **前提** 過去に送信済みのチャット履歴がある、**実行** サイドバーのセッションをクリックする、**結果** 保存済みの履歴と選択モデルが復元される
4. **前提** チャットフォームにメッセージを入力済み、**実行** Enter送信、**結果** `/api/chat` にPOSTされ、レスポンスが履歴に追記される（ストリーミングONの場合は逐次追記される）
5. **前提** 1件以上のメッセージを送信済み、**実行** 「Copy cURL」を押す、**結果** 現在のモデル・直近のユーザーメッセージ・システムプロンプトを含む cURL がクリップボードにコピーされる
6. **前提** セッション履歴が表示されている、**実行** 「新規チャット」を押す、**結果** 空の履歴を持つ新規セッションが作成され、以降の送信内容はそのセッションに保存される

**受け入れシナリオ（ノード管理機能）**:

1. **前提** ノード一覧が表示されている、**実行** あるノードの「設定」ボタンをクリックする、**結果** ノード設定画面が開き、ノード名、メモ、タグを編集できる
2. **前提** ノード設定画面が開いている、**実行** ノード名を変更して「保存」をクリックする、**結果** 変更が即座に反映され、ノード一覧に新しい名前が表示される
3. **前提** 不要なノードが登録されている、**実行** ノード一覧で「削除」ボタンをクリックし、確認ダイアログで「削除」を選択する、**結果** ノードが登録解除され、一覧から削除される
4. **前提** 問題のあるノードが登録されている、**実行** ノード一覧で「強制切断」ボタンをクリックする、**結果** ノードが即座にOffline状態になる

## 機能要件

### FR-017: ダッシュボードUI

Webブラウザでアクセス可能なダッシュボード画面を提供する。

- エンドポイント: `GET /dashboard`
- 技術スタック: HTML + JavaScript + CSS（フレームワークはシンプルさを優先）
- レスポンシブデザイン対応

### FR-018: ノード一覧表示

登録されたすべてのノードを一覧表示する。

- 表示項目:
  - マシン名
  - IPアドレス
  - Ollamaバージョン
  - ステータス（オンライン/オフライン）
  - 最終確認時刻
  - 稼働時間（直近でオンラインになった時刻からの経過時間）
- ソート機能: マシン名、ステータスでソート可能

### FR-019: リアルタイム更新

ダッシュボードの情報を自動的に更新する。

- 更新間隔: 5秒ごと
- 更新方法: WebSocketまたはポーリング
- ページリロード不要

### FR-020: パフォーマンスメトリクス表示

各ノードのパフォーマンス情報を可視化する。

- 表示メトリクス:
  - CPU使用率（グラフ）
  - メモリ使用率（グラフ）
  - 処理中のリクエスト数
  - 総リクエスト処理数
  - 平均レスポンスタイム
  - エラー率

### FR-021: システム統計

システム全体の統計情報を表示する。

- 統計項目:
  - 登録ノード総数
  - オンラインノード数
  - 総リクエスト処理数
  - 平均レスポンスタイム
  - エラー総数

### FR-022: ノード詳細ビュー

特定のノードの詳細情報を表示する。

- 詳細情報:
  - システム情報（OS、CPU、メモリ）
  - Ollama設定
  - 処理履歴
  - エラーログ

### FR-023: ノード設定管理

WebUIでノード個別の設定を表示・変更できる。

- 設定項目:
  - ルーターURL（参照用）
  - 自動起動設定の有効化/無効化（将来的な拡張）
  - ノード名のカスタマイズ
  - メモ/タグ付け
- 設定変更後の反映:
  - 即座にダッシュボードに反映
  - ノード再起動時に適用

### FR-024: ノード制御

ダッシュボードからノードを制御できる。

- 制御機能:
  - ノードの登録解除（削除）
  - ノードの強制切断（Offline化）
  - 将来的な拡張：
    - ノードの起動/停止コマンド送信（OS依存）
    - ノード設定のリモート更新
- 確認ダイアログ:
  - 削除時に確認ダイアログ表示
  - 誤操作防止

### FR-025: 初期セットアップウィザード（将来的な拡張）

新規ノード追加時のガイドUIを提供する。

- ウィザード機能:
  - ルーターURL入力フォーム
  - 接続テスト機能
  - トークン/認証設定（認証機能実装後）
  - セットアップ手順のステップバイステップガイド
- 将来的な拡張:
- ルーター／ノードそれぞれのインストーラーダウンロードリンク
- 自動セットアップスクリプト生成

### FR-026: チャットコンソール（ダッシュボード付属）

- 表示方法: ダッシュボード上に全画面オーバーレイのモーダルとして埋め込み表示し、新規タブを開かない。
- エンドポイント: `GET /chat`（iframeで埋め込み）
- モデル選択: プロバイダー切替（`ローカル` / `クラウド` / `すべて`）でモデルリストをフィルタリング。
- 送信: `/api/chat` に対し、システムプロンプト付与の有無とストリーミングON/OFFを切り替えて送信できる。
- セッション管理: サイドバーでチャットセッションを作成・一覧・復元でき、履歴と選択モデルをローカルストレージに永続化する。
- 補助機能: 「Copy cURL」で現在の入力を cURL 形式にしてコピーできる。ストップボタンでストリーミングを中断できる。再読み込みボタンでコンソールのみをリロードできる。

## 非機能要件

### NFR-010: ユーザビリティ

- 直感的なUI設計
- 5秒以内にシステム全体の状態を把握可能
- モバイルデバイスからもアクセス可能

### NFR-011: パフォーマンス

- 初回ロード時間: 2秒以内
- リアルタイム更新のレイテンシ: 100ms以内

### NFR-012: アクセシビリティ

- WCAG 2.1 Level AAに準拠
- スクリーンリーダー対応

## 実装状態

### 🚧 未実装（将来の拡張）

すべての機能が未実装です。以下の順序で実装を推奨：

1. **Phase 1: 基本UI**
   - 静的HTMLダッシュボード
   - ノード一覧表示
   - 手動リフレッシュ

2. **Phase 2: リアルタイム更新**
   - 自動ポーリング
   - WebSocket統合
   - リアルタイムステータス更新

3. **Phase 3: メトリクス可視化**
   - パフォーマンスグラフ
   - 統計サマリー
   - 履歴データ表示

4. **Phase 4: 高度な機能**
   - ノード詳細ビュー
   - フィルタリング＆検索
   - エクスポート機能

## 技術提案

### フロントエンド
- **オプション1**: Vanilla JS + Chart.js（シンプル、依存少ない）
- **オプション2**: React + Recharts（リッチなUI、保守性高い）
- **オプション3**: Vue.js + ECharts（学習コスト低い、日本語ドキュメント豊富）

### リアルタイム通信
- **オプション1**: WebSocket（双方向通信、低レイテンシ）
- **オプション2**: Server-Sent Events（シンプル、片方向通信）
- **オプション3**: ポーリング（実装簡単、レイテンシ高い）

### 推奨スタック
初期実装は**Vanilla JS + Chart.js + ポーリング**で開始し、必要に応じてWebSocketに移行することを推奨します。
