<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLM Router Dashboard</title>
    <link rel="stylesheet" href="/dashboard/styles.css" />
    <script
      src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"
      integrity="sha384-Sse/HDqcypGpyTDpvZOJNnG0TT3feGQUkF9H+mnRvic+LjR+K1NhTt8f51KIQ3v3"
      crossorigin="anonymous"
      defer
    ></script>
  </head>
  <body>
    <header class="page-header">
      <div class="title-group">
        <h1>LLM Router Dashboard</h1>
        <p class="subtitle">Real-time monitoring of node status and system statistics</p>
      </div>
      <div class="header-controls">
        <button id="chat-open" class="refresh-button" type="button">Chat</button>
        <button id="api-keys-button" class="refresh-button" type="button">
          API Keys
        </button>
        <span id="connection-status" class="status-pill status-pill--connecting">
          Status: Updating...
        </span>
        <span id="last-refreshed" class="last-refreshed">Last Updated: -</span>
        <span id="refresh-metrics" class="last-refreshed">Fetch: - / Render: -</span>
        <button id="refresh-button" class="refresh-button" type="button">
          Refresh
        </button>
      </div>
    </header>

    <main>
    <section class="banner hidden" id="error-banner"></section>

      <!-- Tab navigation removed (single view) -->

      <div class="tab-panel tab-panel--active" id="tab-dashboard">
      <section class="stats-grid">
        <article class="stat-card">
          <h2>Registered Nodes</h2>
          <p class="stat-value" data-stat="total-nodes">-</p>
          <p class="stat-caption">
            Online <span data-stat="online-nodes">-</span> / Offline
            <span data-stat="offline-nodes">-</span>
          </p>
        </article>
        <article class="stat-card">
          <h2>Total Requests</h2>
          <p class="stat-value" data-stat="total-requests">-</p>
          <p class="stat-caption">
            Success <span data-stat="successful-requests">-</span> / Failed
            <span data-stat="failed-requests">-</span>
          </p>
        </article>
        <article class="stat-card">
          <h2>Avg Response</h2>
          <p class="stat-value" data-stat="average-response-time-ms">-</p>
          <p class="stat-caption">
            Metrics Updated: <span data-stat="last-metrics-updated-at">-</span>
          </p>
        </article>
        <article class="stat-card">
          <h2>Avg GPU Usage</h2>
          <p class="stat-value" data-stat="average-gpu-usage">-</p>
          <p class="stat-caption">
            Memory: <span data-stat="average-gpu-memory-usage">-</span>
          </p>
        </article>
        <article class="stat-card">
          <h2>Active Requests</h2>
          <p class="stat-value" data-stat="total-active-requests">-</p>
          <p class="stat-caption">
            Last Registered: <span data-stat="last-registered-at">-</span><br />
            Last Seen: <span data-stat="last-seen-at">-</span>
          </p>
        </article>
      </section>
      </div>

      <!-- Models Management -->
      <div class="tab-panel tab-panel--active" id="tab-models">
        <section class="models-section">
          <header class="section-header">
            <h2>Models</h2>
            <div class="section-tools">
              <button type="button" id="download-tasks-refresh" class="btn">Refresh Tasks</button>
              <label class="filter-label">
                <span>Search HF</span>
                <input type="search" id="hf-search" placeholder="llama" autocomplete="off" />
              </label>
              <button type="button" id="hf-refresh" class="btn">Refresh HF</button>
              <button type="button" id="registered-refresh" class="btn">Refresh Registered</button>
            </div>
          </header>
          <div class="models-grid">
            <article class="models-column">
              <h3>対応可能モデル（HF GGUF）</h3>
              <p class="caption">Register to add into supported list</p>
              <div id="hf-models-list" class="model-cards"></div>
              <p id="hf-models-status" class="caption"></p>
            </article>
            <article class="models-column">
              <h3>対応モデル</h3>
              <p class="caption">Registered models (used by /v1/models)</p>
              <div id="registered-models-list" class="model-cards"></div>
              <div class="tasks-panel">
                <h4>Download Tasks</h4>
                <div id="download-tasks-list" class="tasks-list"></div>
              </div>
            </article>
          </div>
        </section>
      </div>

      <!-- Legacy manual distribution panel (kept) -->

      <div class="tab-panel" id="tab-nodes">
      <section class="nodes-section">
        <header class="section-header">
          <h2>Node List</h2>
          <div class="section-tools">
            <div class="export-group">
              <button type="button" id="export-json" class="btn">Export JSON</button>
              <button type="button" id="export-csv" class="btn">Export CSV</button>
            </div>
            <label class="filter-label">
              <span>Status</span>
              <select id="filter-status">
                <option value="all">All</option>
                <option value="online">Online</option>
                <option value="offline">Offline</option>
              </select>
            </label>
            <label class="filter-label">
              <span>Search</span>
              <input
                type="search"
                id="filter-query"
                placeholder="Machine name / IP address"
                autocomplete="off"
              />
            </label>
          </div>
        </header>

            <div class="table-wrapper">
              <table class="nodes-table">
                <colgroup>
                  <col class="col-select" />
                  <col class="col-name" />
              <col class="col-address" />
              <col class="col-status" />
              <col class="col-uptime" />
              <col class="col-cpu" />
              <col class="col-memory" />
                  <col class="col-active" />
                  <col class="col-total" />
                  <col class="col-average" />
                  <col class="col-last-seen" />
                  <col class="col-actions" />
                </colgroup>
                <thead>
                  <tr>
                <th>
                  <input type="checkbox" id="select-all" aria-label="Select all" />
                </th>
                <th data-sort="machine" class="sortable">
                  <span>Name</span>
                  <span class="sort-indicator" aria-hidden="true">–</span>
                </th>
                <th data-sort="ip" class="sortable">
                  <span>Address</span>
                  <span class="sort-indicator" aria-hidden="true">–</span>
                </th>
                <th data-sort="status" class="sortable">
                  <span>Status</span>
                  <span class="sort-indicator" aria-hidden="true">–</span>
                </th>
                <th data-sort="uptime" class="sortable">
                  <span>Uptime</span>
                  <span class="sort-indicator" aria-hidden="true">–</span>
                </th>
                <th>CPU / GPU</th>
                  <th>Memory / GPU</th>
                  <th>Active</th>
                  <th data-sort="total" class="sortable">
                    <span>Total</span>
                    <span class="sort-indicator" aria-hidden="true">–</span>
                  </th>
                  <th>Avg Response</th>
                  <th>Last Seen</th>
                  <th>Actions</th>
                </tr>
              </thead>
            <tbody id="nodes-body">
              <tr class="empty-row">
                <td colspan="12">Loading data...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" aria-label="Node list pagination">
          <button type="button" id="page-prev" class="btn" aria-label="Previous page">&lt;</button>
          <span class="pagination__info" id="page-info">- / -</span>
          <button type="button" id="page-next" class="btn" aria-label="Next page">&gt;</button>
        </div>
      </section>

      <section class="charts-section">
        <header class="section-header">
          <h2>Request Trend Graph</h2>
          <p class="section-caption">Success/Failed requests in the last 60 minutes</p>
        </header>
        <div class="chart-container">
          <canvas id="requests-chart" aria-label="Requests per minute" role="img"></canvas>
        </div>
      </section>
      </div>

      <div class="tab-panel" id="tab-history">
      <section class="request-history-section">
        <header class="section-header">
          <h2>Request History</h2>
          <div class="section-tools">
            <button type="button" id="export-history-csv" class="btn">Export CSV</button>
            <label class="filter-label">
              <span>Model</span>
              <input
                type="search"
                id="filter-history-model"
                placeholder="Filter by model name"
                autocomplete="off"
              />
            </label>
            <label class="filter-label">
              <span>Per Page</span>
              <select id="history-per-page" class="per-page-select">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
            </label>
          </div>
        </header>

        <div class="table-wrapper">
          <table class="request-history-table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Type</th>
                <th>Model</th>
                <th>Agent</th>
                <th>Client IP</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="request-history-tbody">
              <tr>
                <td colspan="8" class="empty-message">Loading history...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination" id="history-pagination">
          <button type="button" id="history-page-prev" class="btn" aria-label="Previous page">&lt;</button>
          <span class="pagination__info" id="history-page-info">- / -</span>
          <button type="button" id="history-page-next" class="btn" aria-label="Next page">&gt;</button>
        </div>
      </section>
      </div>

      <div class="tab-panel" id="tab-logs">
        <section class="logs-grid">
          <article class="log-card" aria-labelledby="logs-coordinator-title">
            <header class="log-card__header">
              <div>
                <h2 id="logs-coordinator-title">Router Logs</h2>
                <p class="log-card__path" id="logs-coordinator-path"></p>
              </div>
              <div class="log-card__actions">
                <button type="button" id="logs-coordinator-refresh" class="btn btn--secondary">
                  Reload
                </button>
              </div>
            </header>
            <p class="log-card__status" id="logs-coordinator-status">-</p>
            <div
              class="log-viewer"
              id="logs-coordinator-list"
              role="log"
              aria-live="polite"
            ></div>
          </article>

          <article class="log-card" aria-labelledby="logs-node-title">
            <header class="log-card__header">
              <div>
                <h2 id="logs-node-title">Node Logs</h2>
                <p class="log-card__path" id="logs-node-path"></p>
              </div>
              <div class="log-card__actions">
                <label class="log-node-select">
                  <span>Node</span>
                  <select id="logs-node-select">
                    <option value="">Select a node</option>
                  </select>
                </label>
                <button type="button" id="logs-node-refresh" class="btn btn--secondary">
                  Reload
                </button>
              </div>
            </header>
            <p class="log-card__status" id="logs-node-status">-</p>
            <div class="log-viewer" id="logs-node-list" role="log" aria-live="polite"></div>
          </article>
        </section>
      </div>
    </main>

    <footer class="page-footer">
      <small>&copy; 2025 LLM Router</small>
    </footer>

    <div id="node-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="node-modal-title">
      <div class="modal__dialog">
        <header class="modal__header">
          <h2 id="node-modal-title">Node Details</h2>
          <button type="button" id="node-modal-close" class="modal__close" aria-label="Close">×</button>
        </header>
        <section class="modal__content">
          <form id="node-settings-form" class="detail-list">
            <div>
              <dt>Display Name</dt>
              <dd><input id="detail-custom-name" name="custom_name" type="text" placeholder="Custom name" /></dd>
            </div>
            <div>
              <dt>Tags</dt>
              <dd><input id="detail-tags" name="tags" type="text" placeholder="Comma separated" /></dd>
            </div>
            <div>
              <dt>Notes</dt>
              <dd><textarea id="detail-notes" name="notes" rows="3" placeholder="Optional notes"></textarea></dd>
            </div>

            <div>
              <dt>Machine Name</dt>
              <dd id="detail-machine-name">-</dd>
            </div>
            <div>
              <dt>IP Address</dt>
              <dd id="detail-ip-address">-</dd>
            </div>
            <div>
              <dt>Backend Version</dt>
              <dd id="detail-runtime-version">-</dd>
            </div>
            <div>
              <dt>Models</dt>
              <dd id="detail-loaded-models">-</dd>
            </div>
            <div>
              <dt>Uptime</dt>
              <dd id="detail-uptime">-</dd>
            </div>
            <div>
              <dt>Status</dt>
              <dd id="detail-status">-</dd>
            </div>
            <div>
              <dt>Last Seen</dt>
              <dd id="detail-last-seen">-</dd>
            </div>
            <div>
              <dt>Total Requests</dt>
              <dd id="detail-total-requests">-</dd>
            </div>
            <div>
              <dt>Avg Response Time</dt>
              <dd id="detail-average-response">-</dd>
            </div>
            <div>
              <dt>GPU Usage</dt>
              <dd id="detail-gpu-usage">-</dd>
            </div>
            <div>
              <dt>GPU Memory Usage</dt>
              <dd id="detail-gpu-memory">-</dd>
            </div>
            <div>
              <dt>GPU Capability Score</dt>
              <dd id="detail-gpu-capability-score">-</dd>
            </div>
            <div>
              <dt>GPU Model</dt>
              <dd id="detail-gpu-model">-</dd>
            </div>
            <div>
              <dt>GPU Compute</dt>
              <dd id="detail-gpu-compute">-</dd>
            </div>
          </form>
          <section class="modal__metrics" aria-label="Node metrics">
            <h3>Metrics</h3>
            <p id="node-metrics-status" class="metrics-status">Loading metrics...</p>
            <div class="metrics-chart">
              <canvas
                id="node-metrics-chart"
                aria-label="CPU and memory trends"
                role="img"
              ></canvas>
            </div>
          </section>
          <section class="modal__logs" id="node-log-section" aria-label="Node logs">
            <div class="modal__logs-header">
              <h3>Recent Logs</h3>
              <div class="modal__logs-actions">
                <span id="node-log-path" class="modal__logs-path"></span>
                <button type="button" id="node-log-refresh" class="btn btn--secondary">
                  Reload
                </button>
              </div>
            </div>
            <p id="node-log-status" class="modal__logs-status">Loading logs...</p>
            <div
              class="log-viewer log-viewer--compact"
              id="node-log-viewer"
              role="log"
              aria-live="polite"
            ></div>
          </section>
        </section>
        <footer class="modal__footer">
          <button type="button" id="node-modal-disconnect" class="btn">Disconnect</button>
          <button type="button" id="node-modal-delete" class="btn btn--danger">Delete</button>
          <button type="button" id="node-modal-save" class="btn btn--primary">Save</button>
          <button type="button" id="node-modal-ok" class="btn">Close</button>
        </footer>
      </div>
    </div>

    <div id="request-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="request-modal-title">
      <div class="modal__dialog">
        <header class="modal__header">
          <h2 id="request-modal-title">Request Details</h2>
          <button type="button" id="request-modal-close" class="modal__close" aria-label="Close">×</button>
        </header>
        <section class="modal__content">
          <form id="request-detail-form" class="detail-list">
            <div>
              <dt>ID</dt>
              <dd id="request-detail-id">-</dd>
            </div>
            <div>
              <dt>Timestamp</dt>
              <dd id="request-detail-timestamp">-</dd>
            </div>
            <div>
              <dt>Type</dt>
              <dd id="request-detail-type">-</dd>
            </div>
            <div>
              <dt>Model</dt>
              <dd id="request-detail-model">-</dd>
            </div>
            <div>
              <dt>Node</dt>
              <dd id="request-detail-node">-</dd>
            </div>
            <div>
              <dt>Client IP</dt>
              <dd id="request-detail-client-ip">-</dd>
            </div>
            <div>
              <dt>Duration</dt>
              <dd id="request-detail-duration">-</dd>
            </div>
            <div>
              <dt>Status</dt>
              <dd id="request-detail-status">-</dd>
            </div>
            <div>
              <dt>Request Body</dt>
              <dd><pre id="request-detail-request-body" class="json-body">-</pre></dd>
            </div>
            <div>
              <dt>Response Body</dt>
              <dd><pre id="request-detail-response-body" class="json-body">-</pre></dd>
            </div>
          </form>
        </section>
        <footer class="modal__footer">
          <button type="button" id="request-modal-ok" class="btn">Close</button>
        </footer>
      </div>
    </div>

    <div id="api-keys-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="api-keys-modal-title">
      <div class="modal__dialog modal__dialog--wide">
        <header class="modal__header">
          <h2 id="api-keys-modal-title">API Key Management</h2>
          <button type="button" id="api-keys-modal-close" class="modal__close" aria-label="Close">×</button>
        </header>
        <section class="modal__content">
          <div class="api-key-form">
            <input type="text" id="api-key-name" placeholder="Key name (e.g., Production)" class="api-key-input" />
            <select id="api-key-expiry" class="api-key-select">
              <option value="">No expiry</option>
              <option value="3">3 days</option>
              <option value="7">7 days</option>
              <option value="21">21 days</option>
              <option value="70">70 days</option>
            </select>
            <button type="button" id="create-api-key" class="btn btn--primary">Create</button>
          </div>

          <div id="new-key-display" class="new-key-display hidden">
            <p class="new-key-warning">This key is only shown once. Please copy it now.</p>
            <div class="new-key-box">
              <code id="new-key-value"></code>
              <button type="button" id="copy-api-key" class="btn btn--secondary">Copy</button>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="api-keys-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Created</th>
                  <th>Expires</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="api-keys-tbody">
                <tr><td colspan="4" class="empty-message">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </section>
        <footer class="modal__footer">
          <button type="button" id="api-keys-modal-ok" class="btn">Close</button>
        </footer>
      </div>
    </div>

    <!-- Fullscreen chat console (embedded /chat) -->
    <div id="chat-modal" class="chat-modal hidden" role="dialog" aria-modal="true" aria-label="Chat console">
      <div class="chat-modal__backdrop" data-chat-close></div>
      <div class="chat-modal__content">
        <header class="chat-modal__header">
          <div>
            <p class="eyebrow">Chat Console</p>
            <p class="chat-modal__title">/api/chat のテスト用コンソール</p>
          </div>
          <div class="chat-modal__actions">
            <button type="button" id="chat-reload" class="ghost">再読み込み</button>
            <button type="button" id="chat-close" class="modal__close" aria-label="Close">×</button>
          </div>
        </header>
        <iframe
          id="chat-iframe"
          src="/chat"
          title="Chat console"
          class="chat-modal__iframe"
          loading="lazy"
          referrerpolicy="same-origin"
        ></iframe>
      </div>
    </div>

    <script src="/dashboard/auth.js"></script>
    <script src="/dashboard/api-keys.js" defer></script>
    <script src="/dashboard/users.js" defer></script>
    <script src="/dashboard/app.js" defer></script>
  </body>
</html>
